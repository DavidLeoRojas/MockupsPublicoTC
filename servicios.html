<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servicios - Gemini Ambiental Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #2d3748;
        }
        :root {
            --cliente-primary: #4299e1;
            --cliente-secondary: #63b3ed;
            --cliente-light: #ebf8ff;
            --cliente-dark: #2c5282;
            --empleado-primary: #48bb78;
            --empleado-secondary: #68d391;
            --empleado-light: #f0fff4;
            --empleado-dark: #276749;
            --proveedor-primary: #ed8936;
            --proveedor-secondary: #f6ad55;
            --proveedor-light: #fffaf0;
            --proveedor-dark: #c05621;
            --admin-primary: #805ad5;
            --admin-secondary: #9f7aea;
            --admin-light: #faf5ff;
            --admin-dark: #553c9a;
            --servicio-primary: #4a8b64;
            --servicio-secondary: #2c5f41;
        }
 .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: 
                        url('backgroundMenu.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-icon {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text h2 {
            font-size: 1.2em;
            margin-bottom: 0.2rem;
        }
        .logo-text p {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .nav-menu {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0.5rem 1rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .logout-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        .top-nav {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .nav-tabs {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #718096;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            transition: left 0.3s ease;
            z-index: -1;
        }
        .nav-tab:hover::before {
            left: 0;
        }
        .nav-tab.all {
            border-color: #e2e8f0;
        }
        .nav-tab.all:hover,
        .nav-tab.all.active {
            background: linear-gradient(135deg, var(--servicio-primary), var(--servicio-secondary));
            color: white;
            transform: translateY(-2px);
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-title h1 {
            color: var(--servicio-secondary);
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }
        .header-title p {
            color: #718096;
            font-size: 1.1em;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--servicio-primary), var(--servicio-secondary));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--servicio-primary), var(--servicio-secondary));
        }
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            position: relative;
            background: linear-gradient(135deg, var(--servicio-primary), var(--servicio-secondary));
        }
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: #718096;
            font-size: 1em;
            font-weight: 600;
        }
        .stat-trend {
            font-size: 0.8em;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .trend-up {
            color: #48bb78;
        }
        .trend-down {
            color: #f56565;
        }
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .service-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        .card-header {
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            background: linear-gradient(135deg, var(--servicio-primary), var(--servicio-secondary));
        }
        .service-icon {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            margin: 0 auto 1rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .service-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .service-category {
            opacity: 0.9;
            font-size: 1em;
            font-weight: 500;
        }
        .card-body {
            padding: 2rem;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .info-label {
            color: #718096;
            font-weight: 600;
        }
        .info-value {
            color: #2d3748;
            font-weight: 600;
        }
        .card-actions {
            padding: 1rem 2rem 2rem;
            display: flex;
            gap: 1rem;
        }
        .btn-sm {
            padding: 0.6rem 1.2rem;
            font-size: 0.9em;
            flex: 1;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--servicio-primary);
            color: var(--servicio-primary);
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            background: var(--servicio-primary);
            color: white;
        }
        .btn-filled {
            border: none;
            color: white;
            background: linear-gradient(135deg, var(--servicio-primary), var(--servicio-secondary));
        }
        .btn-filled:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--servicio-secondary);
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #718096;
            transition: color 0.3s ease;
        }
        .close-btn:hover {
            color: #f56565;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--servicio-primary);
            box-shadow: 0 0 0 3px rgba(74, 139, 100, 0.1);
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .filter-section {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        @media (max-width: 1024px) {
            .services-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .header-title h1 {
                font-size: 2em;
            }
            .services-grid {
                grid-template-columns: 1fr;
            }
            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            .form-grid-2 {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">
                <img src="LogoMenu.png" alt="Gemini Ambiental" style="height: 60px; object-fit: contain;">
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item"><a href="dashboard.html" class="nav-link"><span
                        class="nav-icon">📊</span><span>Dashboard</span></a></div>
            <div class="nav-item"><a href="inventario.html" class="nav-link"><span
                        class="nav-icon">📦</span><span>Inventario</span></a></div>
            <div class="nav-item"><a href="agenda.html" class="nav-link"><span
                        class="nav-icon">📅</span><span>Agenda</span></a></div>
            <div class="nav-item"><a href="personal.html" class="nav-link"><span
                        class="nav-icon">👥</span><span>Personas</span></a></div>
            <div class="nav-item"><a href="cotizaciones.html" class="nav-link"><span
                        class="nav-icon">💰</span><span>Cotizaciones</span></a></div>
            <div class="nav-item"><a href="facturas.html" class="nav-link"><span
                        class="nav-icon">📄</span><span>Facturas</span></a></div>
            <div class="nav-item"><a href="servicios.html" class="nav-link active"><span
                        class="nav-icon">🔧</span><span>Servicios</span></a></div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">🚪</span>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-tabs">
                <a href="#" class="nav-tab all active" onclick="showView('all', this)">
                    🔧 Todos los Servicios
                </a>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary">📊 Reportes</button>
                <button class="btn btn-secondary">🔍 Búsqueda Avanzada</button>
            </div>
        </div>
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Gestión de Servicios</h1>
                <p>Administración de tipos de servicios ofrecidos por la empresa</p>
            </div>
            <div style="display:flex; gap:1rem; flex-wrap: wrap;">
                <button class="btn btn-secondary">📤 Exportar</button>
                <button class="btn btn-secondary">📥 Importar</button>
                <button class="btn btn-primary" onclick="openAddServiceModal()">➕ Agregar Servicio</button>
            </div>
        </div>
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">🔧</div>
                </div>
                <div class="stat-number" id="totalServicesCount">0</div>
                <div class="stat-label">Total Servicios</div>
                <div class="stat-trend trend-up">↗️ +0 este mes</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">💰</div>
                </div>
                <div class="stat-number" id="totalCost">0</div>
                <div class="stat-label">Costo Total Estimado</div>
                <div class="stat-trend">➡️ Sin cambios</div>
            </div>
        </div>
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-grid">
                <div class="form-group">
                    <label>🔍 Buscar</label>
                    <input type="text" class="form-control" placeholder="Nombre, categoría..." oninput="filterServices()" id="searchInput">
                </div>
                <div class="form-group">
                    <label>🏷️ Categoría</label>
                    <select class="form-control" onchange="filterServices()" id="categoryFilter">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="clearFilters()">🗑️ Limpiar Filtros</button>
                </div>
            </div>
        </div>
        <!-- Services Grid -->
        <div class="services-grid" id="servicesGrid">
        </div>
    </div>

    <!-- Modal de Agregar/Editar Servicio -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">➕ Agregar Nuevo Servicio</h2>
                <button class="close-btn" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <form id="addServiceForm">
                <div class="form-group">
                    <label>🏷️ Categoría</label>
                    <select class="form-control" required id="serviceCategory" name="serviceCategory">
                        <option value="">Selecciona una categoría</option>
                        <!-- Las opciones se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>🔧 Nombre del Servicio</label>
                    <input type="text" class="form-control" placeholder="Ej: Control de Plagas" required id="serviceName" name="serviceName">
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>💰 Costo (COP)</label>
                        <input type="number" class="form-control" placeholder="Ej: 280000" required id="serviceCost" name="serviceCost">
                    </div>
                    <div class="form-group">
                        <label>⏱️ Duración</label>
                        <input type="text" class="form-control" placeholder="Ej: 2 horas, 1 día" required id="serviceDuration" name="serviceDuration">
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>🔄 Frecuencia</label>
                        <input type="text" class="form-control" placeholder="Ej: Mensual, Trimestral" required id="serviceFrequency" name="serviceFrequency">
                    </div>
                    <div class="form-group">
                        <label>🏷️ Icono (opcional)</label>
                        <input type="text" class="form-control" placeholder="Ej: 🐛, 🚿, 📋" id="serviceIcon" name="serviceIcon">
                    </div>
                </div>
                <div class="form-group">
                    <label>📝 Descripción Extendida</label>
                    <textarea class="form-control" rows="3" placeholder="Descripción detallada del servicio..." required id="serviceDescription" name="serviceDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>✅ Estado</label>
                    <select class="form-control" required id="serviceStatus" name="serviceStatus">
                        <option value="">Selecciona un estado</option>
                        <option value="ACTIVO">ACTIVO</option>
                        <option value="INACTIVO">INACTIVO</option>

                    </select>
                </div>
                <div class="form-grid-2" style="margin-top:2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">❌ Cancelar</button>
                    <button type="submit" class="btn btn-primary">✅ Agregar Servicio</button>
                </div>
            </form>
        </div>
    </div>

<script>
// === CONFIGURACIÓN ===
const API_BASE_URL = 'https://backendgeminiambienta-v4-0.onrender.com/api';

// === VARIABLES GLOBALES ===
let todasLasCategorias = [];
let todosLosServicios = [];
let serviciosAgendados = []; // Nueva variable para almacenar servicios agendados
let currentView = 'all';
let currentEditingId = null;
let isSubmitting = false;

// === FUNCIONES PRINCIPALES ===

// Cargar todos los datos iniciales
async function loadServicesData() {
    console.log("Iniciando carga de servicios desde el backend...");
    
    // ✅ 1. Obtener el token JWT del almacenamiento local
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
        window.location.href = 'index.html';
        return;
    }

    // ✅ 2. Configurar los encabezados con el token de autenticación
    const headers = {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
    };

    try {
        // Cargar tipos de servicio
        const serviciosRes = await fetch(`${API_BASE_URL}/tipos-servicio`, { headers });
        if (!serviciosRes.ok) throw new Error(`HTTP error! status: ${serviciosRes.status}`);
        const serviciosData = await serviciosRes.json();
        todosLosServicios = Array.isArray(serviciosData) ? serviciosData : [];
        // Cargar categorías de servicio
        const categoriasRes = await fetch(`${API_BASE_URL}/categorias-servicio`, { headers });
        if (!categoriasRes.ok) throw new Error('Error al cargar categorías de servicio');
        todasLasCategorias = await categoriasRes.json();
        // Cargar servicios agendados
        const agendadosRes = await fetch(`${API_BASE_URL}/servicios`, { headers });
        if (!agendadosRes.ok) throw new Error('Error al cargar servicios agendados');
        serviciosAgendados = await agendadosRes.json();
        console.log(`Datos cargados: ${todosLosServicios.length} tipos de servicio, ${todasLasCategorias.length} categorías, ${serviciosAgendados.length} servicios agendados.`);
        actualizarEstadisticas(todosLosServicios);
        poblarFiltrosCategoria(todosLosServicios);
        poblarSelectCategorias(); // <-- Nueva función para llenar el select
        renderizarServicios(todosLosServicios);
    } catch (error) {
        console.error("Error crítico al cargar servicios:", error);
        alert("Error al cargar los servicios. Revise que el backend esté corriendo.");
        document.getElementById('servicesGrid').innerHTML = '<p style="text-align:center; color:red; grid-column: 1/-1;">Error al cargar servicios.</p>';
    }
}

function poblarSelectCategorias() {
    const selectCategoria = document.getElementById('serviceCategory');
    if (!selectCategoria) return;

    // Limpiar el select
    selectCategoria.innerHTML = '<option value="">Selecciona una categoría</option>';

    // Llenar con las categorías
    todasLasCategorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.idCategoriaServicio; // ¡Enviamos el ID!
        option.textContent = cat.nombre; // Mostramos el nombre
        selectCategoria.appendChild(option);
    });
}

// Verificar si un tipo de servicio está siendo usado por servicios activos (no Completados/Cancelados)
function isServicioEnUso(idTipoServicio) {
    return serviciosAgendados.some(servicio => {
        // Verificar si el servicio usa este tipo de servicio
        const usaEsteTipo = (
            servicio.idTipoServicio === idTipoServicio ||
            (servicio.tipoServicio && servicio.tipoServicio.idTipoServicio === idTipoServicio) ||
            servicio.id_tipo_servicio === idTipoServicio
        );

        // Verificar si el servicio NO está en estado "Completado" o "Cancelado"
        const estadoValido = !['Completado', 'Cancelado'].includes(servicio.estado);

        return usaEsteTipo && estadoValido;
    });
}

// Obtener servicios agendados que usan un tipo de servicio
function getServiciosVinculados(idTipoServicio) {
    return serviciosAgendados.filter(servicio => {
        if (servicio.idTipoServicio === idTipoServicio) return true;
        if (servicio.tipoServicio && servicio.tipoServicio.idTipoServicio === idTipoServicio) return true;
        return false;
    });
}

// Renderizar las tarjetas de servicios
function renderizarServicios(serviciosParaMostrar) {
    const grid = document.getElementById('servicesGrid');
    if (!grid) return;
    grid.innerHTML = '';
    if (serviciosParaMostrar.length === 0) {
        grid.innerHTML = '<p style="text-align:center; color:#718096; grid-column: 1/-1;">No se encontraron servicios.</p>';
        return;
    }
    serviciosParaMostrar.forEach(servicio => {
        const card = crearTarjetaServicio(servicio);
        grid.appendChild(card);
    });
}

// Crear tarjeta de servicio
function crearTarjetaServicio(servicio) {
    const nombre = servicio.nombreServicio || 'Nombre no disponible';
    // ✅ Usar 'descripcion' en lugar de 'descripcionExtendida'
    const descripcion = servicio.descripcion || 'Descripción no disponible';
    const costo = servicio.costo ? servicio.costo.toLocaleString('es-CO') : 'N/A';
    const duracion = servicio.duracion || 'N/A';
    const frecuencia = servicio.frecuencia || 'N/A';

    // ✅ Para la categoría, necesitas hacer una búsqueda en todasLasCategorias
    let categoria = 'Categoría no disponible';
    if (servicio.idCategoriaServicio && Array.isArray(todasLasCategorias)) {
        const cat = todasLasCategorias.find(c => c.idCategoriaServicio === servicio.idCategoriaServicio);
        if (cat) {
            categoria = cat.nombre;
        }
    }

    const enUso = isServicioEnUso(servicio.idTipoServicio);
    
    // ✅ Corrección: Declarar la variable `icono` antes de usarla
    let icono = '🔧'; // Valor por defecto
    if (servicio.icono) {
        icono = servicio.icono;
    } else if (categoria.toLowerCase().includes('plaga')) {
        icono = '🐛';
    } else if (categoria.toLowerCase().includes('tanque')) {
        icono = '🚿';
    } else if (categoria.toLowerCase().includes('certificado')) {
        icono = '📋';
    }
    // Si ninguna condición se cumple, `icono` seguirá siendo '🔧'

    const card = document.createElement('div');
    card.className = 'service-card';
    card.dataset.category = categoria.toLowerCase().replace(/\s+/g, '-');

    card.innerHTML = `
        <div class="card-header">
            <div class="service-icon">${icono}</div>
            <div class="service-name">${nombre}</div>
            <div class="service-category">${categoria}</div>
            ${enUso ? '<div style="background: rgba(255,193,7,0.9); color: #000; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.8em; margin-top: 0.5rem; font-weight: 600;">🔗 En uso</div>' : ''}
        </div>
        <div class="card-body">
            <div class="info-item">
                <span class="info-label">💰 Costo:</span>
                <span class="info-value">$${costo}</span>
            </div>
            <div class="info-item">
                <span class="info-label">⏱️ Duración:</span>
                <span class="info-value">${duracion}</span>
            </div>
            <div class="info-item">
                <span class="info-label">🔄 Frecuencia:</span>
                <span class="info-value">${frecuencia}</span>
            </div>
            <div class="info-item">
                <span class="info-label">📝 Descripción:</span>
                <span class="info-value">${descripcion.substring(0, 50)}${descripcion.length > 50 ? '...' : ''}</span>
            </div>
            <div class="info-item">
                <span class="info-label">✅ Estado:</span>
                <span class="info-value">${servicio.estado || 'N/A'}</span>
            </div>
        </div>
        <div class="card-actions">
            <button class="btn btn-outline btn-sm" onclick="verDetalles('${servicio.idTipoServicio}')">👁️ Ver Detalles</button>
            <button class="btn btn-outline btn-sm" onclick="actualizarServicio('${servicio.idTipoServicio}')">✏️ Actualizar</button>
            <button class="btn btn-outline btn-sm" 
                onclick="eliminarServicio('${servicio.idTipoServicio}')"
                ${enUso ? 'disabled title="No se puede eliminar: servicio en uso"' : ''}
                style="${enUso ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                🗑️ Eliminar
            </button>
        </div>
    `;
    return card;
}

// Actualizar estadísticas
function actualizarEstadisticas(servicios) {
    const total = servicios.length;
    const costoTotal = servicios.reduce((acc, s) => acc + (s.costo || 0), 0);

    document.getElementById('totalServicesCount').textContent = total;
    document.getElementById('totalCost').textContent = costoTotal.toLocaleString('es-CO');
}

// Poblar filtros de categoría
function poblarFiltrosCategoria(servicios) {
    const categoriasSet = new Set();
    servicios.forEach(s => {
        // ✅ Usar 'idCategoriaServicio' para buscar el nombre
        if (s.idCategoriaServicio && Array.isArray(todasLasCategorias)) {
            const cat = todasLasCategorias.find(c => c.idCategoriaServicio === s.idCategoriaServicio);
            if (cat) {
                categoriasSet.add(cat.nombre);
            }
        }
    });
    const categoriasUnicas = Array.from(categoriasSet).filter(c => c && c.trim() !== '');
    const selectCategoria = document.getElementById('categoryFilter');
    if (!selectCategoria) return;
    const valorActual = selectCategoria.value;
    selectCategoria.innerHTML = '<option value="">Todas las categorías</option>';
    categoriasUnicas.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.toLowerCase().replace(/\s+/g, '-');
        option.textContent = cat;
        selectCategoria.appendChild(option);
    });
    if (categoriasUnicas.map(c => c.toLowerCase().replace(/\s+/g, '-')).includes(valorActual)) {
        selectCategoria.value = valorActual;
    }
}

// === FUNCIONES DE INTERACCIÓN ===

function showView(view, element) {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    element.classList.add('active');
    currentView = view;
    aplicarFiltros();
}

function aplicarFiltros() {
    let serviciosFiltrados = [...todosLosServicios];

    const terminoBusqueda = document.getElementById('searchInput').value.toLowerCase();
    if (terminoBusqueda) {
        serviciosFiltrados = serviciosFiltrados.filter(s =>
            (s.nombreServicio && s.nombreServicio.toLowerCase().includes(terminoBusqueda)) ||
            // ✅ Buscar por nombre de categoría
            (s.idCategoriaServicio && Array.isArray(todasLasCategorias) &&
                todasLasCategorias.find(c => c.idCategoriaServicio === s.idCategoriaServicio)?.nombre.toLowerCase().includes(terminoBusqueda))
        );
    }

    const filtroCategoria = document.getElementById('categoryFilter').value;
    if (filtroCategoria) {
        serviciosFiltrados = serviciosFiltrados.filter(s => {
            if (s.idCategoriaServicio && Array.isArray(todasLasCategorias)) {
                const cat = todasLasCategorias.find(c => c.idCategoriaServicio === s.idCategoriaServicio);
                return cat && cat.nombre.toLowerCase().replace(/\s+/g, '-') === filtroCategoria;
            }
            return false;
        });
    }

    renderizarServicios(serviciosFiltrados);
}

function filterServices() {
    aplicarFiltros();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    currentView = 'all';
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector('.nav-tab.all').classList.add('active');
    renderizarServicios(todosLosServicios);
}

function openAddServiceModal() {
    document.getElementById('addServiceModal').classList.add('show');
    const form = document.querySelector('#addServiceModal form');
    if (form) {
        form.reset();
        document.querySelector('#addServiceModal .modal-title').textContent = '➕ Agregar Nuevo Servicio';
        document.querySelector('#addServiceModal .btn-primary').textContent = '✅ Agregar Servicio';
        // Limpiar también el select de categoría
        document.getElementById('serviceCategory').value = '';
    }
    currentEditingId = null;
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.remove('show');
}

// Manejar agregar/editar servicio
async function handleAddServiceForm(event) {
    if (isSubmitting) {
        console.log("DEBUG: Ya se está procesando. Ignorando.");
        return;
    }
    event.preventDefault();
    isSubmitting = true;

    // ✅ 1. Obtener el token JWT
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
        window.location.href = 'index.html';
        isSubmitting = false;
        return;
    }

    const submitButton = document.querySelector('#addServiceModal .btn-primary');
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = '⏳ Procesando...';
    }

    try {
        const form = event.target;
        const formData = new FormData(form);
        const datosServicio = Object.fromEntries(formData.entries());

        if (!datosServicio.serviceName || !datosServicio.serviceCategory || !datosServicio.serviceCost || !datosServicio.serviceDuration || !datosServicio.serviceFrequency || !datosServicio.serviceDescription) {
            alert("Por favor complete todos los campos obligatorios.");
            return;
        }

        const costo = parseFloat(datosServicio.serviceCost);
        if (!validarCosto(costo)) {
            return;
        }

        const datosParaEnviar = {
            nombreServicio: datosServicio.serviceName.trim(),
            descripcion: datosServicio.serviceDescription.trim(),
            costo: costo,
            duracion: datosServicio.serviceDuration.trim(),
            frecuencia: datosServicio.serviceFrequency.trim(),
            estado: datosServicio.serviceStatus.trim(),
            idCategoriaServicio: datosServicio.serviceCategory.trim()
        };

        if (datosServicio.serviceIcon && datosServicio.serviceIcon.trim() !== '') {
            datosParaEnviar.icono = datosServicio.serviceIcon.trim();
        }

        console.log("Datos del servicio a enviar:", datosParaEnviar);

        // ✅ 2. Configurar los headers con el token
        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };

        let response;
        let message;
        if (currentEditingId) {
            response = await fetch(`${API_BASE_URL}/tipos-servicio/${currentEditingId}`, {
                method: 'PUT',
                headers: headers, // ← ¡ESTO ES LO QUE FALTABA!
                body: JSON.stringify(datosParaEnviar)
            });
            message = "✅ Servicio actualizado exitosamente!";
        } else {
            response = await fetch(`${API_BASE_URL}/tipos-servicio`, {
                method: 'POST',
                headers: headers, // ← ¡Y ESTO TAMBIÉN!
                body: JSON.stringify(datosParaEnviar)
            });
            message = "✅ Servicio agregado exitosamente!";
        }

        const responseText = await response.text();
        if (!response.ok) {
            let errorMessage = `Error HTTP ${response.status}`;
            try {
                const errorData = JSON.parse(responseText);
                errorMessage = errorData.error || errorData.message || responseText;
            } catch (e) {
                errorMessage = responseText || errorMessage;
            }
            throw new Error(errorMessage);
        }

        console.log("Respuesta del servidor:", responseText);
        alert(message);
        closeModal('addServiceModal');
        form.reset();
        await loadServicesData();
    } catch (error) {
        console.error("Error al procesar el servicio:", error);
        alert(`❌ Error: ${error.message}`);
    } finally {
        isSubmitting = false;
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = currentEditingId ? '💾 Guardar Cambios' : '✅ Agregar Servicio';
        }
    }
}


// Validar el costo
function validarCosto(costo) {
    const maxCosto = 999999999999.99;
    if (costo > maxCosto) {
        alert(`El costo no puede ser mayor a $${maxCosto.toLocaleString('es-CO')}`);
        return false;
    }
    if (costo < 0) {
        alert("El costo no puede ser negativo.");
        return false;
    }
    return true;
}

// Actualizar servicio
function actualizarServicio(id) {
    const servicio = todosLosServicios.find(s => s.idTipoServicio === id);
    if (!servicio) {
        alert("Servicio no encontrado.");
        return;
    }
    console.log("Editando:", servicio);
    openAddServiceModal();
    document.querySelector('#addServiceModal .modal-title').textContent = '✏️ Editar Servicio';
    document.getElementById('serviceName').value = servicio.nombreServicio || '';
    // ✅ Cargar la categoría por ID
    document.getElementById('serviceCategory').value = servicio.idCategoriaServicio || '';
    document.getElementById('serviceCost').value = servicio.costo || '';
    document.getElementById('serviceDuration').value = servicio.duracion || '';
    document.getElementById('serviceFrequency').value = servicio.frecuencia || '';
    // ✅ Cargar la descripción
    document.getElementById('serviceDescription').value = servicio.descripcion || '';
    document.getElementById('serviceIcon').value = servicio.icono || '';
    currentEditingId = id;
    const submitButton = document.querySelector('#addServiceModal .btn-primary');
    if (submitButton) {
        submitButton.textContent = '💾 Guardar Cambios';
    }
}

// Eliminar servicio con protección mejorada
async function eliminarServicio(id) {
    const servicio = todosLosServicios.find(s => s.idTipoServicio === id);
    if (!servicio) {
        alert("❌ Servicio no encontrado.");
        return;
    }

    try {
        // Recargar servicios agendados para asegurar datos actualizados
        const agendadosRes = await fetch(`${API_BASE_URL}/servicios`);
        if (!agendadosRes.ok) throw new Error('Error al verificar servicios agendados');
        serviciosAgendados = await agendadosRes.json();

        console.log(`📋 Verificando si tipo de servicio ${id} está en uso activamente...`);
        console.log(`Total servicios agendados: ${serviciosAgendados.length}`);

        // Filtrar servicios agendados que usan este tipo de servicio
        const vinculados = serviciosAgendados.filter(servAgendado => {
            if (servAgendado.idTipoServicio === id) {
                console.log(`✅ Encontrado por idTipoServicio: ${servAgendado.idServicio}, Estado: ${servAgendado.estado}`);
                return true;
            }
            if (servAgendado.tipoServicio && servAgendado.tipoServicio.idTipoServicio === id) {
                console.log(`✅ Encontrado por tipoServicio.idTipoServicio: ${servAgendado.idServicio}, Estado: ${servAgendado.estado}`);
                return true;
            }
            if (servAgendado.id_tipo_servicio === id) {
                console.log(`✅ Encontrado por id_tipo_servicio: ${servAgendado.idServicio}, Estado: ${servAgendado.estado}`);
                return true;
            }
            return false;
        });

        // Verificar si hay servicios vinculados en estado distinto a Completado o Cancelado
        const vinculadosActivos = vinculados.filter(s => !['Completado', 'Cancelado'].includes(s.estado));

        console.log(`🔍 Servicios vinculados activos (no Completado/Cancelado): ${vinculadosActivos.length}`);
        console.log(`🔍 Servicios vinculados totales: ${vinculados.length}`);

        if (vinculadosActivos.length > 0) {
            // Hay servicios activos, no se puede eliminar
            const detalles = vinculadosActivos.map(s => {
                const fecha = s.fecha || 'sin fecha';
                const hora = s.hora || 'sin hora';
                const cliente = s.cliente?.nombre || s.dniCliente || 'sin cliente';
                const estado = s.estado || 'sin estado';
                return ` • ID: ${s.idServicio} | ${fecha} ${hora} | ${cliente} | Estado: ${estado}`;
            }).join('\n');

            alert(`❌ NO SE PUEDE ELIMINAR "${servicio.nombreServicio}"
            
⚠️ Motivo: Existen ${vinculadosActivos.length} servicio(s) programado(s) que utilizan este tipo de servicio y no están Completados o Cancelados.
📋 Servicios vinculados activos:
${detalles}
💡 Solución: Debe cambiar el estado de estos servicios a "Completado" o "Cancelado" en la Agenda primero.`);
            return;
        } else if (vinculados.length > 0) {
            // Todos los vinculados están Completados o Cancelados, se puede eliminar
            const confirmacion = confirm(`⚠️ Este tipo de servicio tiene ${vinculados.length} servicio(s) asociado(s), pero todos están en estado "Completado" o "Cancelado". ¿Desea eliminarlo de todos modos?`);
            if (!confirmacion) return;
        }
        // Si no hay ninguno vinculado, también se puede eliminar

        // Si llegó hasta aquí, puede eliminar
        console.log(`✅ Tipo de servicio ${id} no tiene servicios activos vinculados. Procediendo a eliminar...`);
        if (confirm(`⚠️ ¿Está seguro de eliminar "${servicio.nombreServicio}"? Esta acción no se puede deshacer.`)) {
            const res = await fetch(`${API_BASE_URL}/tipos-servicio/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(errorText || 'Error al eliminar');
            }
            alert("✅ Tipo de servicio eliminado exitosamente.");
            await loadServicesData(); // Recargar la lista de servicios
        }

    } catch (error) {
        console.error("❌ Error al intentar eliminar servicio:", error);
        alert(`❌ Error: ${error.message}`);
    }
}

function verDetalles(id) {
    const servicio = todosLosServicios.find(s => s.idTipoServicio === id);
    if (!servicio) {
        alert("Servicio no encontrado.");
        return;
    }
    
    // ✅ Usar 'descripcion' en lugar de 'descripcionExtendida'
    let mensaje = `═══════════════════════════════
DETALLES DEL SERVICIO
═══════════════════════════════
🔧 Nombre: ${servicio.nombreServicio}
🏷️ Categoría: ${servicio.idCategoriaServicio} // O mejor aún, buscar el nombre
💰 Costo: $${(servicio.costo|| 0).toLocaleString('es-CO')}
⏱️ Duración: ${servicio.duracion}
🔄 Frecuencia: ${servicio.frecuencia}
${servicio.icono ? `🎨 Icono: ${servicio.icono}` : ''}
📝 Descripción:
${servicio.descripcion} // ✅ Cambiado aquí
═══════════════════════════════`;

    // Si quieres mostrar el nombre de la categoría, haz lo mismo que en crearTarjetaServicio
    let nombreCategoria = 'Categoría no disponible';
    if (servicio.idCategoriaServicio && Array.isArray(todasLasCategorias)) {
        const cat = todasLasCategorias.find(c => c.idCategoriaServicio === servicio.idCategoriaServicio);
        if (cat) {
            nombreCategoria = cat.nombre;
        }
    }
    mensaje = mensaje.replace('🏷️ Categoría: ' + servicio.idCategoriaServicio, '🏷️ Categoría: ' + nombreCategoria);

    alert(mensaje);
}

// === INICIALIZACIÓN Y MANEJO DE EVENTOS ===
document.addEventListener('DOMContentLoaded', () => {
    console.log('Iniciando aplicación de Servicios...');

    loadServicesData();

    const form = document.getElementById('addServiceForm');
    if (form) {
        form.addEventListener('submit', handleAddServiceForm);
    } else {
        console.error("No se encontró el formulario #addServiceForm");
    }

    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    if (searchInput) searchInput.addEventListener('input', aplicarFiltros);
    if (categoryFilter) categoryFilter.addEventListener('change', aplicarFiltros);
});

// Manejar clics fuera del modal
window.onclick = function(event) {
    const modal = document.getElementById('addServiceModal');
    if (event.target === modal) {
        closeModal('addServiceModal');
    }
};
</script>
</body>
</html>