<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Gemini Ambiental Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }
        .fc-event-programado {
    background-color: #bee3f8; /* Azul claro */
    border-color: #63b3ed;
    color: #2c5282;
}

.fc-event-en-progreso {
    background-color: #feebc8; /* Naranja claro */
    border-color: #dd6b20;
    color: #7c2d12;
}

.fc-event-completado {
    background-color: #c6f6d5; /* Verde claro */
    border-color: #38a169;
    color: #22543d;
}

.fc-event-cancelado {
    background-color: #fed7d7; /* Rojo claro */
    border-color: #e53e3e;
    color: #742a2a;
}
.sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: 
                        url('docs/assets/img/BackgroundMenu.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-icon {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text h2 {
            font-size: 1.2em;
            margin-bottom: 0.2rem;
        }
        .logo-text p {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .nav-menu {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0.5rem 1rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .logout-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-btn:hover {
            background: rgba(255,107,107,0.3);
            transform: translateY(-2px);
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        .top-nav {
            background: white;
            padding: 1rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs {
            display: flex;
            gap: 2rem;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #718096;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }
        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
            transform: translateY(-2px);
        }
        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            color: #2c5f41;
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }
        .header-title p {
            color: #718096;
            font-size: 1.1em;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        .btn-danger:hover {
            background: #ff5252;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85em;
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85em;
        }
        .btn-outline-primary {
            background: white;
            color: #4a8b64;
            border: 1px solid #4a8b64;
        }
        .btn-outline-primary:hover {
            background: #4a8b64;
            color: white;
        }
        .btn-outline-danger {
            background: white;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .btn-outline-danger:hover {
            background: #ff6b6b;
            color: white;
        }
        .calendar-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }
        .calendar-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .calendar-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c5f41;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #4a8b64;
            color: white;
        }
        .month-year {
            font-weight: 600;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }
        .calendar-container {
            padding: 2rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: #f7fafc;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .calendar-day:hover {
            background: #f7fafc;
        }
        .calendar-day.today {
            background: #e6fffa;
        }
        .calendar-day.other-month {
            background: #f7fafc;
            color: #a0aec0;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .day-events {
            font-size: 0.8em;
            max-height: 60px;
            overflow-y: auto;
        }
        .event-item {
            background: var(--event-color);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-bottom: 0.2rem;
            font-size: 0.7em;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.control-plagas { --event-color: #4a8b64; }
        .event-item.lavado-tanques { --event-color: #4299e1; }
        .event-item.inspeccion { --event-color: #f6ad55; }
        .event-item.seguimiento { --event-color: #9f7aea; }
        .sidebar-calendar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .today-schedule {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .schedule-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .schedule-date {
            color: #718096;
            font-size: 0.9em;
        }
        .schedule-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .schedule-time {
            min-width: 80px;
            font-weight: 600;
            color: #4a8b64;
            text-align: center;
            background: #f0fff4;
            border-radius: 8px;
            padding: 0.5rem;
        }
        .event-item.estado-cancelado {
            background-color: #e2e3e5; /* Gris claro */
            border-left: 4px solid #6c757d; /* Borde gris */
            opacity: 0.8;
            text-decoration: line-through;
        }

        .event-item.estado-cancelado .event-title,
        .event-item.estado-cancelado .event-time,
        .event-item.estado-cancelado .event-client {
            color: #6c757d; /* Texto gris */
        }
        .schedule-details {
            flex: 1;
        }
        .schedule-service {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .schedule-client {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .schedule-technician {
            color: #4a8b64;
            font-size: 0.8em;
        }
        .quick-add {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #4a8b64;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .service-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #4a8b64;
        }
        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        .service-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a8b64;
        }
        .service-time-large {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a8b64;
        }
        .service-actions {
            display: flex;
            gap: 0.5rem;
        }
        .service-card-body {
            margin-top: 1rem;
        }
        .service-info-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
        }
        .service-info-label {
            font-weight: 600;
            color: #4a5568;
        }
        .service-info-value {
            color: #2d3748;
        }
        .status-badge, .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .status-programado, .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        .status-en-progreso, .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }
        .status-completado, .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-cancelado, .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        .badge-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .calendar-layout {
                grid-template-columns: 1fr;
            }
            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            .form-grid-2 {
                grid-template-columns: 1fr;
            }
            /* Clases para los eventos seg√∫n su estado */
.event-item.programado {
    background-color: #bee3f8; /* Azul claro */
    border-color: #63b3ed;
    color: #2c5282;
}

.event-item.en-progreso {
    background-color: #feebc8; /* Naranja claro */
    border-color: #dd6b20;
    color: #7c2d12;
}

.event-item.completado {
    background-color: #c6f6d5; /* Verde claro */
    border-color: #48bb78;
    color: #276749;
}

.event-item.cancelado {
    background-color: #fed7d7; /* Rojo claro */
    border-color: #e53e3e;
    color: #742a2a;
}
        }
        /* ========== MODAL DE ALERTA PERSONALIZADO ========== */
        .modal-custom-alert {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 2000; /* Debe estar por encima de otros modales */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Fondo semitransparente */
            animation: fadeIn 0.3s ease-out forwards;
        }

        .modal-custom-alert.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-custom-alert-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s ease-out forwards;
            overflow: hidden; /* Para que el borde redondeado se aplique a los hijos */
        }

        .modal-custom-alert-header {
            background: linear-gradient(135deg, #2c5f41, #4a8b64);
            color: white;
            padding: 1.2rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px; /* Coincidir con el radio del contenedor */
            border-top-right-radius: 12px;
        }

        .modal-custom-alert-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .modal-custom-alert-close {
            color: #fff;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-custom-alert-close:hover {
            color: #f7fafc;
        }

        .modal-custom-alert-body {
            padding: 1.5rem;
            line-height: 1.6;
        }

        .modal-custom-alert-footer {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            text-align: right;
            border-bottom-left-radius: 12px; /* Coincidir con el radio del contenedor */
            border-bottom-right-radius: 12px;
        }

        /* Iconos para diferentes tipos de alertas */
        .alert-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .alert-icon.info { color: #4299e1; }
        .alert-icon.success { color: #48bb78; }
        .alert-icon.warning { color: #f6ad55; }
        .alert-icon.error { color: #e53e3e; }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="LogoMenu.png" alt="Gemini Ambiental" style="height: 60px; object-fit: contain;">
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">üì¶</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link active">
                    <span class="nav-icon">üìÖ</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">üí∞</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="servicios.html" class="nav-link">
                    <span class="nav-icon">üîß</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-nav">
            <div class="nav-tabs">
                <a class="nav-tab active" onclick="showView('calendar')">üìÖ Calendario</a>
                <a class="nav-tab" onclick="showView('list')">üìã Lista</a>
                <a class="nav-tab" onclick="showView('timeline')">‚è∞ Cronograma</a>
                <a class="nav-tab" onclick="showView('map')">üó∫Ô∏è Mapa</a>
            </div>
            <div class="nav-actions">
                <select class="form-control" style="width: auto;" id="filterTecnico">
                    <option value="">Todos los t√©cnicos</option>
                </select>
                <button class="btn btn-secondary">üìä Reportes</button>
            </div>
        </div>

        <div class="header">
            <div class="header-title">
                <h1>Agenda de Servicios</h1>
                <p>Programaci√≥n y seguimiento de actividades</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="exportSchedule()">üì§ Exportar</button>
                <button class="btn btn-primary" onclick="openAddServiceModal()">‚ûï Programar Servicio</button>
            </div>
        </div>

        <div class="calendar-layout">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 class="calendar-title" id="calendarMainTitle">Noviembre 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <div class="month-year" id="calendarMonthYear">Noviembre 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-header">Dom</div>
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mi√©</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header">S√°b</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-calendar">
                <div class="today-schedule">
                    <div class="schedule-header">
                        <h3 class="schedule-title">Agenda de Hoy</h3>
                        <div class="schedule-date" id="todayDate"></div>
                    </div>
                    <div id="todaySchedule"></div>
                </div>

                <div class="quick-add">
                    <h3 style="color: #2c5f41; margin-bottom: 1.5rem;">Programar R√°pido</h3>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select class="form-control" id="quickCliente" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="quickTipoServicio" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="quickFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="quickHora" required>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="quickTecnico" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" id="quickObservaciones" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="quickPrioridad">
                            <option>Normal</option>
                            <option>Alta</option>
                            <option>Urgente</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="quickAddService()">Programar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de servicios del d√≠a -->
    <div class="modal" id="dayServicesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" id="dayServicesTitle">Servicios del D√≠a</h2>
                <button class="close-btn" onclick="closeModal('dayServicesModal')">&times;</button>
            </div>
            <div id="dayServicesContent" style="max-height: 500px; overflow-y: auto;"></div>
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;">
                <button class="btn btn-primary" style="width: 100%;" onclick="openAddServiceModalFromDay()">
                    ‚ûï Agregar Otro Servicio en Esta Fecha
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de edici√≥n de servicio -->
    <div class="modal" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Servicio</h2>
                <button class="close-btn" onclick="closeModal('editServiceModal')">&times;</button>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="editClienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="editTipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="editTecnicoId" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="editFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="editHora" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select class="form-control" id="editPrioridad">
                        <option value="Normal">Normal</option>
                        <option value="Alta">Alta</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="editObservaciones" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="editEstado">
                        <option value="Programado">Programado</option>
                        <option value="En_Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de agregar servicio -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="serviceModalTitle">Programar Nuevo Servicio</h2>
            <button class="close-btn" onclick="closeModal('addServiceModal')">&times;</button>
        </div>
            <form id="serviceForm">
                <div class="form-group">
                    <label>Cotizaci√≥n Origen (Opcional)</label>
                    <select class="form-control" id="cotizacionId">
                        <option value="">Seleccionar cotizaci√≥n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="clienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="tipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="tecnicoId" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="fecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="hora" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Duraci√≥n Estimada</label>
                        <input type="text" class="form-control" id="duracionEstimada" placeholder="Ej: 2 horas">
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="prioridad">
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="observaciones" rows="3" placeholder="Instrucciones especiales, materiales necesarios, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="estado">
                        <option value="Programado">Programado</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Programar Servicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== MODAL DE ALERTA PERSONALIZADO ========== -->
    <div id="customAlertModal" class="modal-custom-alert">
        <div class="modal-custom-alert-content">
            <div class="modal-custom-alert-header">
                <span id="customAlertTitle" class="modal-custom-alert-title">Informaci√≥n</span>
                <span class="modal-custom-alert-close" onclick="closeCustomAlert()">&times;</span>
            </div>
            <div class="modal-custom-alert-body">
                <div class="alert-icon info">‚ÑπÔ∏è</div>
                <p id="customAlertMessage"></p>
            </div>
            <div class="modal-custom-alert-footer">
                <button class="btn btn-primary" onclick="closeCustomAlert()">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://backendgeminiambienta-v4-0.onrender.com/api';

let currentMonth = 10; // Noviembre (0-based: 0=Enero, 10=Noviembre)
let currentYear = 2025;
console.log('üìÖ Fecha actual:', new Date());
console.log('üìÖ Calendario configurado:', currentMonth + 1, currentYear);

// ‚úÖ AGREGAR monthNames global
const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                   "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let servicios = [];
        let todasLasPersonas = [];
        let todosLosTiposServicio = [];
        let cotizaciones = [];
        let currentView = 'all';
        let currentEditingId = null;
        let isSubmitting = false;
        let selectedDate = null; // Para recordar la fecha seleccionada

        // ========== FUNCIONES AUXILIARES MEJORADAS ==========
        function obtenerDNICliente(servicio) {
            // Intentar todas las variantes posibles
            if (servicio.cliente?.dni) return servicio.cliente.dni;
            if (servicio.dniCliente) return servicio.dniCliente;
            if (servicio.dni_cliente) return servicio.dni_cliente;
            if (servicio.DNI_cliente) return servicio.DNI_cliente;
            return null;
        }

        function obtenerDNITecnico(servicio) {
            if (servicio.empleadoAsignado?.dni) return servicio.empleadoAsignado.dni;
            if (servicio.dniEmpleadoAsignado) return servicio.dniEmpleadoAsignado;
            if (servicio.dni_empleado_asignado) return servicio.dni_empleado_asignado;
            if (servicio.DNI_empleado_asignado) return servicio.DNI_empleado_asignado;
            return null;
        }

        function debugServiciosCompleto() {
    console.log('üêõ DEBUG COMPLETO DE SERVICIOS:');
    console.log('üìÖ Fecha actual:', new Date().toLocaleDateString());
    console.log('üìÖ Calendario mostrando:', currentMonth + 1, currentYear);
    console.log('üìä Total servicios:', servicios.length);
    
    if (servicios.length === 0) {
        console.log('‚ùå No hay servicios cargados');
        return;
    }
    
    servicios.forEach((serv, index) => {
        console.log(`\nüìã Servicio ${index + 1}:`);
        console.log('   ID:', serv.idServicio);
        console.log('   Fecha:', serv.fecha);
        console.log('   Hora:', serv.hora);
        console.log('   Estado:', serv.estado);
        
        if (serv.fecha) {
            const fechaServ = new Date(serv.fecha);
            console.log('   üìÖ Fecha parseada:', fechaServ.toLocaleDateString());
            console.log('   üìÖ A√±o:', fechaServ.getFullYear(), 'Mes:', fechaServ.getMonth() + 1, 'D√≠a:', fechaServ.getDate());
            
            // Verificar si coincide con el calendario actual
            const coincide = fechaServ.getMonth() === currentMonth && fechaServ.getFullYear() === currentYear;
            console.log('   üìç Coincide con calendario actual:', coincide ? '‚úÖ S√ç' : '‚ùå NO');
        }
        
        console.log('   Cliente:', obtenerNombreCliente(serv));
        console.log('   T√©cnico:', obtenerNombreTecnico(serv));
        console.log('   Servicio:', obtenerNombreServicio(serv));
    });
}
function navegarAlMesDeServicios() {
    console.log('üìç Navegando al mes con servicios...');
    
    if (servicios.length === 0) {
        console.log('üìÖ No hay servicios cargados, usando mes actual');
        return;
    }
    
    // Encontrar todos los meses que tienen servicios
    const mesesConServicios = servicios
        .filter(s => s.fecha)
        .map(s => {
            const fecha = new Date(s.fecha);
            return {
                mes: fecha.getMonth(),
                a√±o: fecha.getFullYear()
            };
        });
    
    if (mesesConServicios.length === 0) {
        console.log('üìÖ No hay servicios con fecha v√°lida');
        return;
    }
    
    // Usar el primer servicio encontrado
    const primerMes = mesesConServicios[0];
    console.log(`üìç Primer servicio encontrado en: ${primerMes.mes + 1}/${primerMes.a√±o}`);
    
    // Navegar al mes del servicio
    currentMonth = primerMes.mes;
    currentYear = primerMes.a√±o;
    renderCalendar(currentMonth, currentYear);
    
    console.log(`‚úÖ Calendario navegado a: ${currentMonth + 1}/${currentYear}`);
}

        function obtenerNombreCliente(servicio) {
            console.log('üîç Buscando cliente para servicio:', servicio);
            
            // Intento 1: Objeto completo
            if (servicio.cliente?.nombre) {
                console.log('‚úÖ Cliente encontrado en objeto:', servicio.cliente.nombre);
                return servicio.cliente.nombre;
            }
            
            // Intento 2: Buscar por DNI
            const dniCliente = obtenerDNICliente(servicio);
            console.log('üìù DNI Cliente extra√≠do:', dniCliente);
            
            if (dniCliente && todasLasPersonas.length > 0) {
                const cliente = todasLasPersonas.find(p => {
                    const dniComparar = String(p.dni).trim();
                    const dniBuscar = String(dniCliente).trim();
                    return dniComparar === dniBuscar;
                });
                
                if (cliente) {
                    console.log('‚úÖ Cliente encontrado por DNI:', cliente.nombre);
                    return cliente.nombre;
                }
                console.warn('‚ö†Ô∏è Cliente con DNI', dniCliente, 'NO encontrado en lista de', todasLasPersonas.length, 'personas');
            }
            
            console.error('‚ùå No se pudo obtener nombre del cliente');
            return '‚ö†Ô∏è Cliente no encontrado';
        }

        function obtenerNombreTecnico(servicio) {
            console.log('üîç Buscando t√©cnico para servicio:', servicio);
            
            if (servicio.empleadoAsignado?.nombre) {
                console.log('‚úÖ T√©cnico encontrado en objeto:', servicio.empleadoAsignado.nombre);
                return servicio.empleadoAsignado.nombre;
            }
            
            const dniTecnico = obtenerDNITecnico(servicio);
            console.log('üìù DNI T√©cnico extra√≠do:', dniTecnico);
            
            if (dniTecnico && todasLasPersonas.length > 0) {
                const tecnico = todasLasPersonas.find(p => {
                    const dniComparar = String(p.dni).trim();
                    const dniBuscar = String(dniTecnico).trim();
                    return dniComparar === dniBuscar;
                });
                
                if (tecnico) {
                    console.log('‚úÖ T√©cnico encontrado por DNI:', tecnico.nombre);
                    return tecnico.nombre;
                }
                console.warn('‚ö†Ô∏è T√©cnico con DNI', dniTecnico, 'NO encontrado en lista de', todasLasPersonas.length, 'personas');
            }
            
            console.error('‚ùå No se pudo obtener nombre del t√©cnico');
            return '‚ö†Ô∏è T√©cnico no encontrado';
        }

        function obtenerNombreServicio(servicio) {
            console.log('üîç Buscando tipo de servicio:', servicio);
            
            if (servicio.tipoServicio?.nombreServicio) {
                const costo = servicio.tipoServicio.costo || 0;
                console.log('‚úÖ Tipo servicio encontrado en objeto:', servicio.tipoServicio.nombreServicio);
                return `${servicio.tipoServicio.nombreServicio} ($${costo.toLocaleString('es-CO')})`;
            }
            
            const idTipo = obtenerIDTipoServicio(servicio);
            console.log('üìù ID Tipo Servicio extra√≠do:', idTipo);
            
            if (idTipo && todosLosTiposServicio.length > 0) {
                const tipo = todosLosTiposServicio.find(t => {
                    return String(t.idTipoServicio) === String(idTipo);
                });
                
                if (tipo) {
                    const costo = tipo.costo || 0;
                    console.log('‚úÖ Tipo servicio encontrado por ID:', tipo.nombreServicio);
                    return `${tipo.nombreServicio} ($${costo.toLocaleString('es-CO')})`;
                }
                console.warn('‚ö†Ô∏è Tipo servicio con ID', idTipo, 'NO encontrado en lista de', todosLosTiposServicio.length, 'tipos');
            }
            
            console.error('‚ùå No se pudo obtener tipo de servicio');
            return '‚ö†Ô∏è Servicio Desconocido';
        }


// ========== CARGA DE DATOS ==========
async function loadAgendaData() {
    console.log("üîÑ Iniciando carga de datos de la agenda...");
    // ‚úÖ 1. Obtener el token JWT del almacenamiento local
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        showCustomAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'Error', 'error');
        setTimeout(() => {
            window.location.href = 'index.html'; // Redirige a la p√°gina de login
        }, 2000);
        return;
    }
    // ‚úÖ 2. Configurar los encabezados con el token de autenticaci√≥n
    const headers = {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
    };
    try {
        const [serviciosRes, personasRes, tiposServRes, cotizacionesRes] = await Promise.all([
            fetch(`${API_BASE_URL}/servicios`, { headers }).then(r => {
                if (!r.ok) throw new Error('Error al cargar servicios');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/personas`, { headers }).then(r => {
                if (!r.ok) throw new Error('Error al cargar personas');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/tipos-servicio`, { headers }).then(r => {
                if (!r.ok) throw new Error('Error al cargar tipos de servicio');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/cotizaciones`, { headers }).then(r => {
                if (!r.ok) throw new Error('Error al cargar cotizaciones');
                return r.json();
            })
        ]);

        // Filtrar y mapear servicios para manejar posibles variantes de nombre de campos
        servicios = Array.isArray(serviciosRes) ? serviciosRes.filter(s => {
            // Intentar obtener la fecha usando las posibles variantes de nombre
            const fecha = s.fecha || s.fecha_servicio || s.date || s.fechaCreacion || s.fecha_registro;
            return fecha !== undefined && fecha !== null && fecha !== '';
        }).map(s => {
            // Mapear posibles variantes de nombre a los nombres est√°ndar que espera el resto del c√≥digo
            return {
                ...s,
                fecha: s.fecha || s.fecha_servicio || s.date || s.fechaCreacion || s.fecha_registro,
                estado: s.estado || s.estado_servicio || s.state,
                dniCliente: s.dniCliente || s.dni_cliente || s.clientDni,
                dniEmpleadoAsignado: s.dniEmpleadoAsignado || s.dni_empleado_asignado || s.employeeDni,
                idTipoServicio: s.idTipoServicio || s.id_tipo_servicio || s.tipoServicioId,
                hora: s.hora || s.hora_servicio || s.time,
                observaciones: s.observaciones || s.observaciones_servicio || s.notes,
                prioridad: s.prioridad || s.prioridad_servicio || s.priority,
                duracionEstimada: s.duracionEstimada || s.duracion_estimada || s.duration,
                activo: s.activo !== undefined ? s.activo : s.active, // Manejar booleanos si es necesario
                servicioSinCotizacion: s.servicioSinCotizacion !== undefined ? s.servicioSinCotizacion : s.standalone,
                idCotizacion: s.idCotizacion || s.cotizacionId // Asegurar consistencia en ID de cotizaci√≥n tambi√©n si se usa
            };
        }) : [];


        todasLasPersonas = Array.isArray(personasRes) ? personasRes : [];
        // ‚úÖ Filtrar solo tipos de servicio ACTIVOS (en may√∫sculas)
        todosLosTiposServicio = Array.isArray(tiposServRes) ?
            tiposServRes.filter(t => t.estado && t.estado.toUpperCase() === 'ACTIVO') : [];
        cotizaciones = Array.isArray(cotizacionesRes) ? cotizacionesRes : [];
        console.log(`‚úÖ Datos cargados exitosamente:`);
        console.log(`   üìã ${servicios.length} servicios`);
        console.log(`   üë• ${todasLasPersonas.length} personas`);
        console.log(`   üõ†Ô∏è ${todosLosTiposServicio.length} tipos de servicio ACTIVOS`);
        console.log(`   üí∞ ${cotizaciones.length} cotizaciones`);
        populateClienteSelect(todasLasPersonas);
        populateTecnicoSelect(todasLasPersonas);
        populateTipoServicioSelect(todosLosTiposServicio);
        populateCotizacionSelect(cotizaciones);
        populateFilterTecnico(todasLasPersonas);
        renderCalendar(currentMonth, currentYear);
        renderTodaySchedule(new Date());
        console.log('‚úÖ Inicializaci√≥n completada');
    } catch (error) {
        console.error('‚ùå Error al cargar datos de agenda:', error);
        showCustomAlert('Error al cargar la agenda: ' + error.message, 'Error', 'error');
    }
}
        // ========== POPULATION FUNCTIONS ==========
        function populateClienteSelect(personas) {
            const selects = ['clienteId', 'editClienteId', 'quickCliente'];
            const clientes = personas.filter(p => p.rol === 'Cliente');
            
            console.log(`üìã Poblando selects de clientes con ${clientes.length} clientes`);
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="">Seleccionar cliente</option>';
                clientes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.dni;
                    option.textContent = p.nombre;
                    select.appendChild(option);
                });
            });
        }

        function populateTecnicoSelect(personas) {
            const selects = ['tecnicoId', 'editTecnicoId', 'quickTecnico'];
            const tecnicos = personas.filter(p => p.rol === 'Empleado');
            
            console.log(`üìã Poblando selects de t√©cnicos con ${tecnicos.length} empleados`);
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="">Seleccionar t√©cnico</option>';
                tecnicos.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.dni;
                    option.textContent = p.nombre;
                    select.appendChild(option);
                });
            });
        }

        // ‚úÖ Funci√≥n corregida y mejorada para poblar selectores de tipos de servicio ACTIVOS
        function populateTipoServicioSelect(tipos) {
            // Asegurarse de que solo se usen tipos ACTIVOS (ya filtrados al cargar)
            const tiposActivos = tipos.filter(t => t.estado === 'ACTIVO');
            
            const selects = ['tipoServicioId', 'editTipoServicioId', 'quickTipoServicio'];
            
            console.log(`üìã Poblando selects de tipos de servicio ACTIVOS con ${tiposActivos.length} tipos`);
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="">Seleccionar tipo</option>';
                tiposActivos.forEach(ts => {
                    const option = document.createElement('option');
                    option.value = ts.idTipoServicio;
                    // Mostrar nombre y costo
                    option.textContent = `${ts.nombreServicio} ($${(ts.costo || 0).toLocaleString('es-CO')})`;
                    select.appendChild(option);
                });
            });
        }


function populateCotizacionSelect(cotizaciones) {
    const select = document.getElementById('cotizacionId');
    if (!select) return;
    select.innerHTML = '<option value="">Seleccionar cotizaci√≥n</option>';
    
    // ‚úÖ SOLO mostrar cotizaciones APROBADAS (sin importar si ya se usaron)
    const cotizacionesAprobadas = cotizaciones.filter(c => c.estado === 'Aprobada');
    
    cotizacionesAprobadas.forEach(c => {
        const clienteNombre = c.cliente?.nombre || c.nombreCliente || 'Cliente desconocido';
        const option = document.createElement('option');
        option.value = c.idCotizacion;
        option.textContent = `#${c.idCotizacion} - ${clienteNombre} - ${c.descripcionProblema || 'Sin descripci√≥n'}`;
        select.appendChild(option);
    });
}

        function populateFilterTecnico(personas) {
            const select = document.getElementById('filterTecnico');
            if (!select) return;
            select.innerHTML = '<option value="">Todos los t√©cnicos</option>';
            personas.filter(p => p.rol === 'Empleado').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        // ========== RENDER CALENDAR ==========
function renderCalendar(month, year) {
    console.log(`üéØ Renderizando calendario: ${monthNames[month]} ${year}`);
    
    // ‚úÖ ACTUALIZAR TODOS LOS ELEMENTOS DEL T√çTULO
    const calendarTitle = document.getElementById('calendarMainTitle');
    const monthYearElement = document.getElementById('calendarMonthYear');
    
    if (calendarTitle) {
        calendarTitle.textContent = `${monthNames[month]} ${year}`;
    }
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }

            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;

            const headers = calendarGrid.querySelectorAll('.calendar-day-header');
            calendarGrid.innerHTML = '';
            headers.forEach(header => calendarGrid.appendChild(header));

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const prevLastDay = new Date(year, month, 0).getDate();

            for (let i = startDay - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${prevLastDay - i}</div>`;
                calendarGrid.appendChild(dayElement);
            }

            const today = new Date();
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events"></div>`;

                const serviciosDelDia = servicios.filter(s => {
                    if (!s.fecha) return false;
                    const fechaServicio = new Date(s.fecha + 'T00:00:00');
                    return fechaServicio.getDate() === day && 
                           fechaServicio.getMonth() === month && 
                           fechaServicio.getFullYear() === year;
                });

                const eventsContainer = dayElement.querySelector('.day-events');
                serviciosDelDia.forEach(serv => {
                    const eventElement = document.createElement('div');
                    // --- MODIFICACI√ìN AQU√ç ---
                    // Se a√±ade la clase del estado del servicio a la clase del tipo
                    eventElement.className = `event-item ${getEventTypeClass(serv)} ${getEstadoClass(serv.estado)}`;
                    // --- FIN MODIFICACI√ìN ---
                    const nombreCliente = obtenerNombreCliente(serv);
                    const primerNombre = nombreCliente.split(' ')[0];
                    eventElement.textContent = `${serv.hora ? serv.hora.substring(0,5) : ''} ${primerNombre}`;
                    eventElement.title = `${obtenerNombreServicio(serv)}\nCliente: ${nombreCliente}\nHora: ${serv.hora || 'No definida'}`;
                    eventElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditServiceModal(serv); // Aseg√∫rate de que esta funci√≥n exista y funcione como esperas
                    });
                    eventsContainer.appendChild(eventElement);
                });

                dayElement.addEventListener('click', () => showDayServices(date));
                calendarGrid.appendChild(dayElement);
            }

            const totalCells = 42;
            const remaining = totalCells - (startDay + totalDays);
            for (let day = 1; day <= remaining; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                calendarGrid.appendChild(dayElement);
            }
        }
        // ========== FUNCIONES DE ESTADO ==========
        function getEstadoClass(estado) {
            // Normalizar el estado: convertir a string, trim, reemplazar espacios por _, y a min√∫sculas
            const estadoNormalizado = String(estado || '').trim().replace(/\s+/g, '_').toLowerCase();
            
            switch (estadoNormalizado) {
                case 'programado':
                    return 'badge-info';
                case 'en_progreso':
                case 'en progreso': // Tambi√©n maneja el espacio original
                    return 'badge-warning';
                case 'completado':
                    return 'badge-success';
                case 'cancelado':
                    return 'badge-danger';
                default:
                    // Si el estado es desconocido, usar gris
                    console.warn(`Estado desconocido: "${estado}". Usando clase por defecto.`);
                    return 'badge-secondary';
            }
        }

        function getEventTypeClass(servicio) {
            const nombreServicio = obtenerNombreServicio(servicio).toLowerCase();
            if (nombreServicio.includes('fumig') || nombreServicio.includes('plaga') || nombreServicio.includes('control')) return 'control-plagas';
            if (nombreServicio.includes('tanque') || nombreServicio.includes('lavado')) return 'lavado-tanques';
            if (nombreServicio.includes('inspeccion') || nombreServicio.includes('inspecci√≥n')) return 'inspeccion';
            if (nombreServicio.includes('seguimiento')) return 'seguimiento';
            return 'control-plagas';
        }

        // ========== SHOW DAY SERVICES ==========
        function showDayServices(date) {
            selectedDate = date; // Guardar la fecha seleccionada
            
            const modal = document.getElementById('dayServicesModal');
            const title = document.getElementById('dayServicesTitle');
            const content = document.getElementById('dayServicesContent');

            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();

            const serviciosDelDia = servicios.filter(s => {
                if (!s.fecha) return false;
                const fechaServicio = new Date(s.fecha + 'T00:00:00');
                return fechaServicio.getDate() === day &&
                       fechaServicio.getMonth() === month &&
                       fechaServicio.getFullYear() === year;
            });

            const dateStr = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            title.textContent = `Servicios del ${dateStr}`;

            console.log(`üìÖ Mostrando servicios del ${dateStr}:`, serviciosDelDia.length, 'servicios encontrados');

            if (serviciosDelDia.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üìÖ</div>
                        <p style="font-size: 1.1em; margin-bottom: 0.5rem;">No hay servicios programados para esta fecha</p>
                        <p style="font-size: 0.9em;">Haga clic en el bot√≥n de abajo para programar uno</p>
                    </div>
                `;
            } else {
                content.innerHTML = serviciosDelDia.map(serv => {
                    const nombreCliente = obtenerNombreCliente(serv);
                    const nombreTecnico = obtenerNombreTecnico(serv);
                    const nombreServicio = obtenerNombreServicio(serv);
                    const hora = serv.hora ? serv.hora.substring(0, 5) : 'No definida';

                    // ‚úÖ Aseg√∫rate de que serv.estado sea un string limpio
                    const estadoMostrado = serv.estado ? serv.estado.charAt(0).toUpperCase() + serv.estado.slice(1).replace('_', ' ') : 'Programado';

                    return `<div class="service-card">
                        <div class="service-card-header">
                            <span class="service-time">${hora}</span>
                            <div class="service-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditServiceModal('${serv.idServicio}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelarServicio('${serv.idServicio}')">üóëÔ∏è Cancelar</button>
                            </div>
                        </div>
                        <div class="service-card-body">
                            <div class="service-info-row"><span class="service-info-label">Servicio:</span><span class="service-info-value">${nombreServicio}</span></div>
                            <div class="service-info-row"><span class="service-info-label">Cliente:</span><span class="service-info-value">${nombreCliente}</span></div>
                            <div class="service-info-row"><span class="service-info-label">T√©cnico:</span><span class="service-info-value">${nombreTecnico}</span></div>
                            <div class="service-info-row"><span class="service-info-label">Prioridad:</span><span class="service-info-value">${serv.prioridad || 'Normal'}</span></div>
                            <!-- ‚úÖ Mostrar el estado con la clase CSS correcta -->
                            <div class="service-info-row">
                                <span class="service-info-label">Estado:</span>
                                <span class="service-info-value">
                                    <span class="badge ${getEstadoClass(serv.estado)}">${estadoMostrado}</span>
                                </span>
                            </div>
                            ${serv.observaciones ? `<div class="service-info-row"><span class="service-info-label">Observaciones:</span><span class="service-info-value">${serv.observaciones}</span></div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }

            modal.classList.add('show');
        }

        // Funci√≥n para abrir modal de agregar desde el d√≠a
        function openAddServiceModalFromDay() {
            closeModal('dayServicesModal');
            openAddServiceModal(selectedDate); // Pasar la fecha seleccionada
        }


function formatCurrencyForPDF(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
    return '$ ' + new Intl.NumberFormat('es-CO').format(amount);
}
function formatCurrencyForPDF(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
    return '$ ' + new Intl.NumberFormat('es-CO').format(amount);
}

function formatDateForPDF(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CO');
    } catch (e) {
        return 'Fecha inv√°lida';
    }
}

function convertirValorK(valor) {
    if (typeof valor === 'string') {
        if (valor.includes('K')) {
            const numero = parseFloat(valor.replace('K', '').replace(',', '.').replace(/\./g, '').trim());
            return !isNaN(numero) ? numero * 1000 : 0;
        }
        const numeroLimpio = valor.replace(/\./g, '').replace(',', '.');
        return parseFloat(numeroLimpio) || 0;
    }
    return parseFloat(valor) || 0;
} 
// ‚úÖ FUNCI√ìN viewInvoice COMPLETAMENTE CORREGIDA
async function viewInvoice(id) {
    try {
        console.log("üìÑ Generando PDF para factura:", id);
        
        const token = localStorage.getItem('jwtToken');
        const headers = { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };
        
        // 1. Cargar datos de la factura PRIMERO
        console.log("üîç Cargando datos de la factura...");
        const response = await fetch(`${API_FACTURAS_URL}/${id}`, { headers });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status} al cargar factura: ${errorText}`);
        }
        
        const facturaCompleta = await response.json();
        console.log("üìã Factura cargada exitosamente:", facturaCompleta);

        // 2. Definir valorServicio DESPU√âS de tener facturaCompleta
        const valorServicio = parseFloat(facturaCompleta.valorServicio) || 0;
        console.log("üí∞ Valor servicio:", valorServicio);

        // 3. Convertir valores con "K" si es necesario
        if (typeof facturaCompleta.montoTotal === 'string') {
            facturaCompleta.montoTotal = convertirValorK(facturaCompleta.montoTotal);
        }

        // 4. Obtener informaci√≥n del cliente
        let cliente = {};
        if (facturaCompleta.cliente) {
            cliente = facturaCompleta.cliente;
        } else {
            cliente = clientesData.find(c => c.dni === facturaCompleta.dniCliente) || {
                nombre: facturaCompleta.nombreCliente || 'Cliente no especificado',
                dni: facturaCompleta.dniCliente || 'N/A',
                telefono: facturaCompleta.telefonoCliente || 'N/A',
                correo: facturaCompleta.correoCliente || 'N/A'
            };
        }

        // 5. Crear PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 20;

        // ===== ENCABEZADO =====
        doc.setFontSize(20);
        doc.setTextColor(44, 95, 65);
        doc.text('FACTURA DE VENTA', pageWidth / 2, 25, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('Gemini Ambiental SAS', pageWidth / 2, 32, { align: 'center' });
        doc.text('NIT: 901.234.567-8', pageWidth / 2, 37, { align: 'center' });
        doc.text('Carrera 45 # 12-34, Medell√≠n, Colombia', pageWidth / 2, 42, { align: 'center' });

        doc.setDrawColor(44, 95, 65);
        doc.line(margin, 47, pageWidth - margin, 47);

        // ===== INFORMACI√ìN FACTURA Y CLIENTE =====
        let yPos = 57;
        
        // Datos factura
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DE LA FACTURA', margin, yPos);
        doc.setFont(undefined, 'normal');
        
        yPos += 8;
        doc.text(`N¬∞ Factura: ${facturaCompleta.idFactura || 'N/A'}`, margin, yPos);
        yPos += 6;
        doc.text(`Fecha Emisi√≥n: ${formatDateForPDF(facturaCompleta.fechaEmision)}`, margin, yPos);
        yPos += 6;
        doc.text(`Estado: ${facturaCompleta.estado || 'N/A'}`, margin, yPos);
        yPos += 6;
        doc.text(`Tipo: ${facturaCompleta.tipoFactura || 'Simple'}`, margin, yPos);
        
        if (facturaCompleta.idCotizacion) {
            yPos += 6;
            doc.text(`Cotizaci√≥n: ${facturaCompleta.idCotizacion}`, margin, yPos);
        }

        // Datos cliente
        const clienteX = pageWidth / 2 + 10;
        let yPosCliente = 57;
        
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DEL CLIENTE', clienteX, yPosCliente);
        doc.setFont(undefined, 'normal');
        
        yPosCliente += 8;
        doc.text(`Cliente: ${cliente.nombre || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Documento: ${cliente.dni || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Tel√©fono: ${cliente.telefono || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Correo: ${cliente.correo || 'N/A'}`, clienteX, yPosCliente);

        const infoBottom = Math.max(yPos, yPosCliente) + 10;
        doc.line(margin, infoBottom, pageWidth - margin, infoBottom);

        // ===== DETALLES =====
        let currentY = infoBottom + 15;

        // Posiciones columnas
        const colDescripcion = margin;
        const colCantidad = margin + 70;
        const colPrecio = margin + 90;
        const colTotal = margin + 130;

        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('DESCRIPCI√ìN', colDescripcion, currentY);
        doc.text('CANT.', colCantidad, currentY);
        doc.text('PRECIO UNIT.', colPrecio, currentY);
        doc.text('VALOR TOTAL', colTotal, currentY);
        
        currentY += 4;
        doc.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 8;

        doc.setFont(undefined, 'normal');
        
        let subtotalProductos = 0;
        let tieneItems = false;

        // Obtener detalles
        let detalleParaMostrar = [];

        if (facturaCompleta.detalleFactura && facturaCompleta.detalleFactura.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleFactura;
        } else if (facturaCompleta.detalleProductos && facturaCompleta.detalleProductos.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleProductos;
        } else if (facturaCompleta.detalleServicios && facturaCompleta.detalleServicios.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleServicios;
        }

        // MOSTRAR ITEMS
        if (detalleParaMostrar.length > 0) {
            tieneItems = true;
            
            for (const item of detalleParaMostrar) {
                if (currentY > 180) {
                    doc.addPage();
                    currentY = 30;
                    doc.setFont(undefined, 'bold');
                    doc.text('DESCRIPCI√ìN', colDescripcion, currentY);
                    doc.text('CANT.', colCantidad, currentY);
                    doc.text('PRECIO UNIT.', colPrecio, currentY);
                    doc.text('VALOR TOTAL', colTotal, currentY);
                    currentY += 8;
                    doc.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 8;
                    doc.setFont(undefined, 'normal');
                }
                
                const nombre = item.nombreProducto || item.nombreServicio || 'Producto/Servicio';
                const cantidad = item.cantidad || 1;
                const precioUnitario = parseFloat(item.precioUnitario) || 0;
                let subtotal = parseFloat(item.subtotal) || 0;
                
                if (subtotal === 0 && precioUnitario > 0) {
                    subtotal = precioUnitario * cantidad;
                }

                const descripcionLines = doc.splitTextToSize(nombre, 60);
                const lineHeight = 5;
                const descripcionHeight = descripcionLines.length * lineHeight;
                
                doc.text(descripcionLines, colDescripcion, currentY);
                doc.text(cantidad.toString(), colCantidad, currentY);
                doc.text(formatCurrencyForPDF(precioUnitario), colPrecio, currentY);
                doc.text(formatCurrencyForPDF(subtotal), colTotal, currentY);
                
                currentY += Math.max(descripcionHeight, lineHeight) + 2;
                subtotalProductos += subtotal;
            }
        } else {
            doc.text('No hay productos o servicios en esta factura', colDescripcion, currentY);
            currentY += 8;
        }

        // ‚úÖ ESPACIO DESPU√âS DE LOS PRODUCTOS
        currentY += 20;

        // ===== VALOR DEL SERVICIO =====
        // ‚úÖ AHORA valorServicio est√° correctamente definido
        
        // ‚úÖ MOSTRAR VALOR DEL SERVICIO SIEMPRE QUE SEA MAYOR A 0
        if (valorServicio > 0) {
            if (currentY > 180) {
                doc.addPage();
                currentY = 30;
            }
            
            // T√≠tulo para valor del servicio
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('VALOR DEL SERVICIO:', margin, currentY);
            doc.text(formatCurrencyForPDF(valorServicio), colTotal, currentY);
            doc.setFont(undefined, 'normal');
            currentY += 15;
            
            // L√≠nea separadora
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 10;
        }

        // ‚úÖ CALCULAR TOTAL FINAL
        let totalFinal = parseFloat(facturaCompleta.montoTotal) || (subtotalProductos + valorServicio);
        
        console.log("üí∞ Totales calculados:", {
            subtotalProductos: subtotalProductos,
            valorServicio: valorServicio,
            totalFinal: totalFinal
        });

        // ‚úÖ CALCULAR ALTURA NECESARIA PARA LOS TOTALES
        const lineasTotales = [];
        
        if (tieneItems && subtotalProductos > 0) {
            lineasTotales.push('SUBTOTAL PRODUCTOS');
        }
        if (valorServicio > 0) {
            lineasTotales.push('VALOR SERVICIO');
        }
        lineasTotales.push('TOTAL');
        
        const alturaNecesaria = (lineasTotales.length * 12) + 30;
        
        // ‚úÖ SI NO HAY ESPACIO SUFICIENTE, NUEVA P√ÅGINA
        if (currentY + alturaNecesaria > 250) {
            doc.addPage();
            currentY = 30;
        }

        // ‚úÖ L√çNEA SEPARADORA
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 15;

        // ‚úÖ SUBTOTAL PRODUCTOS
        if (tieneItems && subtotalProductos > 0) {
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('SUBTOTAL PRODUCTOS:', colPrecio, currentY);
            doc.text(formatCurrencyForPDF(subtotalProductos), colTotal, currentY);
            currentY += 12;
        }

        // ‚úÖ VALOR SERVICIO (mostrar incluso si es 0 para claridad)
        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        doc.text('VALOR SERVICIO:', colPrecio, currentY);
        doc.text(formatCurrencyForPDF(valorServicio), colTotal, currentY);
        currentY += 12;

        // ‚úÖ L√çNEAS DOBLES PARA SEPARAR EL TOTAL FINAL
        currentY += 8;
        doc.setDrawColor(44, 95, 65);
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 3;
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 12;

        // ‚úÖ TOTAL FACTURA
        doc.setFontSize(14);
        doc.setTextColor(44, 95, 65);
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL FACTURA:', colPrecio, currentY);
        doc.text(formatCurrencyForPDF(totalFinal), colTotal, currentY);

        // ===== OBSERVACIONES =====
        if (facturaCompleta.observaciones) {
            currentY += 25;
            if (currentY > 250) {
                doc.addPage();
                currentY = 30;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVACIONES:', margin, currentY);
            doc.setFont(undefined, 'normal');
            currentY += 6;
            
            const observacionesLines = doc.splitTextToSize(facturaCompleta.observaciones, pageWidth - (2 * margin));
            doc.text(observacionesLines, margin, currentY);
        }

        // ===== PIE DE P√ÅGINA =====
        const footerY = 280;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, footerY, pageWidth - margin, footerY);
        
        doc.text('Gemini Ambiental SAS - NIT: 901.234.567-8', margin, footerY + 5);
        doc.text('Tel: +57 (4) 444 5555 - www.geminiambiental.com', margin, footerY + 10);
        doc.text(`Documento generado el: ${new Date().toLocaleDateString('es-CO')}`, pageWidth - margin, footerY + 10, { align: 'right' });

        // ===== MOSTRAR/DESCARGAR =====
        const nombreArchivo = `Factura_${facturaCompleta.idFactura}.pdf`;
        
        const userChoice = confirm(
            '¬øDesea descargar la factura como PDF?\n\nCancelar = Vista previa\nAceptar = Descargar'
        );
        
        if (userChoice) {
            doc.save(nombreArchivo);
            console.log("‚úÖ PDF descargado:", nombreArchivo);
        } else {
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            setTimeout(() => URL.revokeObjectURL(pdfUrl), 60000);
        }

    } catch (error) {
        console.error("‚ùå Error generando PDF:", error);
        alert("‚ùå Error al generar el PDF: " + error.message);
    }
}
        // ========== EDIT SERVICE ==========
        function openEditServiceModal(id) {
            console.log('üîç Abriendo modal de edici√≥n para servicio:', id);
            
            const servicio = servicios.find(s => s.idServicio === id);
            if (!servicio) {
                console.error('‚ùå Servicio no encontrado');
                // alert("Servicio no encontrado. Por favor, recargue la p√°gina.");
                showCustomAlert("Servicio no encontrado. Por favor, recargue la p√°gina.", 'Error', 'error');
                return;
            }

            console.log('üìã Servicio a editar:', servicio);

            const dniCliente = obtenerDNICliente(servicio);
            const dniTecnico = obtenerDNITecnico(servicio);
            const idTipoServ = obtenerIDTipoServicio(servicio);

            console.log('üìù Valores extra√≠dos:', { dniCliente, dniTecnico, idTipoServ });

            if (!dniCliente || !dniTecnico || !idTipoServ) {
                const faltantes = [];
                if (!dniCliente) faltantes.push('Cliente');
                if (!dniTecnico) faltantes.push('T√©cnico');
                if (!idTipoServ) faltantes.push('Tipo de servicio');
                
                // alert(`‚ö†Ô∏è Este servicio tiene datos incompletos:\n\n‚Ä¢ ${faltantes.join('\n‚Ä¢ ')}\n\nPor favor, complete estos datos antes de guardar.`);
                showCustomAlert(`‚ö†Ô∏è Este servicio tiene datos incompletos:\n\n‚Ä¢ ${faltantes.join('\n‚Ä¢ ')}\n\nPor favor, complete estos datos antes de guardar.`, 'Advertencia', 'warning');
            }

            // Llenar formulario
            document.getElementById('editClienteId').value = dniCliente || '';
            document.getElementById('editTecnicoId').value = dniTecnico || '';
            document.getElementById('editTipoServicioId').value = idTipoServ || '';
            document.getElementById('editFecha').value = servicio.fecha || '';
            document.getElementById('editHora').value = servicio.hora ? servicio.hora.substring(0, 5) : '';
            document.getElementById('editPrioridad').value = servicio.prioridad || 'Normal';
            document.getElementById('editObservaciones').value = servicio.observaciones || '';
            // Normalizar estado para el select
            const estadoNormalizado = servicio.estado ? servicio.estado.replace(' ', '_') : 'Programado';
            document.getElementById('editEstado').value = estadoNormalizado;
            document.getElementById('editServiceId').value = servicio.idServicio;

            closeModal('dayServicesModal');
            document.getElementById('editServiceModal').classList.add('show');
            
            console.log('‚úÖ Modal de edici√≥n abierto');
        }

// Funci√≥n para actualizar un servicio existente
async function updateService(event) {
    event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    // ‚úÖ 1. Obtener el token JWT del almacenamiento local
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        showCustomAlert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'Error', 'error');
        return;
    }

    try {
        const servicioId = document.getElementById('editServiceId').value;
        const dniCliente = document.getElementById('editClienteId').value.trim();
        const dniEmpleadoAsignado = document.getElementById('editTecnicoId').value.trim();
        const idTipoServicio = document.getElementById('editTipoServicioId').value.trim();
        const fecha = document.getElementById('editFecha').value; // Formato YYYY-MM-DD
        const hora = document.getElementById('editHora').value; // Formato HH:MM

        // ‚úÖ VALIDAR QUE LA FECHA Y HORA NO SEAN PASADAS
        const ahora = new Date();
        const fechaSeleccionada = new Date(fecha + 'T' + hora + ':00');
        if (fechaSeleccionada < ahora) {
            showCustomAlert("No se puede programar un servicio en una fecha u hora pasada.", 'Advertencia', 'warning');
            isSubmitting = false;
            return;
        }

        const observaciones = document.getElementById('editObservaciones').value.trim() || null;
        const prioridad = document.getElementById('editPrioridad').value;
        const servicioData = {
            idServicio: servicioId,
            dniCliente,
            dniEmpleadoAsignado,
            idTipoServicio,
            fecha,
            hora: hora + ':00', // Asegurar formato HH:MM:SS
            estado: document.getElementById('editEstado').value,
            observaciones,
            prioridad
        };

        console.log("üîÑ Actualizando servicio:", servicioData);

        // ‚úÖ 2. Configurar los headers con el token de autenticaci√≥n
        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };

        const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(servicioData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `Error ${response.status}`);
        }

        showCustomAlert("Servicio actualizado exitosamente.", '√âxito', 'success');
        closeModal('editServiceModal');
        await loadAgendaData(); // Recargar la agenda

    } catch (error) {
        console.error("Error:", error);
        showCustomAlert(`Error: ${error.message}`, 'Error', 'error');
    } finally {
        isSubmitting = false;
    }
}

        // ========== CANCEL SERVICE ==========
        async function cancelService(servicioId) {
            console.log('üóëÔ∏è Intentando cancelar servicio:', servicioId);
            
            if (!confirm('¬øEst√° seguro de que desea cancelar este servicio?')) {
                return;
            }
            
            const servicio = servicios.find(s => s.idServicio === servicioId);
            if (!servicio) {
                // alert('‚ùå Servicio no encontrado');
                showCustomAlert('Servicio no encontrado', 'Error', 'error');
                await loadAgendaData();
                closeModal('dayServicesModal');
                return;
            }

            const dniCliente = obtenerDNICliente(servicio);
            const dniTecnico = obtenerDNITecnico(servicio);
            const idTipoServ = obtenerIDTipoServicio(servicio);

            if (!dniCliente || !dniTecnico || !idTipoServ) {
                // alert('‚ùå Este servicio tiene datos incompletos y no puede ser cancelado.\n\nPor favor, complete los datos obligatorios primero usando "Editar".');
                showCustomAlert('‚ùå Este servicio tiene datos incompletos y no puede ser cancelado.\n\nPor favor, complete los datos obligatorios primero usando "Editar".', 'Error', 'error');
                return;
            }

            try {
                const servicioData = {
                    dniCliente: dniCliente,
                    dniEmpleadoAsignado: dniTecnico,
                    idTipoServicio: idTipoServ,
                    fecha: servicio.fecha,
                    hora: servicio.hora,
                    observaciones: servicio.observaciones,
                    prioridad: servicio.prioridad || 'Normal',
                    estado: 'Cancelado' // Enviar estado como snake_case
                };

                console.log('üì§ Datos para cancelar:', servicioData);

                const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(servicioData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error del servidor:', errorText);
                    throw new Error(errorText || `Error ${response.status}`);
                }

                console.log('‚úÖ Servicio cancelado exitosamente');
                // alert('‚úÖ Servicio cancelado exitosamente');
                showCustomAlert('Servicio cancelado exitosamente', '√âxito', 'success');
                
                closeModal('dayServicesModal');
                await loadAgendaData();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                // alert(`‚ùå Error al cancelar servicio:\n\n${error.message}`);
                showCustomAlert(`Error al cancelar servicio:\n\n${error.message}`, 'Error', 'error');
            }
        }

        const cancelarServicio = cancelService;


        // ========== FUNCIONES AUXILIARES FALTANTES ==========

function obtenerDNICliente(servicio) {
    // Intentar todas las variantes posibles
    if (servicio.cliente?.dni) return servicio.cliente.dni;
    if (servicio.dniCliente) return servicio.dniCliente;
    if (servicio.dni_cliente) return servicio.dni_cliente;
    if (servicio.DNI_cliente) return servicio.DNI_cliente;
    return null;
}

function obtenerDNITecnico(servicio) {
    if (servicio.empleadoAsignado?.dni) return servicio.empleadoAsignado.dni;
    if (servicio.dniEmpleadoAsignado) return servicio.dniEmpleadoAsignado;
    if (servicio.dni_empleado_asignado) return servicio.dni_empleado_asignado;
    if (servicio.DNI_empleado_asignado) return servicio.DNI_empleado_asignado;
    return null;
}

// ‚úÖ AGREGAR ESTAS FUNCIONES FALTANTES AQU√ç
function obtenerIDTipoServicio(servicio) {
    console.log('üîç Buscando ID tipo servicio para:', servicio);
    
    if (servicio.tipoServicio?.idTipoServicio) {
        console.log('‚úÖ ID encontrado en objeto:', servicio.tipoServicio.idTipoServicio);
        return servicio.tipoServicio.idTipoServicio;
    }
    if (servicio.idTipoServicio) return servicio.idTipoServicio;
    if (servicio.id_tipo_servicio) return servicio.id_tipo_servicio;
    if (servicio.ID_tipo_servicio) return servicio.ID_tipo_servicio;
    if (servicio.tipoServicioId) return servicio.tipoServicioId;
    
    console.error('‚ùå No se pudo obtener ID del tipo de servicio');
    return null;
}

async function verificarAutenticacion() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        console.error('‚ùå No hay token JWT');
        showCustomAlert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.', 'Error', 'error');
        return false;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/personas`, {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Token inv√°lido');
        
        console.log('‚úÖ Token v√°lido');
        return true;
    } catch (error) {
        console.error('‚ùå Token inv√°lido:', error);
        showCustomAlert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.', 'Error', 'error');
        localStorage.removeItem('jwtToken');
        setTimeout(() => window.location.href = 'index.html', 2000);
        return false;
    }
}
        // ========== RENDER TODAY SCHEDULE ==========
        function renderTodaySchedule(date) {
            const scheduleContainer = document.getElementById('todaySchedule');
            if (!scheduleContainer) return;
            scheduleContainer.innerHTML = '';

            const todayStr = date.toISOString().split('T')[0];
            const serviciosHoy = servicios.filter(s => s.fecha === todayStr);

            const scheduleDateElement = document.getElementById('todayDate');
            if (scheduleDateElement) {
                scheduleDateElement.textContent = date.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            if (serviciosHoy.length === 0) {
                scheduleContainer.innerHTML = '<p style="text-align: center; color: #718096;">No hay servicios programados para hoy.</p>';
                return;
            }

            serviciosHoy.forEach(serv => {
                const nombreCliente = obtenerNombreCliente(serv);
                const nombreTecnico = obtenerNombreTecnico(serv);
                const nombreServicio = obtenerNombreServicio(serv);
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.innerHTML = `
                    <div class="schedule-time">${serv.hora ? serv.hora.substring(0, 5) : 'N/A'}</div>
                    <div class="schedule-details">
                        <div class="schedule-service">${nombreServicio}</div>
                        <div class="schedule-client">Cliente: ${nombreCliente}</div>
                        <div class="schedule-technician">T√©cnico: ${nombreTecnico}</div>
                    </div>
                `;
                scheduleContainer.appendChild(scheduleItem);
            });
        }

        // ========== NAVIGATION ==========
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
        }

        function showView(view) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            console.log('Mostrando vista:', view);
        }

// ========== MODAL FUNCTIONS ==========
function openAddServiceModal(date = null) {
    const serviceForm = document.getElementById('serviceForm');
    if (serviceForm) {
        serviceForm.reset();
    }
    // ‚úÖ CORREGIDO: Actualizar el t√≠tulo del modal
    const titleElement = document.getElementById('serviceModalTitle');
    if (titleElement) {
        titleElement.textContent = 'Programar Nuevo Servicio';
    }
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.textContent = 'Programar Servicio';
    }
    // ‚úÖ CORREGIDO: Poner la fecha si se pasa
    if (date) {
        const formattedDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
        const fechaInput = document.getElementById('fecha');
        if (fechaInput) {
            fechaInput.value = formattedDate;
        }
    }
    currentEditingId = null;
    isSubmitting = false;
    const addServiceModal = document.getElementById('addServiceModal');
    if (addServiceModal) {
        addServiceModal.classList.add('show');
    }
}
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        }

// Funci√≥n para agregar un nuevo servicio
async function addService(event) {
    event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    console.log('üîÑ INICIANDO PROCESO DE AGREGAR SERVICIO...');

    try {
        // Verificar autenticaci√≥n
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            throw new Error('No hay token de autenticaci√≥n. Por favor, inicie sesi√≥n nuevamente.');
        }

        // Obtener datos del formulario
        const formData = {
            dniCliente: document.getElementById('clienteId').value.trim(),
            dniEmpleadoAsignado: document.getElementById('tecnicoId').value.trim(),
            idTipoServicio: document.getElementById('tipoServicioId').value.trim(),
            fecha: document.getElementById('fecha').value,
            hora: document.getElementById('hora').value,
            observaciones: document.getElementById('observaciones').value.trim() || '',
            prioridad: document.getElementById('prioridad').value,
            estado: 'Programado',
            servicioSinCotizacion: true
        };

        console.log('üìã DATOS DEL FORMULARIO:', formData);

        // Validaciones
        const camposRequeridos = [
            { campo: 'Cliente', valor: formData.dniCliente },
            { campo: 'T√©cnico', valor: formData.dniEmpleadoAsignado },
            { campo: 'Tipo Servicio', valor: formData.idTipoServicio },
            { campo: 'Fecha', valor: formData.fecha },
            { campo: 'Hora', valor: formData.hora }
        ];

        const camposFaltantes = camposRequeridos.filter(c => !c.valor);
        if (camposFaltantes.length > 0) {
            throw new Error(`Campos obligatorios faltantes:\n${camposFaltantes.map(c => `‚Ä¢ ${c.campo}`).join('\n')}`);
        }

        // Validar fecha futura
        const fechaServicio = new Date(formData.fecha + 'T' + formData.hora);
        const ahora = new Date();
        if (fechaServicio < ahora) {
            throw new Error('No puede programar un servicio en fecha u hora pasada.');
        }

        // Preparar datos para enviar (asegurar formato correcto)
        const servicioData = {
            dniCliente: formData.dniCliente,
            dniEmpleadoAsignado: formData.dniEmpleadoAsignado,
            idTipoServicio: formData.idTipoServicio,
            fecha: formData.fecha,
            hora: formData.hora + ':00', // Asegurar formato HH:MM:SS
            estado: 'Programado',
            observaciones: formData.observaciones,
            prioridad: formData.prioridad,
            servicioSinCotizacion: true
        };

        console.log('üöÄ ENVIANDO AL BACKEND:', servicioData);

        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        // Hacer la petici√≥n
        const response = await fetch(`${API_BASE_URL}/servicios`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(servicioData)
        });

        console.log('üì® RESPUESTA DEL SERVIDOR:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });

        if (!response.ok) {
            let errorMessage = `Error ${response.status}: ${response.statusText}`;
            try {
                const errorData = await response.json();
                console.error('‚ùå ERROR DEL SERVIDOR:', errorData);
                errorMessage = errorData.message || errorData.error || JSON.stringify(errorData);
            } catch (e) {
                const errorText = await response.text();
                errorMessage = errorText || errorMessage;
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('‚úÖ SERVICIO CREADO EXITOSAMENTE:', result);

        showCustomAlert('Servicio programado exitosamente', '√âxito', 'success');
        closeModal('addServiceModal');
        
        // Recargar datos despu√©s de un breve delay
        setTimeout(async () => {
            console.log('üîÑ Recargando datos despu√©s de agregar servicio...');
            await loadAgendaData();
        }, 1500);

    } catch (error) {
        console.error('‚ùå ERROR COMPLETO AL CREAR SERVICIO:', error);
        showCustomAlert(`Error al crear servicio:\n\n${error.message}`, 'Error', 'error');
    } finally {
        isSubmitting = false;
    }
}

// Funci√≥n para diagnosticar por qu√© no se muestran los servicios
function diagnosticarProblemaVisualizacion() {
    console.log('üîç DIAGN√ìSTICO DE VISUALIZACI√ìN');
    console.log('üìÖ Fecha actual:', new Date().toLocaleDateString());
    console.log('üìÖ Calendario mostrando:', currentMonth + 1, currentYear);
    console.log('üìä Total servicios cargados:', servicios.length);
    
    if (servicios.length === 0) {
        console.log('‚ùå No hay servicios cargados en la variable servicios');
        return;
    }
    
    // Verificar cada servicio
    servicios.forEach((servicio, index) => {
        console.log(`\nüìã Servicio ${index + 1}: ${servicio.idServicio}`);
        console.log('   Fecha:', servicio.fecha);
        console.log('   Hora:', servicio.hora);
        console.log('   Estado:', servicio.estado);
        
        if (servicio.fecha) {
            const fechaServicio = new Date(servicio.fecha);
            console.log('   üìÖ Fecha parseada:', fechaServicio.toLocaleDateString());
            console.log('   üìÖ A√±o:', fechaServicio.getFullYear(), 'Mes:', fechaServicio.getMonth() + 1, 'D√≠a:', fechaServicio.getDate());
            
            // Verificar si coincide con el calendario actual
            const coincideMes = fechaServicio.getMonth() === currentMonth;
            const coincideA√±o = fechaServicio.getFullYear() === currentYear;
            console.log('   üìç Coincide con calendario actual:', coincideMes && coincideA√±o ? '‚úÖ S√ç' : '‚ùå NO');
            
            if (!(coincideMes && coincideA√±o)) {
                console.log('   üéØ El servicio est√° en un mes/a√±o diferente al mostrado');
            }
        } else {
            console.log('   ‚ùå SERVICIO SIN FECHA V√ÅLIDA');
        }
        
        // Verificar datos del cliente y t√©cnico
        try {
            const cliente = obtenerNombreCliente(servicio);
            const tecnico = obtenerNombreTecnico(servicio);
            console.log('   üë§ Cliente:', cliente);
            console.log('   üîß T√©cnico:', tecnico);
        } catch (error) {
            console.log('   ‚ùå Error obteniendo datos de persona:', error.message);
        }
    });
    
    // Verificar si el calendario se est√° renderizando correctamente
    const calendarGrid = document.getElementById('calendarGrid');
    if (calendarGrid) {
        const dias = calendarGrid.querySelectorAll('.calendar-day:not(.other-month)');
        console.log(`\nüìÜ Calendario: ${dias.length} d√≠as del mes actual renderizados`);
    }
}

function navegarAlMesCorrecto() {
    console.log('üìç Buscando mes con servicios...');
    
    if (servicios.length === 0) {
        console.log('üìÖ No hay servicios cargados, usando mes actual');
        const now = new Date();
        currentMonth = now.getMonth();
        currentYear = now.getFullYear();
        return;
    }
    
    // Encontrar todos los meses √∫nicos que tienen servicios
    const mesesConServicios = servicios
        .filter(s => s.fecha)
        .map(s => {
            const fecha = new Date(s.fecha);
            return {
                mes: fecha.getMonth(),
                a√±o: fecha.getFullYear(),
                fechaStr: fecha.toISOString().split('T')[0]
            };
        })
        .filter((item, index, self) => 
            index === self.findIndex(t => 
                t.mes === item.mes && t.a√±o === item.a√±o
            )
        );
    
    if (mesesConServicios.length === 0) {
        console.log('üìÖ No hay servicios con fecha v√°lida, usando mes actual');
        const now = new Date();
        currentMonth = now.getMonth();
        currentYear = now.getFullYear();
        return;
    }
    
    console.log('üìã Meses con servicios encontrados:', mesesConServicios);
    
    // Ordenar por fecha (m√°s reciente primero)
    mesesConServicios.sort((a, b) => {
        const dateA = new Date(a.a√±o, a.mes);
        const dateB = new Date(b.a√±o, b.mes);
        return dateB - dateA;
    });
    
    // Usar el mes m√°s reciente
    const mesReciente = mesesConServicios[0];
    console.log(`üìç Navegando al mes m√°s reciente: ${mesReciente.mes + 1}/${mesReciente.a√±o}`);
    
    currentMonth = mesReciente.mes;
    currentYear = mesReciente.a√±o;
}

// Llamar estas funciones despu√©s de cargar los datos
setTimeout(() => {
    diagnosticarProblemaVisualizacion();
    navegarAlMesCorrecto();
}, 2000);

        // ========== QUICK ADD SERVICE ==========
        async function quickAddService() {
            const dniCliente = document.getElementById('quickCliente').value.trim();
            const dniEmpleado = document.getElementById('quickTecnico').value.trim();
            const idTipoServicio = document.getElementById('quickTipoServicio').value.trim();
            const fecha = document.getElementById('quickFecha').value;
            const hora = document.getElementById('quickHora').value;
            
            const formData = {
                idServicio: null,
                idCotizacion: null,
                dniEmpleadoAsignado: dniEmpleado,
                dniCliente: dniCliente,
                fecha: fecha,
                hora: hora + ':00',
                estado: 'Programado', // Estado por defecto para r√°pido
                idTipoServicio: idTipoServicio,
                observaciones: document.getElementById('quickObservaciones').value.trim() || null,
                prioridad: document.getElementById('quickPrioridad').value
            };

            if (!formData.dniCliente || !formData.dniEmpleadoAsignado || !formData.idTipoServicio) {
                // alert('‚ùå Debe completar:\n‚Ä¢ Cliente\n‚Ä¢ T√©cnico\n‚Ä¢ Tipo de servicio');
                showCustomAlert('Debe completar:\n‚Ä¢ Cliente\n‚Ä¢ T√©cnico\n‚Ä¢ Tipo de servicio', 'Error', 'error');
                return;
            }

            if (!formData.fecha || !formData.hora) {
                // alert('‚ùå Debe completar la fecha y hora del servicio');
                showCustomAlert('Debe completar la fecha y hora del servicio', 'Error', 'error');
                return;
            }

            try {
                console.log('üì§ Creando servicio r√°pido:', formData);
                
                const response = await fetch(`${API_BASE_URL}/servicios`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData),
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('‚ùå Error del servidor:', errorData);
                    throw new Error(errorData || `Error ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Servicio creado exitosamente:', result);
                
                // alert('‚úÖ Servicio programado exitosamente.');
                showCustomAlert('Servicio programado exitosamente.', '√âxito', 'success');
                
                // Limpiar formulario
                ['quickCliente','quickTecnico','quickTipoServicio','quickFecha','quickHora','quickObservaciones'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.value = '';
                });
                const prioridadElem = document.getElementById('quickPrioridad');
                if (prioridadElem) prioridadElem.value = 'Normal';
                
                await loadAgendaData();
            } catch (error) {
                console.error('‚ùå Error al crear servicio r√°pido:', error);
                // alert(`‚ùå Error al crear servicio:\n\n${error.message}\n\nVerifique que todos los datos sean correctos.`);
                showCustomAlert(`Error al crear servicio:\n\n${error.message}\n\nVerifique que todos los datos sean correctos.`, 'Error', 'error');
            }
        }

        function exportSchedule() {
            console.log('üìä Exportando agenda...');
            // alert('Funci√≥n de exportaci√≥n en desarrollo');
            showCustomAlert('Funci√≥n de exportaci√≥n en desarrollo', 'Informaci√≥n', 'info');
        }

        // ========== EVENT LISTENERS ==========
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) modal.classList.remove('show');
            });
        }

document.getElementById('serviceForm').addEventListener('submit', function(event) {
    addService(event);
});
        document.getElementById('editServiceForm').addEventListener('submit', updateService);

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Iniciando aplicaci√≥n de Agenda...');
            console.log('üîó API Base URL:', API_BASE_URL);
            loadAgendaData();
        });

        // ========== FUNCIONES PARA MODAL DE ALERTA PERSONALIZADO ==========

        /**
         * Muestra un modal de alerta personalizado.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} [title='Informaci√≥n'] - El t√≠tulo del modal.
         * @param {string} [type='info'] - Tipo de alerta: 'info', 'success', 'warning', 'error'.
         */
        function showCustomAlert(message, title = 'Informaci√≥n', type = 'info') {
            const modal = document.getElementById('customAlertModal');
            const titleElement = document.getElementById('customAlertTitle');
            const messageElement = document.getElementById('customAlertMessage');
            const headerElement = modal.querySelector('.modal-custom-alert-header');
            const iconElement = modal.querySelector('.alert-icon');

            // Establecer t√≠tulo y mensaje
            titleElement.textContent = title;
            messageElement.textContent = message;

            // Establecer √≠cono y color del encabezado basado en el tipo
            iconElement.className = 'alert-icon'; // Resetear clases
            switch (type) {
                case 'success':
                    iconElement.classList.add('success');
                    iconElement.textContent = '‚úÖ';
                    headerElement.style.background = 'linear-gradient(135deg, #276749, #48bb78)';
                    break;
                case 'warning':
                    iconElement.classList.add('warning');
                    iconElement.textContent = '‚ö†Ô∏è';
                    headerElement.style.background = 'linear-gradient(135deg, #b7791f, #d69e2e)';
                    break;
                case 'error':
                    iconElement.classList.add('error');
                    iconElement.textContent = '‚ùå';
                    headerElement.style.background = 'linear-gradient(135deg, #c53030, #e53e3e)';
                    break;
                default: // info
                    iconElement.classList.add('info');
                    iconElement.textContent = '‚ÑπÔ∏è';
                    headerElement.style.background = 'linear-gradient(135deg, #2c5282, #4299e1)';
            }

            modal.classList.add('show');
        }

        /**
         * Cierra el modal de alerta personalizado.
         */
        function closeCustomAlert() {
            const modal = document.getElementById('customAlertModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Opcional: Cerrar el modal al hacer clic fuera del contenido
        document.getElementById('customAlertModal')?.addEventListener('click', function(event) {
            if (event.target === this) {
                closeCustomAlert();
            }
        });

    </script>
</body>
</html>