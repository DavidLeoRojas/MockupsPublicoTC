<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Gemini Ambiental Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #2c5f41, #1a4532);
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-icon {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text h2 {
            font-size: 1.2em;
            margin-bottom: 0.2rem;
        }
        .logo-text p {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .nav-menu {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0.5rem 1rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .logout-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-btn:hover {
            background: rgba(255,107,107,0.3);
            transform: translateY(-2px);
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        .top-nav {
            background: white;
            padding: 1rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs {
            display: flex;
            gap: 2rem;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #718096;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }
        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
            transform: translateY(-2px);
        }
        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            color: #2c5f41;
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }
        .header-title p {
            color: #718096;
            font-size: 1.1em;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        .btn-danger:hover {
            background: #ff5252;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85em;
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85em;
        }
        .btn-outline-primary {
            background: white;
            color: #4a8b64;
            border: 1px solid #4a8b64;
        }
        .btn-outline-primary:hover {
            background: #4a8b64;
            color: white;
        }
        .btn-outline-danger {
            background: white;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .btn-outline-danger:hover {
            background: #ff6b6b;
            color: white;
        }
        .calendar-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }
        .calendar-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .calendar-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c5f41;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #4a8b64;
            color: white;
        }
        .month-year {
            font-weight: 600;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }
        .calendar-container {
            padding: 2rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: #f7fafc;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .calendar-day:hover {
            background: #f7fafc;
        }
        .calendar-day.today {
            background: #e6fffa;
        }
        .calendar-day.other-month {
            background: #f7fafc;
            color: #a0aec0;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .day-events {
            font-size: 0.8em;
            max-height: 60px;
            overflow-y: auto;
        }
        .event-item {
            background: var(--event-color);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-bottom: 0.2rem;
            font-size: 0.7em;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.control-plagas { --event-color: #4a8b64; }
        .event-item.lavado-tanques { --event-color: #4299e1; }
        .event-item.inspeccion { --event-color: #f6ad55; }
        .event-item.seguimiento { --event-color: #9f7aea; }
        .sidebar-calendar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .today-schedule {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .schedule-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .schedule-date {
            color: #718096;
            font-size: 0.9em;
        }
        .schedule-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .schedule-time {
            min-width: 80px;
            font-weight: 600;
            color: #4a8b64;
            text-align: center;
            background: #f0fff4;
            border-radius: 8px;
            padding: 0.5rem;
        }
        .event-item.estado-cancelado {
            background-color: #e2e3e5; /* Gris claro */
            border-left: 4px solid #6c757d; /* Borde gris */
            opacity: 0.8;
            text-decoration: line-through;
        }

        .event-item.estado-cancelado .event-title,
        .event-item.estado-cancelado .event-time,
        .event-item.estado-cancelado .event-client {
            color: #6c757d; /* Texto gris */
        }
        .schedule-details {
            flex: 1;
        }
        .schedule-service {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .schedule-client {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .schedule-technician {
            color: #4a8b64;
            font-size: 0.8em;
        }
        .quick-add {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #4a8b64;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .service-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #4a8b64;
        }
        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        .service-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a8b64;
        }
        .service-time-large {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a8b64;
        }
        .service-actions {
            display: flex;
            gap: 0.5rem;
        }
        .service-card-body {
            margin-top: 1rem;
        }
        .service-info-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
        }
        .service-info-label {
            font-weight: 600;
            color: #4a5568;
        }
        .service-info-value {
            color: #2d3748;
        }
        .status-badge, .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .status-programado, .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        .status-en-progreso, .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }
        .status-completado, .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-cancelado, .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        .badge-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .calendar-layout {
                grid-template-columns: 1fr;
            }
            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            .form-grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">🌿</div>
                <div class="logo-text">
                    <h2>Gemini Admin</h2>
                    <p>Panel de Control</p>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">📊</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">📦</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link active">
                    <span class="nav-icon">📅</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">👥</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">💰</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link">
                    <span class="nav-icon">📄</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="servicios.html" class="nav-link">
                    <span class="nav-icon">🔧</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">🚪</span>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-nav">
            <div class="nav-tabs">
                <a class="nav-tab active" onclick="showView('calendar')">📅 Calendario</a>
                <a class="nav-tab" onclick="showView('list')">📋 Lista</a>
                <a class="nav-tab" onclick="showView('timeline')">⏰ Cronograma</a>
                <a class="nav-tab" onclick="showView('map')">🗺️ Mapa</a>
            </div>
            <div class="nav-actions">
                <select class="form-control" style="width: auto;" id="filterTecnico">
                    <option value="">Todos los técnicos</option>
                </select>
                <button class="btn btn-secondary">📊 Reportes</button>
            </div>
        </div>

        <div class="header">
            <div class="header-title">
                <h1>Agenda de Servicios</h1>
                <p>Programación y seguimiento de actividades</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="exportSchedule()">📤 Exportar</button>
                <button class="btn btn-primary" onclick="openAddServiceModal()">➕ Programar Servicio</button>
            </div>
        </div>

        <div class="calendar-layout">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 class="calendar-title">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‹</button>
                        <div class="month-year">Enero 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">›</button>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-header">Dom</div>
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mié</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header">Sáb</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-calendar">
                <div class="today-schedule">
                    <div class="schedule-header">
                        <h3 class="schedule-title">Agenda de Hoy</h3>
                        <div class="schedule-date" id="todayDate"></div>
                    </div>
                    <div id="todaySchedule"></div>
                </div>

                <div class="quick-add">
                    <h3 style="color: #2c5f41; margin-bottom: 1.5rem;">Programar Rápido</h3>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select class="form-control" id="quickCliente" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="quickTipoServicio" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="quickFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="quickHora" required>
                    </div>
                    <div class="form-group">
                        <label>Técnico *</label>
                        <select class="form-control" id="quickTecnico" required>
                            <option value="">Seleccionar técnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" id="quickObservaciones" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="quickPrioridad">
                            <option>Normal</option>
                            <option>Alta</option>
                            <option>Urgente</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="quickAddService()">Programar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de servicios del día -->
    <div class="modal" id="dayServicesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" id="dayServicesTitle">Servicios del Día</h2>
                <button class="close-btn" onclick="closeModal('dayServicesModal')">&times;</button>
            </div>
            <div id="dayServicesContent" style="max-height: 500px; overflow-y: auto;"></div>
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;">
                <button class="btn btn-primary" style="width: 100%;" onclick="openAddServiceModalFromDay()">
                    ➕ Agregar Otro Servicio en Esta Fecha
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de edición de servicio -->
    <div class="modal" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Servicio</h2>
                <button class="close-btn" onclick="closeModal('editServiceModal')">&times;</button>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="editClienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="editTipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Técnico *</label>
                        <select class="form-control" id="editTecnicoId" required>
                            <option value="">Seleccionar técnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="editFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="editHora" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select class="form-control" id="editPrioridad">
                        <option value="Normal">Normal</option>
                        <option value="Alta">Alta</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="editObservaciones" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="editEstado">
                        <option value="Programado">Programado</option>
                        <option value="En_Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de agregar servicio -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Programar Nuevo Servicio</h2>
                <button class="close-btn" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <form id="serviceForm">
                <div class="form-group">
                    <label>Cotización Origen (Opcional)</label>
                    <select class="form-control" id="cotizacionId">
                        <option value="">Seleccionar cotización</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="clienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="tipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Técnico *</label>
                        <select class="form-control" id="tecnicoId" required>
                            <option value="">Seleccionar técnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="fecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="hora" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Duración Estimada</label>
                        <input type="text" class="form-control" id="duracionEstimada" placeholder="Ej: 2 horas">
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="prioridad">
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="observaciones" rows="3" placeholder="Instrucciones especiales, materiales necesarios, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="estado">
                        <option value="Programado">Programado</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Programar Servicio</button>
                </div>
            </form>
        </div>
    </div>

<script>
const API_BASE_URL = 'http://localhost:8080/api';
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let servicios = [];
let todasLasPersonas = [];
let todosLosTiposServicio = [];
let cotizaciones = [];
let currentView = 'all';
let currentEditingId = null;
let isSubmitting = false;
let selectedDate = null; // Para recordar la fecha seleccionada

// ========== FUNCIONES AUXILIARES MEJORADAS ==========
function obtenerDNICliente(servicio) {
    // Intentar todas las variantes posibles
    if (servicio.cliente?.dni) return servicio.cliente.dni;
    if (servicio.dniCliente) return servicio.dniCliente;
    if (servicio.dni_cliente) return servicio.dni_cliente;
    if (servicio.DNI_cliente) return servicio.DNI_cliente;
    return null;
}

function obtenerDNITecnico(servicio) {
    if (servicio.empleadoAsignado?.dni) return servicio.empleadoAsignado.dni;
    if (servicio.dniEmpleadoAsignado) return servicio.dniEmpleadoAsignado;
    if (servicio.dni_empleado_asignado) return servicio.dni_empleado_asignado;
    if (servicio.DNI_empleado_asignado) return servicio.DNI_empleado_asignado;
    return null;
}

function obtenerIDTipoServicio(servicio) {
    if (servicio.tipoServicio?.idTipoServicio) return servicio.tipoServicio.idTipoServicio;
    if (servicio.idTipoServicio) return servicio.idTipoServicio;
    if (servicio.id_tipo_servicio) return servicio.id_tipo_servicio;
    if (servicio.ID_tipo_servicio) return servicio.ID_tipo_servicio;
    return null;
}

function obtenerNombreCliente(servicio) {
    console.log('🔍 Buscando cliente para servicio:', servicio);
    
    // Intento 1: Objeto completo
    if (servicio.cliente?.nombre) {
        console.log('✅ Cliente encontrado en objeto:', servicio.cliente.nombre);
        return servicio.cliente.nombre;
    }
    
    // Intento 2: Buscar por DNI
    const dniCliente = obtenerDNICliente(servicio);
    console.log('📝 DNI Cliente extraído:', dniCliente);
    
    if (dniCliente && todasLasPersonas.length > 0) {
        const cliente = todasLasPersonas.find(p => {
            const dniComparar = String(p.dni).trim();
            const dniBuscar = String(dniCliente).trim();
            return dniComparar === dniBuscar;
        });
        
        if (cliente) {
            console.log('✅ Cliente encontrado por DNI:', cliente.nombre);
            return cliente.nombre;
        }
        console.warn('⚠️ Cliente con DNI', dniCliente, 'NO encontrado en lista de', todasLasPersonas.length, 'personas');
    }
    
    console.error('❌ No se pudo obtener nombre del cliente');
    return '⚠️ Cliente no encontrado';
}

function obtenerNombreTecnico(servicio) {
    console.log('🔍 Buscando técnico para servicio:', servicio);
    
    if (servicio.empleadoAsignado?.nombre) {
        console.log('✅ Técnico encontrado en objeto:', servicio.empleadoAsignado.nombre);
        return servicio.empleadoAsignado.nombre;
    }
    
    const dniTecnico = obtenerDNITecnico(servicio);
    console.log('📝 DNI Técnico extraído:', dniTecnico);
    
    if (dniTecnico && todasLasPersonas.length > 0) {
        const tecnico = todasLasPersonas.find(p => {
            const dniComparar = String(p.dni).trim();
            const dniBuscar = String(dniTecnico).trim();
            return dniComparar === dniBuscar;
        });
        
        if (tecnico) {
            console.log('✅ Técnico encontrado por DNI:', tecnico.nombre);
            return tecnico.nombre;
        }
        console.warn('⚠️ Técnico con DNI', dniTecnico, 'NO encontrado en lista de', todasLasPersonas.length, 'personas');
    }
    
    console.error('❌ No se pudo obtener nombre del técnico');
    return '⚠️ Técnico no encontrado';
}

function obtenerNombreServicio(servicio) {
    console.log('🔍 Buscando tipo de servicio:', servicio);
    
    if (servicio.tipoServicio?.nombreServicio) {
        const costo = servicio.tipoServicio.costo || 0;
        console.log('✅ Tipo servicio encontrado en objeto:', servicio.tipoServicio.nombreServicio);
        return `${servicio.tipoServicio.nombreServicio} ($${costo.toLocaleString('es-CO')})`;
    }
    
    const idTipo = obtenerIDTipoServicio(servicio);
    console.log('📝 ID Tipo Servicio extraído:', idTipo);
    
    if (idTipo && todosLosTiposServicio.length > 0) {
        const tipo = todosLosTiposServicio.find(t => {
            return String(t.idTipoServicio) === String(idTipo);
        });
        
        if (tipo) {
            const costo = tipo.costo || 0;
            console.log('✅ Tipo servicio encontrado por ID:', tipo.nombreServicio);
            return `${tipo.nombreServicio} ($${costo.toLocaleString('es-CO')})`;
        }
        console.warn('⚠️ Tipo servicio con ID', idTipo, 'NO encontrado en lista de', todosLosTiposServicio.length, 'tipos');
    }
    
    console.error('❌ No se pudo obtener tipo de servicio');
    return '⚠️ Servicio Desconocido';
}

// ========== CARGA DE DATOS ==========
async function loadAgendaData() {
    console.log("🔄 Iniciando carga de datos de la agenda...");
    try {
        const [serviciosRes, personasRes, tiposServRes, cotizacionesRes] = await Promise.all([
            fetch(`${API_BASE_URL}/servicios`).then(r => {
                if (!r.ok) throw new Error('Error al cargar servicios');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/personas`).then(r => {
                if (!r.ok) throw new Error('Error al cargar personas');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/tipos-servicio`).then(r => {
                if (!r.ok) throw new Error('Error al cargar tipos de servicio');
                return r.json();
            }),
            fetch(`${API_BASE_URL}/cotizaciones`).then(r => {
                if (!r.ok) throw new Error('Error al cargar cotizaciones');
                return r.json();
            })
        ]);

        // Filtrar solo servicios que tienen una fecha válida
        servicios = Array.isArray(serviciosRes) ? serviciosRes.filter(s => s.fecha) : [];
        todasLasPersonas = Array.isArray(personasRes) ? personasRes : [];
        todosLosTiposServicio = Array.isArray(tiposServRes) ? tiposServRes : [];
        cotizaciones = Array.isArray(cotizacionesRes) ? cotizacionesRes : [];

        console.log(`✅ Datos cargados exitosamente:`);
        console.log(`   📋 ${servicios.length} servicios`);
        console.log(`   👥 ${todasLasPersonas.length} personas`);
        console.log(`   🛠️ ${todosLosTiposServicio.length} tipos de servicio`);
        console.log(`   💰 ${cotizaciones.length} cotizaciones`);

        // Mostrar datos de ejemplo
        if (servicios.length > 0) {
            console.log('📦 Ejemplo de servicio:', servicios[0]);
        }
        if (todasLasPersonas.length > 0) {
            console.log('👤 Ejemplo de persona:', todasLasPersonas[0]);
        }
        if (todosLosTiposServicio.length > 0) {
            console.log('🔧 Ejemplo de tipo servicio:', todosLosTiposServicio[0]);
        }

        populateClienteSelect(todasLasPersonas);
        populateTecnicoSelect(todasLasPersonas);
        populateTipoServicioSelect(todosLosTiposServicio);
        populateCotizacionSelect(cotizaciones);
        populateFilterTecnico(todasLasPersonas);
        renderCalendar(currentMonth, currentYear);
        renderTodaySchedule(new Date());
        
        console.log('✅ Inicialización completada');
    } catch (error) {
        console.error('❌ Error al cargar datos de agenda:', error);
        alert('Error al cargar la agenda: ' + error.message + '\n\nPor favor, verifique que el backend esté corriendo.');
    }
}

// ========== POPULATION FUNCTIONS ==========
function populateClienteSelect(personas) {
    const selects = ['clienteId', 'editClienteId', 'quickCliente'];
    const clientes = personas.filter(p => p.rol === 'Cliente');
    
    console.log(`📋 Poblando selects de clientes con ${clientes.length} clientes`);
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar cliente</option>';
        clientes.forEach(p => {
            const option = document.createElement('option');
            option.value = p.dni;
            option.textContent = p.nombre;
            select.appendChild(option);
        });
    });
}

function populateTecnicoSelect(personas) {
    const selects = ['tecnicoId', 'editTecnicoId', 'quickTecnico'];
    const tecnicos = personas.filter(p => p.rol === 'Empleado');
    
    console.log(`📋 Poblando selects de técnicos con ${tecnicos.length} empleados`);
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar técnico</option>';
        tecnicos.forEach(p => {
            const option = document.createElement('option');
            option.value = p.dni;
            option.textContent = p.nombre;
            select.appendChild(option);
        });
    });
}

function populateTipoServicioSelect(tipos) {
    const selects = ['tipoServicioId', 'editTipoServicioId', 'quickTipoServicio'];
    
    console.log(`📋 Poblando selects de tipos de servicio con ${tipos.length} tipos`);
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar tipo</option>';
        tipos.forEach(ts => {
            const option = document.createElement('option');
            option.value = ts.idTipoServicio;
            option.textContent = `${ts.nombreServicio} ($${ts.costo})`;
            select.appendChild(option);
        });
    });
}

function populateCotizacionSelect(cotizaciones) {
    const select = document.getElementById('cotizacionId');
    if (!select) return;
    select.innerHTML = '<option value="">Seleccionar cotización</option>';
    cotizaciones.filter(c => c.estado !== 'Rechazada' && c.estado !== 'Finalizada').forEach(c => {
        const option = document.createElement('option');
        option.value = c.idCotizacion;
        const clienteNombre = c.cliente?.nombre || 'Sin cliente';
        option.textContent = `#${c.idCotizacion} - ${clienteNombre} - ${c.descripcionProblema || 'Sin descripción'}`;
        select.appendChild(option);
    });
}

function populateFilterTecnico(personas) {
    const select = document.getElementById('filterTecnico');
    if (!select) return;
    select.innerHTML = '<option value="">Todos los técnicos</option>';
    personas.filter(p => p.rol === 'Empleado').forEach(p => {
        const option = document.createElement('option');
        option.value = p.dni;
        option.textContent = p.nombre;
        select.appendChild(option);
    });
}

// ========== RENDER CALENDAR ==========
function renderCalendar(month, year) {
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                       "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const monthYearElement = document.querySelector('.month-year');
    if (monthYearElement) {
        monthYearElement.textContent = `${monthNames[month]} ${year}`;
    }

    const calendarGrid = document.getElementById('calendarGrid');
    if (!calendarGrid) return;

    const headers = calendarGrid.querySelectorAll('.calendar-day-header');
    calendarGrid.innerHTML = '';
    headers.forEach(header => calendarGrid.appendChild(header));

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const totalDays = lastDay.getDate();
    const prevLastDay = new Date(year, month, 0).getDate();

    for (let i = startDay - 1; i >= 0; i--) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day other-month';
        dayElement.innerHTML = `<div class="day-number">${prevLastDay - i}</div>`;
        calendarGrid.appendChild(dayElement);
    }

    const today = new Date();
    for (let day = 1; day <= totalDays; day++) {
        const date = new Date(year, month, day);
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        if (date.getDate() === today.getDate() && 
            date.getMonth() === today.getMonth() && 
            date.getFullYear() === today.getFullYear()) {
            dayElement.classList.add('today');
        }
        dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events"></div>`;

        const serviciosDelDia = servicios.filter(s => {
            if (!s.fecha) return false;
            const fechaServicio = new Date(s.fecha + 'T00:00:00');
            return fechaServicio.getDate() === day && 
                   fechaServicio.getMonth() === month && 
                   fechaServicio.getFullYear() === year;
        });

        const eventsContainer = dayElement.querySelector('.day-events');
        serviciosDelDia.forEach(serv => {
            const eventElement = document.createElement('div');
            eventElement.className = `event-item ${getEventTypeClass(serv)}`;
            const nombreCliente = obtenerNombreCliente(serv);
            const primerNombre = nombreCliente.split(' ')[0];
            eventElement.textContent = `${serv.hora ? serv.hora.substring(0,5) : ''} ${primerNombre}`;
            eventElement.title = `${obtenerNombreServicio(serv)}\nCliente: ${nombreCliente}\nHora: ${serv.hora || 'No definida'}`;
            eventElement.addEventListener('click', (e) => {
                e.stopPropagation();
                showDayServices(date);
            });
            eventsContainer.appendChild(eventElement);
        });

        dayElement.addEventListener('click', () => showDayServices(date));
        calendarGrid.appendChild(dayElement);
    }

    const totalCells = 42;
    const remaining = totalCells - (startDay + totalDays);
    for (let day = 1; day <= remaining; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day other-month';
        dayElement.innerHTML = `<div class="day-number">${day}</div>`;
        calendarGrid.appendChild(dayElement);
    }
}

// ========== FUNCIONES DE ESTADO ==========
function getEstadoClass(estado) {
    const estadoNormalizado = String(estado).replace(/\s+/g, '_').toLowerCase();
    switch (estadoNormalizado) {
        case 'programado':
            return 'badge-info';
        case 'en_progreso':
        case 'en progreso':
            return 'badge-warning';
        case 'completado':
            return 'badge-success';
        case 'cancelado':
            return 'badge-danger';
        default:
            return 'badge-secondary';
    }
}

function getEventTypeClass(servicio) {
    const nombreServicio = obtenerNombreServicio(servicio).toLowerCase();
    if (nombreServicio.includes('fumig') || nombreServicio.includes('plaga') || nombreServicio.includes('control')) return 'control-plagas';
    if (nombreServicio.includes('tanque') || nombreServicio.includes('lavado')) return 'lavado-tanques';
    if (nombreServicio.includes('inspeccion') || nombreServicio.includes('inspección')) return 'inspeccion';
    if (nombreServicio.includes('seguimiento')) return 'seguimiento';
    return 'control-plagas';
}

// ========== SHOW DAY SERVICES ==========
function showDayServices(date) {
    selectedDate = date; // Guardar la fecha seleccionada
    
    const modal = document.getElementById('dayServicesModal');
    const title = document.getElementById('dayServicesTitle');
    const content = document.getElementById('dayServicesContent');

    const year = date.getFullYear();
    const month = date.getMonth();
    const day = date.getDate();

    const serviciosDelDia = servicios.filter(s => {
        if (!s.fecha) return false;
        const fechaServicio = new Date(s.fecha + 'T00:00:00');
        return fechaServicio.getDate() === day &&
               fechaServicio.getMonth() === month &&
               fechaServicio.getFullYear() === year;
    });

    const dateStr = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
    title.textContent = `Servicios del ${dateStr}`;

    console.log(`📅 Mostrando servicios del ${dateStr}:`, serviciosDelDia.length, 'servicios encontrados');

    if (serviciosDelDia.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #718096;">
                <div style="font-size: 3em; margin-bottom: 1rem;">📅</div>
                <p style="font-size: 1.1em; margin-bottom: 0.5rem;">No hay servicios programados para esta fecha</p>
                <p style="font-size: 0.9em;">Haga clic en el botón de abajo para programar uno</p>
            </div>
        `;
    } else {
        content.innerHTML = serviciosDelDia.map(serv => {
            const nombreCliente = obtenerNombreCliente(serv);
            const nombreTecnico = obtenerNombreTecnico(serv);
            const nombreServicio = obtenerNombreServicio(serv);
            const hora = serv.hora ? serv.hora.substring(0, 5) : 'No definida';

            return `<div class="service-card">
                <div class="service-card-header">
                    <span class="service-time">${hora}</span>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditServiceModal('${serv.idServicio}')">✏️ Editar</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelarServicio('${serv.idServicio}')">🗑️ Cancelar</button>
                    </div>
                </div>
                <div class="service-card-body">
                    <div class="service-info-row"><span class="service-info-label">Servicio:</span><span class="service-info-value">${nombreServicio}</span></div>
                    <div class="service-info-row"><span class="service-info-label">Cliente:</span><span class="service-info-value">${nombreCliente}</span></div>
                    <div class="service-info-row"><span class="service-info-label">Técnico:</span><span class="service-info-value">${nombreTecnico}</span></div>
                    <div class="service-info-row"><span class="service-info-label">Prioridad:</span><span class="service-info-value">${serv.prioridad || 'Normal'}</span></div>
                    <div class="service-info-row"><span class="service-info-label">Estado:</span><span class="service-info-value"><span class="badge ${getEstadoClass(serv.estado)}">${serv.estado || 'Programado'}</span></span></div>
                    ${serv.observaciones ? `<div class="service-info-row"><span class="service-info-label">Observaciones:</span><span class="service-info-value">${serv.observaciones}</span></div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    modal.classList.add('show');
}

// Función para abrir modal de agregar desde el día
function openAddServiceModalFromDay() {
    closeModal('dayServicesModal');
    openAddServiceModal(selectedDate);
}

// ========== EDIT SERVICE ==========
function openEditServiceModal(id) {
    console.log('🔍 Abriendo modal de edición para servicio:', id);
    
    const servicio = servicios.find(s => s.idServicio === id);
    if (!servicio) {
        console.error('❌ Servicio no encontrado');
        alert("Servicio no encontrado. Por favor, recargue la página.");
        return;
    }

    console.log('📋 Servicio a editar:', servicio);

    const dniCliente = obtenerDNICliente(servicio);
    const dniTecnico = obtenerDNITecnico(servicio);
    const idTipoServ = obtenerIDTipoServicio(servicio);

    console.log('📝 Valores extraídos:', { dniCliente, dniTecnico, idTipoServ });

    if (!dniCliente || !dniTecnico || !idTipoServ) {
        const faltantes = [];
        if (!dniCliente) faltantes.push('Cliente');
        if (!dniTecnico) faltantes.push('Técnico');
        if (!idTipoServ) faltantes.push('Tipo de servicio');
        
        alert(`⚠️ Este servicio tiene datos incompletos:\n\n• ${faltantes.join('\n• ')}\n\nPor favor, complete estos datos antes de guardar.`);
    }

    // Llenar formulario
    document.getElementById('editClienteId').value = dniCliente || '';
    document.getElementById('editTecnicoId').value = dniTecnico || '';
    document.getElementById('editTipoServicioId').value = idTipoServ || '';
    document.getElementById('editFecha').value = servicio.fecha || '';
    document.getElementById('editHora').value = servicio.hora ? servicio.hora.substring(0, 5) : '';
    document.getElementById('editPrioridad').value = servicio.prioridad || 'Normal';
    document.getElementById('editObservaciones').value = servicio.observaciones || '';
    document.getElementById('editEstado').value = servicio.estado ? servicio.estado.replace(' ', '_') : 'Programado';
    document.getElementById('editServiceId').value = servicio.idServicio;

    closeModal('dayServicesModal');
    document.getElementById('editServiceModal').classList.add('show');
    
    console.log('✅ Modal de edición abierto');
}

async function updateService(event) {
    event.preventDefault();
    
    if (isSubmitting) {
        console.log('⚠️ Ya hay una actualización en proceso');
        return;
    }
    
    isSubmitting = true;
    
    try {
        const servicioId = document.getElementById('editServiceId').value;
        
        console.log('🔄 Iniciando actualización del servicio:', servicioId);
        
        // --- VERIFICACIÓN ADICIONAL: Consultar al backend antes de actualizar ---
        const checkResponse = await fetch(`${API_BASE_URL}/servicios/${servicioId}`);
        if (!checkResponse.ok) {
            throw new Error(`El servicio con ID ${servicioId} no existe en el servidor.`);
        }
        // --- FIN VERIFICACIÓN ---
        
        const formData = {
            idServicio: servicioId,
            dniCliente: document.getElementById('editClienteId').value.trim(),
            dniEmpleadoAsignado: document.getElementById('editTecnicoId').value.trim(),
            idTipoServicio: document.getElementById('editTipoServicioId').value.trim(),
            fecha: document.getElementById('editFecha').value,
            hora: document.getElementById('editHora').value + ':00',
            observaciones: document.getElementById('editObservaciones').value.trim() || null,
            prioridad: document.getElementById('editPrioridad').value,
            estado: document.getElementById('editEstado').value.replace(' ', '_')
        };

        console.log('📤 Datos a enviar:', formData);

        if (!formData.dniCliente || !formData.dniEmpleadoAsignado || !formData.idTipoServicio) {
            const camposFaltantes = [];
            if (!formData.dniCliente) camposFaltantes.push('Cliente');
            if (!formData.dniEmpleadoAsignado) camposFaltantes.push('Técnico');
            if (!formData.idTipoServicio) camposFaltantes.push('Tipo de servicio');
            
            alert(`❌ Debe completar los siguientes campos obligatorios:\n\n• ${camposFaltantes.join('\n• ')}`);
            isSubmitting = false;
            return;
        }

        if (!formData.fecha || !formData.hora) {
            alert('❌ Debe completar la fecha y hora del servicio');
            isSubmitting = false;
            return;
        }

        const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Error del servidor:', errorText);
            throw new Error(errorText || `Error ${response.status}`);
        }

        console.log('✅ Servicio actualizado exitosamente');
        alert('✅ Servicio actualizado exitosamente');
        
        closeModal('editServiceModal');
        await loadAgendaData();
        
    } catch (error) {
        console.error('❌ Error:', error);
        alert(`❌ Error al actualizar servicio:\n\n${error.message}`);
    } finally {
        isSubmitting = false;
    }
}

// ========== CANCEL SERVICE ==========
async function cancelService(servicioId) {
    console.log('🗑️ Intentando cancelar servicio:', servicioId);
    
    if (!confirm('¿Está seguro de que desea cancelar este servicio?')) {
        return;
    }
    
    const servicio = servicios.find(s => s.idServicio === servicioId);
    if (!servicio) {
        alert('❌ Servicio no encontrado');
        await loadAgendaData();
        closeModal('dayServicesModal');
        return;
    }

    const dniCliente = obtenerDNICliente(servicio);
    const dniTecnico = obtenerDNITecnico(servicio);const idTipoServ = obtenerIDTipoServicio(servicio);

    if (!dniCliente || !dniTecnico || !idTipoServ) {
        alert('❌ Este servicio tiene datos incompletos y no puede ser cancelado.\n\nPor favor, complete los datos obligatorios primero usando "Editar".');
        return;
    }

    try {
        const servicioData = {
            dniCliente: dniCliente,
            dniEmpleadoAsignado: dniTecnico,
            idTipoServicio: idTipoServ,
            fecha: servicio.fecha,
            hora: servicio.hora,
            observaciones: servicio.observaciones,
            prioridad: servicio.prioridad || 'Normal',
            estado: 'Cancelado'
        };

        console.log('📤 Datos para cancelar:', servicioData);

        const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(servicioData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Error del servidor:', errorText);
            throw new Error(errorText || `Error ${response.status}`);
        }

        console.log('✅ Servicio cancelado exitosamente');
        alert('✅ Servicio cancelado exitosamente');
        
        closeModal('dayServicesModal');
        await loadAgendaData();
        
    } catch (error) {
        console.error('❌ Error:', error);
        alert(`❌ Error al cancelar servicio:\n\n${error.message}`);
    }
}

const cancelarServicio = cancelService;

// ========== RENDER TODAY SCHEDULE ==========
function renderTodaySchedule(date) {
    const scheduleContainer = document.getElementById('todaySchedule');
    if (!scheduleContainer) return;
    scheduleContainer.innerHTML = '';

    const todayStr = date.toISOString().split('T')[0];
    const serviciosHoy = servicios.filter(s => s.fecha === todayStr);

    const scheduleDateElement = document.getElementById('todayDate');
    if (scheduleDateElement) {
        scheduleDateElement.textContent = date.toLocaleDateString('es-ES', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
    }

    if (serviciosHoy.length === 0) {
        scheduleContainer.innerHTML = '<p style="text-align: center; color: #718096;">No hay servicios programados para hoy.</p>';
        return;
    }

    serviciosHoy.forEach(serv => {
        const nombreCliente = obtenerNombreCliente(serv);
        const nombreTecnico = obtenerNombreTecnico(serv);
        const nombreServicio = obtenerNombreServicio(serv);
        const scheduleItem = document.createElement('div');
        scheduleItem.className = 'schedule-item';
        scheduleItem.innerHTML = `
            <div class="schedule-time">${serv.hora ? serv.hora.substring(0, 5) : 'N/A'}</div>
            <div class="schedule-details">
                <div class="schedule-service">${nombreServicio}</div>
                <div class="schedule-client">Cliente: ${nombreCliente}</div>
                <div class="schedule-technician">Técnico: ${nombreTecnico}</div>
            </div>
        `;
        scheduleContainer.appendChild(scheduleItem);
    });
}

// ========== NAVIGATION ==========
function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar(currentMonth, currentYear);
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar(currentMonth, currentYear);
}

function showView(view) {
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    console.log('Mostrando vista:', view);
}

// ========== MODAL FUNCTIONS ==========
function openAddServiceModal(date) {
    document.getElementById('addServiceModal').classList.add('show');
    if (date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        document.getElementById('fecha').value = dateStr;
        console.log('📅 Fecha preseleccionada:', dateStr);
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    const form = document.getElementById(modalId).querySelector('form');
    if (form) form.reset();
}

// ========== ADD SERVICE ==========
async function addService(event) {
    event.preventDefault();
    
    const dniCliente = document.getElementById('clienteId').value.trim();
    const dniEmpleado = document.getElementById('tecnicoId').value.trim();
    const idTipoServicio = document.getElementById('tipoServicioId').value.trim();
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const idCotizacion = document.getElementById('cotizacionId').value.trim();
    
    const formData = {
        idServicio: null,
        idCotizacion: idCotizacion || null,
        dniEmpleadoAsignado: dniEmpleado,
        dniCliente: dniCliente,
        fecha: fecha,
        hora: hora + ':00',
        estado: (document.getElementById('estado').value || 'Programado').replace(' ', '_'),
        idTipoServicio: idTipoServicio,
        duracionEstimada: document.getElementById('duracionEstimada').value.trim() || null,
        observaciones: document.getElementById('observaciones').value.trim() || null,
        prioridad: document.getElementById('prioridad').value
    };

    if (!formData.dniCliente || !formData.dniEmpleadoAsignado || !formData.idTipoServicio) {
        alert('❌ Debe completar los campos obligatorios:\n• Cliente\n• Técnico\n• Tipo de servicio');
        return;
    }

    if (!formData.fecha || !formData.hora) {
        alert('❌ Debe completar la fecha y hora del servicio');
        return;
    }

    try {
        console.log('📤 Creando nuevo servicio:', formData);
        
        const response = await fetch(`${API_BASE_URL}/servicios`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Error del servidor:', errorText);
            throw new Error(errorText || `Error ${response.status}`);
        }
        
        const result = await response.json();
        console.log('✅ Servicio creado exitosamente:', result);
        
        alert('✅ Servicio programado exitosamente!');
        closeModal('addServiceModal');
        event.target.reset();
        await loadAgendaData();
        
        // Si hay una fecha seleccionada, reabrir el modal del día
        if (selectedDate) {
            setTimeout(() => showDayServices(selectedDate), 300);
        }
    } catch (error) {
        console.error("❌ Error al crear servicio:", error);
        alert(`❌ Error al crear servicio:\n\n${error.message}\n\nNo se puede crear un servicio en una fecha pasada.`);
    }
}

// ========== QUICK ADD SERVICE ==========
async function quickAddService() {
    const dniCliente = document.getElementById('quickCliente').value.trim();
    const dniEmpleado = document.getElementById('quickTecnico').value.trim();
    const idTipoServicio = document.getElementById('quickTipoServicio').value.trim();
    const fecha = document.getElementById('quickFecha').value;
    const hora = document.getElementById('quickHora').value;
    
    const formData = {
        idServicio: null,
        idCotizacion: null,
        dniEmpleadoAsignado: dniEmpleado,
        dniCliente: dniCliente,
        fecha: fecha,
        hora: hora + ':00',
        estado: 'Programado',
        idTipoServicio: idTipoServicio,
        observaciones: document.getElementById('quickObservaciones').value.trim() || null,
        prioridad: document.getElementById('quickPrioridad').value
    };

    if (!formData.dniCliente || !formData.dniEmpleadoAsignado || !formData.idTipoServicio) {
        alert('❌ Debe completar:\n• Cliente\n• Técnico\n• Tipo de servicio');
        return;
    }

    if (!formData.fecha || !formData.hora) {
        alert('❌ Debe completar la fecha y hora del servicio');
        return;
    }

    try {
        console.log('📤 Creando servicio rápido:', formData);
        
        const response = await fetch(`${API_BASE_URL}/servicios`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData),
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            console.error('❌ Error del servidor:', errorData);
            throw new Error(errorData || `Error ${response.status}`);
        }
        
        const result = await response.json();
        console.log('✅ Servicio creado exitosamente:', result);
        
        alert('✅ Servicio programado exitosamente.');
        
        // Limpiar formulario
        ['quickCliente','quickTecnico','quickTipoServicio','quickFecha','quickHora','quickObservaciones'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) elem.value = '';
        });
        const prioridadElem = document.getElementById('quickPrioridad');
        if (prioridadElem) prioridadElem.value = 'Normal';
        
        await loadAgendaData();
    } catch (error) {
        console.error('❌ Error al crear servicio rápido:', error);
        alert(`❌ Error al crear servicio:\n\n${error.message}\n\nVerifique que todos los datos sean correctos.`);
    }
}

function exportSchedule() {
    console.log('📊 Exportando agenda...');
    alert('Función de exportación en desarrollo');
}

// ========== EVENT LISTENERS ==========
window.onclick = function(event) {
    document.querySelectorAll('.modal').forEach(modal => {
        if (event.target === modal) modal.classList.remove('show');
    });
}

document.getElementById('serviceForm').addEventListener('submit', addService);
document.getElementById('editServiceForm').addEventListener('submit', updateService);

document.addEventListener('DOMContentLoaded', function () {
    console.log('🚀 Iniciando aplicación de Agenda...');
    console.log('🔗 API Base URL:', API_BASE_URL);
    loadAgendaData();
});
</script>
</body>
</html>