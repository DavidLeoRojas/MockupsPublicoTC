<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Gemini Ambiental Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #2c5f41, #1a4532);
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-icon {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text h2 {
            font-size: 1.2em;
            margin-bottom: 0.2rem;
        }
        .logo-text p {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .nav-menu {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0.5rem 1rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .logout-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-btn:hover {
            background: rgba(255,107,107,0.3);
            transform: translateY(-2px);
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        .top-nav {
            background: white;
            padding: 1rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs {
            display: flex;
            gap: 2rem;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #718096;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }
        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
            transform: translateY(-2px);
        }
        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            color: #2c5f41;
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }
        .header-title p {
            color: #718096;
            font-size: 1.1em;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        .btn-danger:hover {
            background: #ff5252;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85em;
        }
        .calendar-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }
        .calendar-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .calendar-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c5f41;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #4a8b64;
            color: white;
        }
        .month-year {
            font-weight: 600;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }
        .calendar-container {
            padding: 2rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: #f7fafc;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .calendar-day:hover {
            background: #f7fafc;
        }
        .calendar-day.today {
            background: #e6fffa;
        }
        .calendar-day.other-month {
            background: #f7fafc;
            color: #a0aec0;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .day-events {
            font-size: 0.8em;
            max-height: 60px;
            overflow-y: auto;
        }
        .event-item {
            background: var(--event-color);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-bottom: 0.2rem;
            font-size: 0.7em;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.control-plagas { --event-color: #4a8b64; }
        .event-item.lavado-tanques { --event-color: #4299e1; }
        .event-item.inspeccion { --event-color: #f6ad55; }
        .event-item.seguimiento { --event-color: #9f7aea; }
        .sidebar-calendar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .today-schedule {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .schedule-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .schedule-date {
            color: #718096;
            font-size: 0.9em;
        }
        .schedule-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .schedule-time {
            min-width: 80px;
            font-weight: 600;
            color: #4a8b64;
            text-align: center;
            background: #f0fff4;
            border-radius: 8px;
            padding: 0.5rem;
        }
        .schedule-details {
            flex: 1;
        }
        .schedule-service {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .schedule-client {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .schedule-technician {
            color: #4a8b64;
            font-size: 0.8em;
        }
        .quick-add {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #4a8b64;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .service-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #4a8b64;
        }
        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        .service-time-large {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a8b64;
        }
        .service-actions {
            display: flex;
            gap: 0.5rem;
        }
        .service-info-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
        }
        .service-info-label {
            font-weight: 600;
            color: #4a5568;
        }
        .service-info-value {
            color: #2d3748;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .status-programado {
            background: #bee3f8;
            color: #2c5282;
        }
        .status-en-progreso {
            background: #feebc8;
            color: #7c2d12;
        }
        .status-completado {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-cancelado {
            background: #fed7d7;
            color: #742a2a;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .calendar-layout {
                grid-template-columns: 1fr;
            }
            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            .form-grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üåø</div>
                <div class="logo-text">
                    <h2>Gemini Admin</h2>
                    <p>Panel de Control</p>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">üì¶</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link active">
                    <span class="nav-icon">üìÖ</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">üí∞</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="servicios.html" class="nav-link">
                    <span class="nav-icon">üîß</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-nav">
            <div class="nav-tabs">
                <a class="nav-tab active" onclick="showView('calendar')">üìÖ Calendario</a>
                <a class="nav-tab" onclick="showView('list')">üìã Lista</a>
                <a class="nav-tab" onclick="showView('timeline')">‚è∞ Cronograma</a>
                <a class="nav-tab" onclick="showView('map')">üó∫Ô∏è Mapa</a>
            </div>
            <div class="nav-actions">
                <select class="form-control" style="width: auto;" id="filterTecnico">
                    <option value="">Todos los t√©cnicos</option>
                </select>
                <button class="btn btn-secondary">üìä Reportes</button>
            </div>
        </div>

        <div class="header">
            <div class="header-title">
                <h1>Agenda de Servicios</h1>
                <p>Programaci√≥n y seguimiento de actividades</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="exportSchedule()">üì§ Exportar</button>
                <button class="btn btn-primary" onclick="openAddServiceModal()">‚ûï Programar Servicio</button>
            </div>
        </div>

        <div class="calendar-layout">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 class="calendar-title">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <div class="month-year">Enero 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-header">Dom</div>
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mi√©</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header">S√°b</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-calendar">
                <div class="today-schedule">
                    <div class="schedule-header">
                        <h3 class="schedule-title">Agenda de Hoy</h3>
                        <div class="schedule-date" id="todayDate"></div>
                    </div>
                    <div id="todaySchedule"></div>
                </div>

                <div class="quick-add">
                    <h3 style="color: #2c5f41; margin-bottom: 1.5rem;">Programar R√°pido</h3>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select class="form-control" id="quickCliente" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="quickTipoServicio" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="quickFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="quickHora" required>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="quickTecnico" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" id="quickObservaciones" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="quickPrioridad">
                            <option>Normal</option>
                            <option>Alta</option>
                            <option>Urgente</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="quickAddService()">Programar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de servicios del d√≠a -->
    <div class="modal" id="dayServicesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dayServicesTitle">Servicios del D√≠a</h2>
                <button class="close-btn" onclick="closeModal('dayServicesModal')">&times;</button>
            </div>
            <div id="dayServicesContent" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal de edici√≥n de servicio -->
    <div class="modal" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Servicio</h2>
                <button class="close-btn" onclick="closeModal('editServiceModal')">&times;</button>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="editClienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="editTipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="editTecnicoId" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="editFecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="editHora" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select class="form-control" id="editPrioridad">
                        <option value="Normal">Normal</option>
                        <option value="Alta">Alta</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="editObservaciones" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="editEstado">
                        <option value="Programado">Programado</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de agregar servicio -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Programar Nuevo Servicio</h2>
                <button class="close-btn" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <form id="serviceForm">
                <div class="form-group">
                    <label>Cotizaci√≥n Origen (Opcional)</label>
                    <select class="form-control" id="cotizacionId">
                        <option value="">Seleccionar cotizaci√≥n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="clienteId" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="tipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico *</label>
                        <select class="form-control" id="tecnicoId" required>
                            <option value="">Seleccionar t√©cnico</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="fecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora *</label>
                        <input type="time" class="form-control" id="hora" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Duraci√≥n Estimada</label>
                        <input type="text" class="form-control" id="duracionEstimada" placeholder="Ej: 2 horas">
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="prioridad">
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="observaciones" rows="3" placeholder="Instrucciones especiales, materiales necesarios, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="estado">
                        <option value="Programado">Programado</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Programar Servicio</button>
                </div>
            </form>
        </div>
    </div>

<script>
    const API_BASE_URL = 'http://localhost:8080/api';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let servicios = [];
    let personas = [];
    let tiposServicio = [];
    let cotizaciones = [];

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // ========== FUNCIONES AUXILIARES PARA VINCULACI√ìN ==========
    function buscarPersonaPorDNI(dni) {
        if (!dni) return null;
        const dniStr = String(dni).trim();
        return personas.find(p => String(p.dni).trim() === dniStr);
    }

    function obtenerNombreCliente(servicio) {
        let dniCliente = null;

        // 1. Buscar desde campo directo
        if (servicio.dniCliente) {
            dniCliente = servicio.dniCliente;
        }

        // 2. Si no, buscar desde cotizaci√≥n si existe
        if (!dniCliente && servicio.cotizacion && servicio.cotizacion.dniCliente) {
            dniCliente = servicio.cotizacion.dniCliente;
        }

        if (!dniCliente) return 'Sin asignar';

        const cliente = buscarPersonaPorDNI(dniCliente);
        return cliente ? cliente.nombre : `DNI: ${dniCliente}`;
    }

    function obtenerNombreTecnico(servicio) {
        let dniTecnico = null;

        // 1. Buscar desde campo directo
        if (servicio.dniEmpleadoAsignado) {
            dniTecnico = servicio.dniEmpleadoAsignado;
        }

        if (!dniTecnico) return 'Sin asignar';

        const tecnico = buscarPersonaPorDNI(dniTecnico);
        return tecnico ? tecnico.nombre : `DNI: ${dniTecnico}`;
    }

    function obtenerNombreServicio(servicio) {
        let idTipoServicio = null;

        // 1. Buscar desde campo directo
        if (servicio.idTipoServicio) {
            idTipoServicio = servicio.idTipoServicio;
        }

        if (!idTipoServicio) return 'Servicio';

        const tipo = tiposServicio.find(ts => ts.idTipoServicio == idTipoServicio);
        return tipo ? tipo.nombreServicio : 'Servicio';
    }

    // ========== CARGA DE DATOS ==========
    async function loadAgendaData() {
        console.log("üîÑ Iniciando carga de datos de la agenda...");
        try {
            const [serviciosRes, personasRes, tiposServRes, cotizacionesRes] = await Promise.all([
                fetch(`${API_BASE_URL}/servicios`).then(r => r.json()),
                fetch(`${API_BASE_URL}/personas`).then(r => r.json()),
                fetch(`${API_BASE_URL}/tipos-servicio`).then(r => r.json()),
                fetch(`${API_BASE_URL}/cotizaciones`).then(r => r.json())
            ]);

            servicios = serviciosRes;
            personas = personasRes;
            tiposServicio = tiposServRes;
            cotizaciones = cotizacionesRes;

            console.log("‚úÖ Datos cargados:", { 
                servicios: servicios.length, 
                personas: personas.length, 
                tipos: tiposServicio.length,
                cotizaciones: cotizaciones.length
            });

            populateClienteSelect(personas);
            populateTecnicoSelect(personas);
            populateTipoServicioSelect(tiposServicio);
            populateCotizacionSelect(cotizaciones);
            populateFilterTecnico(personas);
            populateQuickCliente(personas);
            populateQuickTipoServicio(tiposServicio);
            populateQuickTecnico(personas);
            renderCalendar(currentMonth, currentYear);
            renderTodaySchedule(new Date());

        } catch (error) {
            console.error('‚ùå Error al cargar datos de agenda:', error);
            alert('Error al cargar la agenda. Por favor, recargue la p√°gina.');
        }
    }

    // ========== POPULATION FUNCTIONS ==========
    function populateClienteSelect(personas) {
        const selects = ['clienteId', 'editClienteId', 'quickCliente'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            personas.filter(p => p.rol === 'Cliente').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        });
    }

    function populateTecnicoSelect(personas) {
        const selects = ['tecnicoId', 'editTecnicoId', 'quickTecnico'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar t√©cnico</option>';
            personas.filter(p => p.rol === 'Empleado').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        });
    }

    function populateTipoServicioSelect(tipos) {
        const selects = ['tipoServicioId', 'editTipoServicioId', 'quickTipoServicio']; // Aseg√∫rate de que estos IDs coincidan con tus <select>
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar tipo</option>';
            tipos.forEach(ts => {
                const option = document.createElement('option');
                // CAMBIO AQU√ç: El VALUE ahora es el ID num√©rico
                option.value = ts.id_tipo_servicio; // <--- AQU√ç
                // El TEXT CONTENT sigue siendo la descripci√≥n para el usuario
                option.textContent = `${ts.nombre_servicio} ($${ts.costo})`; // <--- AQU√ç
                select.appendChild(option);
            });
        });
    }

    function populateCotizacionSelect(cotizaciones) {
        const select = document.getElementById('cotizacionId');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar cotizaci√≥n</option>';
        cotizaciones.forEach(c => {
            const option = document.createElement('option');
            option.value = c.idCotizacion;
            option.textContent = `#${c.idCotizacion} - ${c.descripcionProblema || 'Sin descripci√≥n'}`;
            select.appendChild(option);
        });
    }

    function populateFilterTecnico(personas) {
        const select = document.getElementById('filterTecnico');
        if (!select) return;
        select.innerHTML = '<option value="">Todos los t√©cnicos</option>';
        personas.filter(p => p.rol === 'Empleado').forEach(p => {
            const option = document.createElement('option');
            option.value = p.dni;
            option.textContent = p.nombre;
            select.appendChild(option);
        });
    }

    function populateQuickCliente(personas) {
        const select = document.getElementById('quickCliente');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar cliente</option>';
        personas.filter(p => p.rol === 'Cliente').forEach(p => {
            const option = document.createElement('option');
            option.value = p.dni;
            option.textContent = p.nombre;
            select.appendChild(option);
        });
    }

    function populateQuickTipoServicio(tipos) {
        const select = document.getElementById('quickTipoServicio');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar tipo</option>';
        tipos.forEach(ts => {
            const option = document.createElement('option');
            option.value = ts.idTipoServicio;
            option.textContent = ts.nombreServicio;
            select.appendChild(option);
        });
    }

    function populateQuickTecnico(personas) {
        const select = document.getElementById('quickTecnico');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccionar t√©cnico</option>';
        personas.filter(p => p.rol === 'Empleado').forEach(p => {
            const option = document.createElement('option');
            option.value = p.dni;
            option.textContent = p.nombre;
            select.appendChild(option);
        });
    }

    // ========== RENDER CALENDAR ==========
    function renderCalendar(month, year) {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                           "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const monthYearElement = document.querySelector('.month-year');
        if (monthYearElement) {
            monthYearElement.textContent = `${monthNames[month]} ${year}`;
        }

        const calendarGrid = document.getElementById('calendarGrid');
        if (!calendarGrid) return;

        const headers = calendarGrid.querySelectorAll('.calendar-day-header');
        calendarGrid.innerHTML = '';
        headers.forEach(header => calendarGrid.appendChild(header));

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay();
        const totalDays = lastDay.getDate();
        const prevLastDay = new Date(year, month, 0).getDate();

        for (let i = startDay - 1; i >= 0; i--) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `<div class="day-number">${prevLastDay - i}</div>`;
            calendarGrid.appendChild(dayElement);
        }

        const today = new Date();
        for (let day = 1; day <= totalDays; day++) {
            const date = new Date(year, month, day);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            if (date.getDate() === today.getDate() && 
                date.getMonth() === today.getMonth() && 
                date.getFullYear() === today.getFullYear()) {
                dayElement.classList.add('today');
            }
            dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events"></div>`;

            const serviciosDelDia = servicios.filter(s => {
                if (!s.fecha) return false;
                const fechaServicio = new Date(s.fecha + 'T00:00:00');
                return fechaServicio.getDate() === day && 
                       fechaServicio.getMonth() === month && 
                       fechaServicio.getFullYear() === year;
            });

            const eventsContainer = dayElement.querySelector('.day-events');
            serviciosDelDia.forEach(serv => {
                const eventElement = document.createElement('div');
                eventElement.className = `event-item ${getEventTypeClass(serv)}`;
                const nombreCliente = obtenerNombreCliente(serv);
                const nombreServicio = obtenerNombreServicio(serv);
                const primerNombre = nombreCliente.split(' ')[0];
                eventElement.textContent = `${primerNombre}`;
                eventElement.title = `${nombreServicio}\nCliente: ${nombreCliente}\nHora: ${serv.hora || 'No definida'}`;
                eventElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDayServices(date);
                });
                eventsContainer.appendChild(eventElement);
            });

            dayElement.addEventListener('click', () => showDayServices(date));
            calendarGrid.appendChild(dayElement);
        }

        const totalCells = 42;
        const remaining = totalCells - (startDay + totalDays);
        for (let day = 1; day <= remaining; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day other-month';
            dayElement.innerHTML = `<div class="day-number">${day}</div>`;
            calendarGrid.appendChild(dayElement);
        }
    }

    function getEventTypeClass(servicio) {
        const nombreServicio = obtenerNombreServicio(servicio).toLowerCase();
        if (nombreServicio.includes('plaga') || nombreServicio.includes('control')) return 'control-plagas';
        if (nombreServicio.includes('tanque') || nombreServicio.includes('lavado')) return 'lavado-tanques';
        if (nombreServicio.includes('inspeccion')) return 'inspeccion';
        if (nombreServicio.includes('seguimiento')) return 'seguimiento';
        return 'control-plagas';
    }

    // ========== SHOW DAY SERVICES ==========
    function showDayServices(date) {
        const modal = document.getElementById('dayServicesModal');
        const title = document.getElementById('dayServicesTitle');
        const content = document.getElementById('dayServicesContent');

        const year = date.getFullYear();
        const month = date.getMonth();
        const day = date.getDate();

        const serviciosDelDia = servicios.filter(s => {
            if (!s.fecha) return false;
            const fechaServicio = new Date(s.fecha + 'T00:00:00');
            return fechaServicio.getDate() === day && 
                   fechaServicio.getMonth() === month && 
                   fechaServicio.getFullYear() === year;
        });

        const monthStr = String(month + 1).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const dateStr = `${year}-${monthStr}-${dayStr}`;

        title.textContent = `Servicios del ${date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`;

        if (serviciosDelDia.length === 0) {
            content.innerHTML = `
                <p style="text-align: center; color: #718096; padding: 2rem;">
                    No hay servicios programados para esta fecha.
                </p>
                <button class="btn btn-primary" style="width: 100%;" onclick="closeModal('dayServicesModal'); openAddServiceModal(new Date('${dateStr}'))">
                    ‚ûï Programar Servicio
                </button>
            `;
        } else {
            content.innerHTML = serviciosDelDia.map(serv => {
                const nombreCliente = obtenerNombreCliente(serv);
                const nombreTecnico = obtenerNombreTecnico(serv);
                const nombreServicio = obtenerNombreServicio(serv);
                const estadoClass = serv.estado ? `status-${serv.estado.toLowerCase().replace(/\s+/g, '-')}` : 'status-programado';
                return `
                    <div class="service-card">
                        <div class="service-card-header">
                            <div class="service-time-large">${serv.hora || 'Sin hora'}</div>
                            <div class="service-actions">
                                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openEditServiceModal('${serv.idServicio}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); cancelService('${serv.idServicio}')">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">Servicio:</span>
                            <span class="service-info-value">${nombreServicio}</span>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">Cliente:</span>
                            <span class="service-info-value">${nombreCliente}</span>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">T√©cnico:</span>
                            <span class="service-info-value">${nombreTecnico}</span>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">Prioridad:</span>
                            <span class="service-info-value">${serv.prioridad || 'Normal'}</span>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">Estado:</span>
                            <span class="status-badge ${estadoClass}">${serv.estado || 'Programado'}</span>
                        </div>
                        ${serv.observaciones ? `
                        <div class="service-info-row">
                            <span class="service-info-label">Observaciones:</span>
                            <span class="service-info-value">${serv.observaciones}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            content.innerHTML += `
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="closeModal('dayServicesModal'); openAddServiceModal(new Date('${dateStr}'))">
                    ‚ûï Agregar Otro Servicio
                </button>
            `;
        }

        modal.classList.add('show');
    }

    // ========== EDIT SERVICE ==========
    async function openEditServiceModal(servicioId) {
        const servicio = servicios.find(s => s.idServicio === servicioId);
        if (!servicio) return;

        closeModal('dayServicesModal');
        document.getElementById('editServiceId').value = servicio.idServicio;
        document.getElementById('editClienteId').value = servicio.dniCliente || '';
        document.getElementById('editTecnicoId').value = servicio.dniEmpleadoAsignado || '';
        document.getElementById('editTipoServicioId').value = servicio.idTipoServicio || '';
        document.getElementById('editFecha').value = servicio.fecha || '';
        document.getElementById('editHora').value = servicio.hora || '';
        document.getElementById('editPrioridad').value = servicio.prioridad || 'Normal';
        document.getElementById('editObservaciones').value = servicio.observaciones || '';
        document.getElementById('editEstado').value = servicio.estado || 'Programado';
        document.getElementById('editServiceModal').classList.add('show');
    }

    async function updateService(event) {
        event.preventDefault();
        const servicioId = document.getElementById('editServiceId').value;
        const servicioData = {
            id_servicio: servicioId,
            dni_cliente: document.getElementById('editClienteId').value,
            dni_empleado_asignado: document.getElementById('editTecnicoId').value,
            id_tipo_servicio: document.getElementById('editTipoServicioId').value,
            fecha: document.getElementById('editFecha').value,
            hora: document.getElementById('editHora').value,
            observaciones: document.getElementById('editObservaciones').value || null,
            prioridad: document.getElementById('editPrioridad').value,
            estado: document.getElementById('editEstado').value
        };

        const fechaServicio = new Date(servicioData.fecha);
        const fechaActual = new Date();
        fechaActual.setHours(0, 0, 0, 0);
        if (fechaServicio < fechaActual && servicioData.estado === 'Programado') {
            alert('No se puede programar un servicio en una fecha pasada');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(servicioData)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Error al actualizar servicio');
            }
            closeModal('editServiceModal');
            await loadAgendaData();
            alert('‚úÖ Servicio actualizado exitosamente');
        } catch (error) {
            console.error("Error:", error);
            alert(`‚ùå Error al actualizar servicio: ${error.message}`);
        }
    }

    // ========== CANCEL SERVICE ==========
    async function cancelService(servicioId) {
        if (!confirm('¬øEst√° seguro de que desea cancelar este servicio?')) {
            return;
        }
        try {
            const servicio = servicios.find(s => s.idServicio === servicioId);
            if (!servicio) throw new Error('Servicio no encontrado');

            const servicioData = {
                id_servicio: servicio.idServicio,
                dni_cliente: servicio.dniCliente,
                dni_empleado_asignado: servicio.dniEmpleadoAsignado,
                id_tipo_servicio: servicio.idTipoServicio,
                fecha: servicio.fecha,
                hora: servicio.hora,
                observaciones: servicio.observaciones,
                prioridad: servicio.prioridad || 'Normal',
                estado: 'Cancelado'
            };

            const response = await fetch(`${API_BASE_URL}/servicios/${servicioId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(servicioData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Error al cancelar servicio');
            }

            alert('‚úÖ Servicio cancelado exitosamente!');
            closeModal('dayServicesModal');
            await loadAgendaData();
        } catch (error) {
            console.error("Error:", error);
            alert(`‚ùå Error al cancelar servicio: ${error.message}`);
        }
    }

    // ========== RENDER TODAY SCHEDULE ==========
    function renderTodaySchedule(date) {
        const scheduleContainer = document.getElementById('todaySchedule');
        if (!scheduleContainer) return;
        scheduleContainer.innerHTML = '';

        const todayStr = date.toISOString().split('T')[0];
        const serviciosHoy = servicios.filter(s => s.fecha === todayStr);

        const scheduleDateElement = document.getElementById('todayDate');
        if (scheduleDateElement) {
            scheduleDateElement.textContent = date.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        if (serviciosHoy.length === 0) {
            scheduleContainer.innerHTML = '<p style="text-align: center; color: #718096;">No hay servicios programados para hoy.</p>';
            return;
        }

        serviciosHoy.forEach(serv => {
            const nombreCliente = obtenerNombreCliente(serv);
            const nombreTecnico = obtenerNombreTecnico(serv);
            const nombreServicio = obtenerNombreServicio(serv);
            const scheduleItem = document.createElement('div');
            scheduleItem.className = 'schedule-item';
            scheduleItem.innerHTML = `
                <div class="schedule-time">${serv.hora || 'N/A'}</div>
                <div class="schedule-details">
                    <div class="schedule-service">${nombreServicio}</div>
                    <div class="schedule-client">Cliente: ${nombreCliente}</div>
                    <div class="schedule-technician">T√©cnico: ${nombreTecnico}</div>
                </div>
            `;
            scheduleContainer.appendChild(scheduleItem);
        });
    }

    // ========== NAVIGATION ==========
    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear);
    }

    function showView(view) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        console.log('Mostrando vista:', view);
    }

    // ========== MODAL FUNCTIONS ==========
    function openAddServiceModal(date) {
        document.getElementById('addServiceModal').classList.add('show');
        if (date) {
            document.getElementById('fecha').value = date.toISOString().split('T')[0];
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
        const form = document.getElementById(modalId).querySelector('form');
        if (form) form.reset();
    }

    // ========== ADD SERVICE ==========
    async function addService(event) {
        event.preventDefault();
        const servicioData = {
            id_servicio: generateUUID(),
            dni_cliente: document.getElementById('clienteId').value,
            dni_empleado_asignado: document.getElementById('tecnicoId').value,
            id_tipo_servicio: document.getElementById('tipoServicioId').value,
            fecha: document.getElementById('fecha').value,
            hora: document.getElementById('hora').value,
            observaciones: document.getElementById('observaciones').value || null,
            prioridad: document.getElementById('prioridad').value || 'Normal',
            estado: document.getElementById('estado').value || 'Programado'
        };

        if (document.getElementById('cotizacionId').value) {
            servicioData.id_cotizacion = document.getElementById('cotizacionId').value;
        }

        const fechaServicio = new Date(servicioData.fecha);
        const fechaActual = new Date();
        fechaActual.setHours(0, 0, 0, 0);
        if (fechaServicio < fechaActual) {
            alert('‚ùå No se puede programar un servicio en una fecha pasada');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/servicios`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(servicioData)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Error al crear servicio');
            }
            alert('‚úÖ Servicio creado exitosamente!');
            closeModal('addServiceModal');
            event.target.reset();
            await loadAgendaData();
        } catch (error) {
            console.error("Error:", error);
            alert(`‚ùå Error al crear servicio: ${error.message}`);
        }
    }

    // ========== QUICK ADD SERVICE ==========
    async function quickAddService() {
        const formData = {
            id_servicio: generateUUID(),
            dni_cliente: document.getElementById('quickCliente').value,
            dni_empleado_asignado: document.getElementById('quickTecnico').value,
            id_tipo_servicio: document.getElementById('quickTipoServicio').value,
            fecha: document.getElementById('quickFecha').value,
            hora: document.getElementById('quickHora').value,
            observaciones: document.getElementById('quickObservaciones').value || null,
            prioridad: document.getElementById('quickPrioridad').value,
            estado: 'Programado'
        };

        if (!formData.dni_cliente || !formData.dni_empleado_asignado || !formData.id_tipo_servicio || !formData.fecha || !formData.hora) {
            alert('Por favor, complete todos los campos requeridos.');
            return;
        }

        const fechaServicio = new Date(document.getElementById('quickFecha').value);
        const fechaActual = new Date();
        fechaActual.setHours(0, 0, 0, 0);
        if (fechaServicio < fechaActual) {
            alert('‚ùå No se puede programar un servicio en una fecha pasada');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/servicios`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Error al crear servicio: ${response.statusText} - ${errorData}`);
            }
            alert('‚úÖ Servicio creado exitosamente.');
            ['quickCliente','quickTecnico','quickTipoServicio','quickFecha','quickHora','quickObservaciones'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('quickPrioridad').value = 'Normal';
            await loadAgendaData();
        } catch (error) {
            console.error('Error al crear servicio r√°pido:', error);
            alert('‚ùå Error al crear servicio: ' + error.message);
        }
    }

    function exportSchedule() {
        alert('Exportando agenda...');
    }

    // ========== EVENT LISTENERS ==========
    window.onclick = function(event) {
        document.querySelectorAll('.modal').forEach(modal => {
            if (event.target === modal) modal.classList.remove('show');
        });
    }

    document.getElementById('serviceForm').addEventListener('submit', addService);
    document.getElementById('editServiceForm').addEventListener('submit', updateService);

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Agenda cargada. Iniciando carga de datos...');
        loadAgendaData();
    });
</script>
</body>
</html>