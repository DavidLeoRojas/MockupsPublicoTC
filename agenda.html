<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Gemini Ambiental Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }
        /* Sidebar - Same as previous modules */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #2c5f41, #1a4532);
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-icon {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text h2 {
            font-size: 1.2em;
            margin-bottom: 0.2rem;
        }
        .logo-text p {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .nav-menu {
            padding: 1rem 0;
        }
        .nav-item {
            margin: 0.5rem 1rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .logout-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-btn:hover {
            background: rgba(255,107,107,0.3);
            transform: translateY(-2px);
        }
        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        /* Top Navigation Menu */
        .top-nav {
            background: white;
            padding: 1rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-tabs {
            display: flex;
            gap: 2rem;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #718096;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
            transform: translateY(-2px);
        }
        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        /* Header */
        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 {
            color: #2c5f41;
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }
        .header-title p {
            color: #718096;
            font-size: 1.1em;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4a8b64, #2c5f41);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
        }
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        /* Calendar Layout */
        .calendar-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }
        /* Calendar Section */
        .calendar-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .calendar-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c5f41;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #4a8b64;
            color: white;
        }
        .month-year {
            font-weight: 600;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }
        /* Calendar Grid */
        .calendar-container {
            padding: 2rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: #f7fafc;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .calendar-day:hover {
            background: #f7fafc;
        }
        .calendar-day.today {
            background: #e6fffa;
        }
        .calendar-day.other-month {
            background: #f7fafc;
            color: #a0aec0;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .day-events {
            font-size: 0.8em;
        }
        .event-item {
            background: var(--event-color);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-bottom: 0.2rem;
            font-size: 0.7em;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-item.control-plagas { --event-color: #4a8b64; }
        .event-item.lavado-tanques { --event-color: #4299e1; }
        .event-item.inspeccion { --event-color: #f6ad55; }
        .event-item.seguimiento { --event-color: #9f7aea; }
        /* Sidebar Calendar */
        .sidebar-calendar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        /* Today's Schedule */
        .today-schedule {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .schedule-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .schedule-date {
            color: #718096;
            font-size: 0.9em;
        }
        .schedule-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .schedule-time {
            min-width: 80px;
            font-weight: 600;
            color: #4a8b64;
            text-align: center;
            background: #f0fff4;
            border-radius: 8px;
            padding: 0.5rem;
        }
        .schedule-details {
            flex: 1;
        }
        .schedule-service {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .schedule-client {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .schedule-technician {
            color: #4a8b64;
            font-size: 0.8em;
        }
        /* Quick Add */
        .quick-add {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #4a8b64;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5f41;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
        }
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .calendar-layout {
                grid-template-columns: 1fr;
            }
            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }
            .nav-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üåø</div>
                <div class="logo-text">
                    <h2>Gemini Admin</h2>
                    <p>Panel de Control</p>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">üì¶</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link active">
                    <span class="nav-icon">üìÖ</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">üí∞</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="coordinacion-servicios.html" class="nav-link">
                    <span class="nav-icon">üîß</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-tabs">
                <a href="#" class="nav-tab active" onclick="showView('calendar')">üìÖ Calendario</a>
                <a href="#" class="nav-tab" onclick="showView('list')">üìã Lista</a>
                <a href="#" class="nav-tab" onclick="showView('timeline')">‚è∞ Cronograma</a>
                <a href="#" class="nav-tab" onclick="showView('map')">üó∫Ô∏è Mapa</a>
            </div>
            <div class="nav-actions">
                <select class="form-control" style="width: auto;" id="filterTecnico">
                    <option value="">Todos los t√©cnicos</option>
                    <!-- Opciones se llenan din√°micamente -->
                </select>
                <button class="btn btn-secondary">üìä Reportes</button>
            </div>
        </div>
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Agenda de Servicios</h1>
                <p>Programaci√≥n y seguimiento de actividades</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="exportSchedule()">
                    üì§ Exportar
                </button>
                <button class="btn btn-primary" onclick="openAddServiceModal()">
                    ‚ûï Programar Servicio
                </button>
            </div>
        </div>
        <!-- Calendar Layout -->
        <div class="calendar-layout">
            <!-- Main Calendar -->
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 class="calendar-title">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <div class="month-year">Enero 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Headers -->
                        <div class="calendar-day-header">Dom</div>
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mi√©</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header">S√°b</div>
                        <!-- Days -->
                        <!-- Los d√≠as se llenar√°n din√°micamente -->
                    </div>
                </div>
            </div>
            <!-- Sidebar -->
            <div class="sidebar-calendar">
                <!-- Today's Schedule -->
                <div class="today-schedule">
                    <div class="schedule-header">
                        <h3 class="schedule-title">Agenda de Hoy</h3>
                        <div class="schedule-date" id="todayDate">30 Enero 2025</div>
                    </div>
                    <div id="todaySchedule">
                        <!-- La agenda de hoy se llenar√° din√°micamente -->
                    </div>
                </div>
                <!-- Quick Add Service -->
                <div class="quick-add">
                    <h3 style="color: #2c5f41; margin-bottom: 1.5rem;">Programar R√°pido</h3>
                    <div class="form-group">
                        <label>Cliente</label>
                        <select class="form-control" id="quickCliente">
                            <option value="">Seleccionar cliente</option>
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio</label>
                        <select class="form-control" id="quickTipoServicio" required>
                            <option value="">Seleccionar tipo</option>
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" class="form-control" id="quickFecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora de Inicio</label>
                            <input type="time" class="form-control" id="quickHora" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico Asignado</label>
                        <select class="form-control" id="quickTecnico" required>
                            <option value="">Seleccionar t√©cnico</option>
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" id="quickObservaciones" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="quickPrioridad">
                            <option>Normal</option>
                            <option>Alta</option>
                            <option>Urgente</option>
                        </select>
                    </div>
                    <div class="form-grid-2" style="margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="quickAddService()">Programar Servicio</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Service Modal -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Programar Nuevo Servicio</h2>
                <button class="close-btn" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <form id="serviceForm">
                <div class="form-group">
                    <label>Cotizaci√≥n Origen (Opcional)</label>
                    <select class="form-control" id="cotizacionId">
                        <option value="">Seleccionar cotizaci√≥n</option>
                        <!-- Opciones se llenan din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <select class="form-control" id="clienteId" required>
                        <option value="">Seleccionar cliente</option>
                        <!-- Opciones se llenan din√°micamente -->
                    </select>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Servicio *</label>
                        <select class="form-control" id="tipoServicioId" required>
                            <option value="">Seleccionar tipo</option>
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√©cnico Asignado *</label>
                        <select class="form-control" id="tecnicoId" required>
                            <option value="">Seleccionar t√©cnico</option>
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="fecha" required>
                    </div>
                    <div class="form-group">
                        <label>Hora de Inicio *</label>
                        <input type="time" class="form-control" id="hora" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Duraci√≥n Estimada</label>
                        <input type="text" class="form-control" id="duracionEstimada" placeholder="Ej: 2 horas">
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select class="form-control" id="prioridad">
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="observaciones" rows="3" placeholder="Instrucciones especiales, materiales necesarios, etc."></textarea>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="estado">
                        <option value="Programado">Programado</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Programar Servicio</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // URL base de la API
        const API_BASE_URL = 'http://localhost:8080/api';

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let servicios = [];
        let personas = []; // Clientes y Empleados
        let tiposServicio = [];
        let cotizaciones = [];

        // Cargar datos iniciales
        async function loadAgendaData() {
            console.log("Iniciando carga de datos de la agenda...");
            try {
                const [serviciosRes, personasRes, tiposServRes, cotizacionesRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/servicios`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/personas`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/tipos-servicio`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/cotizaciones`).then(r => r.json())
                ]);
                servicios = serviciosRes;
                personas = personasRes;
                tiposServicio = tiposServRes;
                cotizaciones = cotizacionesRes;

                console.log("Datos cargados - Servicios:", servicios.length, "Personas:", personas.length, "Tipos:", tiposServicio.length, "Cotizaciones:", cotizaciones.length);

                populateClienteSelect(personas);
                populateTecnicoSelect(personas);
                populateTipoServicioSelect(tiposServicio);
                populateCotizacionSelect(cotizaciones);
                populateFilterTecnico(personas);
                populateQuickCliente(personas);
                populateQuickTipoServicio(tiposServicio);
                populateQuickTecnico(personas);

                renderCalendar(currentMonth, currentYear);
                renderTodaySchedule(new Date()); // Muestra agenda de hoy

            } catch (error) {
                console.error('Error al cargar datos de agenda:', error);
                alert('Error al cargar la agenda. Por favor, recargue la p√°gina.');
            }
        }

        function populateClienteSelect(personas) {
            const select = document.getElementById('clienteId');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            personas.filter(p => p.rol === 'Cliente').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        function populateTecnicoSelect(personas) {
            const select = document.getElementById('tecnicoId');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar t√©cnico</option>';
            personas.filter(p => p.rol === 'Empleado').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        function populateTipoServicioSelect(tipos) {
            const select = document.getElementById('tipoServicioId');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar tipo</option>';
            tipos.forEach(ts => {
                const option = document.createElement('option');
                option.value = ts.idTipoServicio;
                option.textContent = `${ts.nombreServicio} ($${ts.costo})`;
                select.appendChild(option);
            });
        }

        function populateCotizacionSelect(cotizaciones) {
            const select = document.getElementById('cotizacionId');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar cotizaci√≥n</option>';
            cotizaciones.forEach(c => {
                const option = document.createElement('option');
                option.value = c.idCotizacion;
                option.textContent = `#${c.idCotizacion} - ${c.descripcionProblema || 'Sin descripci√≥n'}`;
                select.appendChild(option);
            });
        }

        function populateFilterTecnico(personas) {
            const select = document.getElementById('filterTecnico');
            if (!select) return;
            select.innerHTML = '<option value="">Todos los t√©cnicos</option>';
            personas.filter(p => p.rol === 'Empleado').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        function populateQuickCliente(personas) {
            const select = document.getElementById('quickCliente');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            personas.filter(p => p.rol === 'Cliente').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        function populateQuickTipoServicio(tipos) {
            const select = document.getElementById('quickTipoServicio');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar tipo</option>';
            tipos.forEach(ts => {
                const option = document.createElement('option');
                option.value = ts.idTipoServicio;
                option.textContent = ts.nombreServicio;
                select.appendChild(option);
            });
        }

        function populateQuickTecnico(personas) {
            const select = document.getElementById('quickTecnico');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar t√©cnico</option>';
            personas.filter(p => p.rol === 'Empleado').forEach(p => {
                const option = document.createElement('option');
                option.value = p.dni;
                option.textContent = p.nombre;
                select.appendChild(option);
            });
        }

        function renderCalendar(month, year) {
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const monthYearElement = document.querySelector('.month-year');
            if (monthYearElement) {
                monthYearElement.textContent = `${monthNames[month]} ${year}`;
            }

            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) {
                console.error("No se encontr√≥ el contenedor .calendar-grid");
                return;
            }

            // Limpiar d√≠as actuales (menos los encabezados)
            const headers = calendarGrid.querySelectorAll('.calendar-day-header');
            calendarGrid.innerHTML = '';
            headers.forEach(header => calendarGrid.appendChild(header)); // Reinsertar encabezados

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay(); // 0 = Domingo
            const totalDays = lastDay.getDate();

            // D√≠as del mes anterior
            const prevLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${prevLastDay - i}</div>`;
                calendarGrid.appendChild(dayElement);
            }

            // D√≠as del mes actual
            const today = new Date();
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events"></div>`;

                // Filtrar servicios para este d√≠a
                const serviciosDelDia = servicios.filter(s => {
                    const fechaServicio = new Date(s.fecha);
                    return fechaServicio.getDate() === day && fechaServicio.getMonth() === month && fechaServicio.getFullYear() === year;
                });

                // Agregar eventos al d√≠a
                const eventsContainer = dayElement.querySelector('.day-events');
                serviciosDelDia.forEach(serv => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `event-item ${getEventTypeClass(serv.tipoServicio)}`;
                    eventElement.textContent = serv.descripcion || 'Servicio sin descripci√≥n';
                    eventsContainer.appendChild(eventElement);
                });

                // A√±adir listener para crear evento en el d√≠a
                dayElement.addEventListener('click', () => openAddServiceModal(date));

                calendarGrid.appendChild(dayElement);
            }

            // D√≠as del siguiente mes
            const totalCells = 42; // 6 filas x 7 d√≠as
            const remaining = totalCells - (startDay + totalDays);
            for (let day = 1; day <= remaining; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div>`;
                calendarGrid.appendChild(dayElement);
            }
        }

        // Obtener clase CSS para tipo de evento (servicio)
        function getEventTypeClass(tipoServicio) {
            if (tipoServicio && tipoServicio.nombreServicio) {
                const nombre = tipoServicio.nombreServicio.toLowerCase();
                if (nombre.includes('plaga') || nombre.includes('control')) return 'control-plagas';
                if (nombre.includes('tanque') || nombre.includes('lavado')) return 'lavado-tanques';
                if (nombre.includes('inspeccion')) return 'inspeccion';
                if (nombre.includes('seguimiento')) return 'seguimiento';
            }
            return 'control-plagas'; // Valor por defecto
        }

        // Renderizar agenda de hoy
        function renderTodaySchedule(date) {
            const scheduleContainer = document.getElementById('todaySchedule');
            if (!scheduleContainer) {
                console.error("No se encontr√≥ el contenedor #todaySchedule");
                return;
            }
            // Limpiar agenda actual
            scheduleContainer.innerHTML = '';

            const todayStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
            const serviciosHoy = servicios.filter(s => s.fecha === todayStr);

            const scheduleDateElement = document.getElementById('todayDate');
            if (scheduleDateElement) {
                scheduleDateElement.textContent = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            if (serviciosHoy.length === 0) {
                scheduleContainer.innerHTML = '<p style="text-align: center; color: #718096;">No hay servicios programados para hoy.</p>';
                return;
            }

            serviciosHoy.forEach(serv => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.innerHTML = `
                    <div class="schedule-time">${serv.hora || 'N/A'}</div>
                    <div class="schedule-details">
                        <div class="schedule-service">${serv.descripcion || 'Servicio sin descripci√≥n'}</div>
                        <div class="schedule-client">Cliente: ${serv.cotizacion && serv.cotizacion.cliente ? serv.cotizacion.cliente.nombre : 'N/A'}</div>
                        <div class="schedule-technician">T√©cnico: ${serv.empleadoAsignado ? serv.empleadoAsignado.nombre : 'No asignado'}</div>
                    </div>
                `;
                scheduleContainer.appendChild(scheduleItem);
            });
        }

        // Navegaci√≥n de mes
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);
            renderTodaySchedule(new Date(currentYear, currentMonth, 1)); // Actualiza vista de hoy si es necesario
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
            renderTodaySchedule(new Date(currentYear, currentMonth, 1)); // Actualiza vista de hoy si es necesario
        }

        function showView(view) {
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Add active class to clicked tab
            event.target.classList.add('active');
            // Aqu√≠ ir√≠a la l√≥gica para mostrar diferentes vistas (calendario, lista, etc.)
            console.log('Showing view:', view);
        }

        // Abrir modal para agregar servicio en una fecha espec√≠fica
        function openAddServiceModal(date) {
            document.getElementById('addServiceModal').classList.add('show');
            // Puedes pre-llenar la fecha en el formulario si lo deseas
            const dateInput = document.querySelector('#addServiceModal input[type="date"]');
            if (dateInput && date) {
                dateInput.valueAsDate = date;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            // Limpiar formulario al cerrar
            const form = document.getElementById(modalId).querySelector('form');
            if (form) form.reset();
        }

        // Funci√≥n para crear un nuevo servicio
        async function addService(event) {
            event.preventDefault();
            const formData = {
                id_cotizacion: document.getElementById('cotizacionId').value || null,
                dni_cliente: document.getElementById('clienteId').value,
                dni_empleado_asignado: document.getElementById('tecnicoId').value,
                id_tipo_servicio: document.getElementById('tipoServicioId').value,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                duracionEstimada: document.getElementById('duracionEstimada').value,
                observaciones: document.getElementById('observaciones').value,
                prioridad: document.getElementById('prioridad').value,
                estado: document.getElementById('estado').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/servicios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    throw new Error(`Error al crear servicio: ${response.statusText}`);
                }

                await loadAgendaData(); // Recargar datos
                closeModal('addServiceModal');
                alert('‚úÖ Servicio creado exitosamente.');

            } catch (error) {
                console.error('Error al crear servicio:', error);
                alert('‚ùå Error al crear servicio: ' + error.message);
            }
        }

        // Funci√≥n para crear un nuevo servicio r√°pidamente
        async function quickAddService() {
            const formData = {
                dni_cliente: document.getElementById('quickCliente').value,
                dni_empleado_asignado: document.getElementById('quickTecnico').value,
                id_tipo_servicio: document.getElementById('quickTipoServicio').value,
                fecha: document.getElementById('quickFecha').value,
                hora: document.getElementById('quickHora').value,
                estado: 'Programado'
            };

            if (!formData.dni_cliente || !formData.dni_empleado_asignado || !formData.id_tipo_servicio || !formData.fecha || !formData.hora) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/servicios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    throw new Error(`Error al crear servicio r√°pido: ${response.statusText}`);
                }

                await loadAgendaData(); // Recargar datos
                alert('‚úÖ Servicio creado exitosamente.');
                document.getElementById('quickCliente').value = '';
                document.getElementById('quickTecnico').value = '';
                document.getElementById('quickTipoServicio').value = '';
                document.getElementById('quickFecha').value = '';
                document.getElementById('quickHora').value = '';

            } catch (error) {
                console.error('Error al crear servicio r√°pido:', error);
                alert('‚ùå Error al crear servicio: ' + error.message);
            }
        }

        function exportSchedule() {
            alert('Exportando agenda...');
            // Implementar l√≥gica de exportaci√≥n
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) modal.classList.remove('show');
            });
        }

        // Event listener para el formulario de servicios
        document.getElementById('serviceForm').addEventListener('submit', addService);

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Agenda cargada. Iniciando carga de datos...');
            loadAgendaData();
        });
    </script>
</body>
</html>