<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - Gemini Ambiental Admin</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #2d3748;
}

.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: linear-gradient(135deg, #2c5f41, #1a4532);
    color: white;
    z-index: 1000;
    transition: transform 0.3s ease;
}

.sidebar-header {
    padding: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logo-icon {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.logo-text h2 {
    font-size: 1.2em;
    margin-bottom: 0.2rem;
}

.logo-text p {
    font-size: 0.8em;
    opacity: 0.8;
}

.nav-menu {
    padding: 1rem 0;
}

.nav-item {
    margin: 0.5rem 1rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateX(5px);
}

.nav-icon {
    font-size: 1.2em;
    width: 24px;
    text-align: center;
}

.logout-section {
    position: absolute;
    bottom: 2rem;
    left: 1rem;
    right: 1rem;
}

.logout-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    width: 100%;
}

.logout-btn:hover {
    background: rgba(255, 107, 107, 0.3);
    transform: translateY(-2px);
}

.main-content {
    margin-left: 280px;
    padding: 2rem;
    min-height: 100vh;
}

.top-nav {
    background: white;
    padding: 1rem 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-tabs {
    display: flex;
    gap: 2rem;
}

.nav-tab {
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    color: #718096;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
}

.nav-tab:hover,
.nav-tab.active {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
    transform: translateY(-2px);
}

.header {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title h1 {
    color: #2c5f41;
    font-size: 2.5em;
    margin-bottom: 0.5rem;
}

.header-title p {
    color: #718096;
    font-size: 1.1em;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
}

.btn-secondary {
    background: #f7fafc;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
    background: white;
    border-color: #4a8b64;
}

.btn-send {
    background: #48bb78;
    color: white;
}

.btn-send:hover {
    background: #38a169;
}

.btn-delete {
    background: #f56565;
    color: white;
}

.btn-delete:hover {
    background: #e53e3e;
}

.btn-edit {
    background: #4299e1;
    color: white;
}

.btn-edit:hover {
    background: #3182ce;
}

.btn-details {
    background: #805ad5;
    color: white;
}

.btn-details:hover {
    background: #6b46c1;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.modal-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c5f41;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #718096;
}

.form-grid {
    display: grid;
    gap: 1rem;
}

.form-grid-2 {
    grid-template-columns: 1fr 1fr;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-weight: 600;
}

.form-control {
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    max-width: 100%;
}

.form-control:focus {
    outline: none;
    border-color: #4a8b64;
}

/* Ajuste específico para el select de cotización y el input de fecha */
#cotizacionSelect,
input[type="date"] {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.invoices-section {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.invoices-header {
    padding: 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.invoices-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c5f41;
}

.table-container {
    overflow-x: auto;
}

.invoices-table {
    width: 100%;
    border-collapse: collapse;
}

.invoices-table th,
.invoices-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.invoices-table th {
    background: #f7fafc;
    color: #4a5568;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.invoices-table tr:hover {
    background: #f7fafc;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.pagada {
    background: #c6f6d5;
    color: #22543d;
}

.status-badge.pendiente {
    background: #e2e8f0;
    color: #4a5568;
}

.status-badge.cancelada {
    background: #fed7d7;
    color: #c53030;
}

.status-badge.vencida {
    background: #fed7d7;
    color: #c53030;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8em;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    width: auto;
    text-align: center;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.detalle-factura-container {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 12px;
    margin-top: 1rem;
    border: 1px solid #e2e8f0;
}

.detalle-factura-container h4 {
    color: #2c5f41;
    margin-bottom: 1rem;
    font-size: 1.1em;
}

.detalle-factura-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.detalle-factura-item:last-child {
    border-bottom: none;
}

.detalle-factura-controls {
    display: flex;
    gap: 0.5rem;
}

.detalle-factura-controls button {
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8em;
    border: none;
}

.detalle-factura-controls .remove-btn {
    background: #f56565;
    color: white;
}

.detalle-factura-controls .remove-btn:hover {
    background: #e53e3e;
}

.detalle-factura-controls .edit-btn {
    background: #4299e1;
    color: white;
}

.detalle-factura-controls .edit-btn:hover {
    background: #3182ce;
}

.add-product-btn {
    margin-top: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-color);
}

.stat-card.primary {
    --accent-color: #4a8b64;
}

.stat-card.warning {
    --accent-color: #f6ad55;
}

.stat-card.danger {
    --accent-color: #f56565;
}

.stat-card.info {
    --accent-color: #4299e1;
}

.stat-card.success {
    --accent-color: #48bb78;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    color: white;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
}

.stat-icon.warning {
    background: linear-gradient(135deg, #f6ad55, #ed8936);
}

.stat-icon.danger {
    background: linear-gradient(135deg, #f56565, #e53e3e);
}

.stat-icon.info {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.stat-icon.success {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #718096;
    font-size: 0.9em;
}

.filters-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }

    .main-content {
        margin-left: 0;
        padding: 1rem;
    }

    .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .filters-grid {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .top-nav {
        flex-direction: column;
        gap: 1rem;
    }

    .nav-tabs {
        justify-content: center;
        flex-wrap: wrap;
    }

    .form-grid-2 {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    .btn-sm {
        width: 100%;
        margin-bottom: 0.25rem;
    }
}
</style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">🌿</div>
                <div class="logo-text">
                    <h2>Gemini Admin</h2>
                    <p>Panel de Control</p>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">📊</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">📦</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link">
                    <span class="nav-icon">📅</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">👥</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">💰</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link active">
                    <span class="nav-icon">📄</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="servicios.html" class="nav-link">
                    <span class="nav-icon">🔧</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">🚪</span>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Facturas</h1>
                <p>Administración de facturas emitidas</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">📤 Exportar</button>
                <button class="btn btn-primary" onclick="openAddInvoiceModal()">➕ Agregar Factura</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <div class="stat-icon primary">📄</div>
                </div>
                <div class="stat-number" id="statFacturasTotal">0</div>
                <div class="stat-label">Total Facturas</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">⏳</div>
                </div>
                <div class="stat-number" id="statFacturasPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">✅</div>
                </div>
                <div class="stat-number" id="statFacturasPagadas">0</div>
                <div class="stat-label">Pagadas</div>
            </div>
            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">💰</div>
                </div>
                <div class="stat-number" id="statIngresosTotal">0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <form id="filterForm">
                <div class="filters-grid">
                    <div class="form-group">
                        <label>Buscar factura</label>
                        <input type="text" class="form-control" placeholder="ID, cliente o monto" id="searchInput">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagada">Pagada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" class="form-control" id="dateFromFilter">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" class="form-control" id="dateToFilter">
                    </div>
                    <button class="btn btn-primary" type="button" id="filterInvoicesButton">🔍 Filtrar</button>
                </div>
            </form>
        </div>

        <!-- Invoices Table -->
        <div class="invoices-section">
            <div class="invoices-header">
                <span class="invoices-title">Listado de Facturas</span>
                <span>
                    <button class="btn btn-secondary">⬇️ Descargar</button>
                </span>
            </div>
            <div class="table-container">
                <table class="invoices-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha Emisión</th>
                            <th>Monto Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Filas se llenan dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Factura -->
    <div class="modal" id="addInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Agregar Factura</h2>
                <button class="close-btn" onclick="closeModal('addInvoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <input type="hidden" id="invoiceIdInput">
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Factura *</label>
                        <select class="form-control" id="tipoFacturaSelect" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Simple">Factura Simple</option>
                            <option value="ConCotizacion">Factura con Cotización</option>
                        </select>
                    </div>
                    <div class="form-group" id="cotizacionField" style="display: none;">
                        <label>Cotización</label>
                        <select name="id_cotizacion" id="cotizacionSelect" class="form-control">
                            <option value="">Cargando cotizaciones...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select name="dni_cliente" id="clienteSelect" class="form-control" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Emisión *</label>
                        <input type="date" name="fecha_emision" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select name="estado" class="form-control" required>
                            <option value="">Seleccione estado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagada">Pagada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                                    <!-- Campo Valor Servicio -->
                <div class="form-group">
                    <label>Valor Servicio</label>
                    <input type="number" step="0.01" name="valor_servicio" id="valorServicio" class="form-control" placeholder="Ej: 500000" value="0">
                </div>
                    <!-- Campo Monto Total - Se oculta si es con cotización -->
                    <div class="form-group" id="montoTotalField">
                        <label>Monto Total *</label>
                        <input type="number" step="0.01" name="monto_total" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea name="observaciones" class="form-control" rows="2"></textarea>
                </div>


                <!-- Sección de Productos (Solo para Factura Simple) -->
                <div id="productosSection" style="display: none;">
                    <h3 style="color: #2c5f41; margin-top: 1.5rem;">Productos del Inventario</h3>
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label>Producto</label>
                            <select id="productoSelect" class="form-control">
                                <option value="">Cargando productos...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="cantidadProducto" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary add-product-btn" id="addProductBtn">Agregar Producto</button>

                    <div class="detalle-factura-container">
                        <h4>Productos Agregados</h4>
                        <div id="detalleFacturaList">
                            <!-- Aquí se mostrarán los productos agregados -->
                        </div>
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addInvoiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Guardar Factura</button>
                </div>
            </form>
        </div>
    </div>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const API_FACTURAS_URL = `${API_BASE_URL}/facturas`;
        const API_CLIENTES_URL = `${API_BASE_URL}/personas/clientes`;
        const API_COTIZACIONES_URL = `${API_BASE_URL}/cotizaciones`;
        const API_PRODUCTOS_URL = `${API_BASE_URL}/productos`;

        let allFacturas = [];
        let clientesData = [];
        let cotizacionesData = [];
        let productosData = [];
        let currentEditId = null;
        let detalleFactura = []; // Array para almacenar los productos agregados
        let isSubmitting = false;

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadClientes(),
                    loadCotizaciones(),
                    loadProductos()
                ]);
                await getAllFacturas();
            } catch (error) {
                console.error("Error al cargar datos iniciales:", error);
                alert("Error al cargar datos iniciales. Revisa la consola.");
            }
        }

        async function loadClientes() {
            try {
                const response = await fetch(`${API_BASE_URL}/personas?rol=cliente`);
                if (!response.ok) {
                    throw new Error(`Error al cargar clientes: ${response.status} ${response.statusText}`);
                }
                const personas = await response.json();
                clientesData = personas.filter(p => p.rol && p.rol.toLowerCase() === 'cliente');
                const select = document.getElementById('clienteSelect');
                if (!select) {
                    console.error("❌ No se encontró el elemento #clienteSelect");
                    return;
                }
                select.innerHTML = '<option value="">Seleccione un cliente</option>';
                clientesData.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.dni;
                    option.textContent = `${cliente.nombre} - ${cliente.dni}`;
                    select.appendChild(option);
                });
                console.log(`✅ Clientes cargados: ${clientesData.length}`);
            } catch (error) {
                console.error("❌ Error al cargar clientes:", error);
                const select = document.getElementById('clienteSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error al cargar clientes</option>';
                }
            }
        }

        async function loadCotizaciones() {
            try {
                const response = await fetch(API_COTIZACIONES_URL);
                if (!response.ok) throw new Error('Error al cargar cotizaciones');
                cotizacionesData = await response.json();
                const select = document.getElementById('cotizacionSelect');
                if (!select) {
                    console.error("❌ No se encontró el elemento #cotizacionSelect");
                    return;
                }
                select.innerHTML = '<option value="">Seleccione una cotización</option>';
                cotizacionesData.forEach(cot => {
                    const estado = cot.estado ? cot.estado.toLowerCase() : '';
                    if (estado === 'aprobada' || estado === 'finalizada') {
                        const option = document.createElement('option');
                        option.value = cot.idCotizacion;
                        const clienteNombre = cot.cliente?.nombre || cot.dniCliente || 'Cliente desconocido';
                        const costoFormateado = formatCurrency(cot.costoTotalCotizacion || 0);
                        option.textContent = `#${cot.idCotizacion} - ${clienteNombre} - $ ${costoFormateado} [${cot.estado}]`;
                        select.appendChild(option);
                    }
                });
                console.log(`✅ Cotizaciones cargadas: ${cotizacionesData.length} (filtradas para facturar)`);
            } catch (error) {
                console.error("Error al cargar cotizaciones:", error);
                const select = document.getElementById('cotizacionSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error al cargar cotizaciones</option>';
                }
            }
        }

        async function loadProductos() {
            try {
                const response = await fetch(API_PRODUCTOS_URL);
                if (!response.ok) throw new Error('Error al cargar productos');
                productosData = await response.json();
                const select = document.getElementById('productoSelect');
                select.innerHTML = '<option value="">Seleccione un producto</option>';
                productosData.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.idProducto;
                    option.textContent = `${prod.nombre} (${prod.idProducto}) - Stock: ${prod.stock}`;
                    option.dataset.precio = prod.precioActual || 0;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar productos:", error);
                document.getElementById('productoSelect').innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        // Formatear moneda
        function formatCurrency(value) {
            if (value === null || value === undefined) return '$ 0.00';
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 }).format(value);
        }

 function actualizarMontoTotal() {
    const valorServicioInput = document.getElementById('valorServicio');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');

    if (!montoTotalInput) return;

    // Solo calcular si NO hay cotización seleccionada
    const tieneCotizacion = document.getElementById('cotizacionSelect').value;
    if (tieneCotizacion) {
        // Si hay cotización, el monto total ya está fijo con el valor de la cotización
        return;
    }

    const valorServicio = parseFloat(valorServicioInput.value) || 0;
    const subtotalProductos = detalleFactura.reduce((sum, item) => sum + item.subtotal, 0);
    const montoTotal = subtotalProductos + valorServicio;

    montoTotalInput.value = montoTotal.toFixed(2);
    // El campo montoTotalInput debe estar deshabilitado en el HTML o aquí para facturas simples también
    // montoTotalInput.disabled = true; // Opcional: Deshabilitar aquí también para facturas simples
}

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        document.getElementById('valorServicio').addEventListener('input', actualizarMontoTotal);

// Manejar cambio de tipo de factura
document.getElementById('tipoFacturaSelect').addEventListener('change', function() {
    const tipoFactura = this.value;
    const cotizacionField = document.getElementById('cotizacionField');
    const productosSection = document.getElementById('productosSection');
    const montoTotalField = document.getElementById('montoTotalField');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const submitBtn = document.getElementById('submitBtn');
    const valorServicioInput = document.getElementById('valorServicio'); // ✅ Obtener el campo de Valor del Servicio

    if (tipoFactura === 'ConCotizacion') {
        cotizacionField.style.display = 'block';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = true;
        submitBtn.textContent = currentEditId ? '💾 Guardar Cambios' : '✅ Guardar Factura';

        const cotizacionSelect = document.getElementById('cotizacionSelect');
        if (cotizacionSelect.value) {
            cotizacionSelect.dispatchEvent(new Event('change')); // <-- Esto manejará valorServicio y montoTotal
        }
        // Si no hay cotización seleccionada aún, los campos se habilitarán/deshabilitarán en el change de cotizacionSelect
    } else { // 'Simple'
        cotizacionField.style.display = 'none';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = false;
        submitBtn.textContent = currentEditId ? '💾 Guardar Cambios' : '✅ Guardar Factura';
        // ✅ HABILITAR CAMPOS PARA FACTURAS SIMPLES
        if (valorServicioInput) {
            valorServicioInput.disabled = false;
        }
        if (montoTotalInput) {
            montoTotalInput.disabled = false; // Se puede dejar editable o calcularse automáticamente
            // Si se deja calcularse, actualizarMontoTotal se encargará de ello
            // Si se deja editable, se debe eliminar o modificar la lógica de renderDetalleFactura/actualizarMontoTotal
            // Para que no sobrescriba un valor ingresado manualmente.
            // Por ahora, asumiremos que se calcula automáticamente.
        }
    }
    // Resetear campos dependientes
    document.getElementById('cotizacionSelect').value = '';
    detalleFactura = [];
    renderDetalleFactura(); // <-- Esto llamará a actualizarMontoTotal si no hay cotización
});


document.getElementById('cotizacionSelect').addEventListener('change', function() {
    const cotizacionId = this.value;
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const valorServicioInput = document.getElementById('valorServicio'); // ✅ Obtener el campo de Valor del Servicio

    if (!montoTotalInput) {
        console.error("❌ No se encontró el campo 'monto_total'");
        return;
    }

    if (!valorServicioInput) {
         console.error("❌ No se encontró el campo 'valorServicio'");
         return;
    }

    if (cotizacionId) {
        const cotizacion = cotizacionesData.find(c => c.idCotizacion === cotizacionId);

        if (cotizacion) {
            let costoTotal = parseFloat(cotizacion.costoTotalCotizacion) || 0;
            // ✅ Obtener el valor del servicio de la cotización
            let valorServicioCotizacion = parseFloat(cotizacion.valorServicio) || 0;

            if (isNaN(costoTotal) || costoTotal <= 0) {
                alert(`⚠️ La cotización seleccionada no tiene un costo total válido. Por favor, verifique los datos.`);
                // Limpiar y habilitar campos si la cotización no es válida
                valorServicioInput.value = '0';
                valorServicioInput.disabled = false;
                montoTotalInput.value = '0';
                // ✅ NO deshabilitar montoTotalInput aquí si no es válida, para evitar confusión
                // montoTotalInput.disabled = false; // Opcional: mantener deshabilitado si no es válida
                clienteSelect.disabled = false;
                detalleFactura = [];
                renderDetalleFactura();
                return;
            }

            // ✅ Cargar productos de la cotización
            detalleFactura = [];
            if (cotizacion.detalleCotizacion && Array.isArray(cotizacion.detalleCotizacion)) {
                cotizacion.detalleCotizacion.forEach(item => {
                    const producto = productosData.find(p => p.idProducto === item.idProducto);
                    const precioUnitario = producto ? parseFloat(producto.precioActual) : 0;
                    const subtotal = precioUnitario * item.cantidad;
                    detalleFactura.push({
                        idProducto: item.idProducto,
                        nombreProducto: item.nombreProducto || producto?.nombre || 'Producto desconocido',
                        cantidad: item.cantidad,
                        precioUnitario: precioUnitario,
                        subtotal: subtotal
                    });
                });
            }

            renderDetalleFactura(); // <-- Esto llama a actualizarMontoTotal, pero no hará nada porque hay cotización

            // ✅ CARGAR EL VALOR DEL SERVICIO DESDE LA COTIZACIÓN
            valorServicioInput.value = valorServicioCotizacion.toFixed(2);
            // ✅ DESHABILITAR EL VALOR DEL SERVICIO
            valorServicioInput.disabled = true; // <-- Deshabilitar

            // ✅ CARGAR EL MONTO TOTAL CON EL VALOR DE LA COTIZACIÓN
            montoTotalInput.value = costoTotal.toFixed(2);
            // ✅ DESHABILITAR EL MONTO TOTAL (opcional, para que el usuario vea que es fijo)
            // Si lo deshabilitas, asegúrate de que handleInvoiceFormSubmit lo lea correctamente del DOM.
            montoTotalInput.disabled = true; // <-- Deshabilitar

            if (cotizacion.cliente?.dni) {
                clienteSelect.value = cotizacion.cliente.dni;
            } else if (cotizacion.dniCliente) {
                clienteSelect.value = cotizacion.dniCliente;
            }

        } else {
            alert(`⚠️ Cotización no encontrada.`);
            // Limpiar y habilitar campos si la cotización no se encuentra
            valorServicioInput.value = '0';
            valorServicioInput.disabled = false;
            montoTotalInput.value = '0';
            montoTotalInput.disabled = false; // Habilitar
            clienteSelect.disabled = false;
            detalleFactura = [];
            renderDetalleFactura();
        }
    } else {
        // Si no hay cotización seleccionada, limpiar y habilitar campos
        valorServicioInput.value = '';
        valorServicioInput.disabled = false;
        montoTotalInput.value = ''; // Se calculará en renderDetalleFactura o actualizarMontoTotal
        montoTotalInput.disabled = false; // Habilitar
        clienteSelect.disabled = false;
        detalleFactura = [];
        renderDetalleFactura(); // <-- Esto llamará a actualizarMontoTotal
    }
});

        // Agregar producto al detalle
        document.getElementById('addProductBtn').addEventListener('click', function() {
            const productoId = document.getElementById('productoSelect').value;
            const cantidad = parseInt(document.getElementById('cantidadProducto').value) || 0;

            if (!productoId || cantidad <= 0) {
                alert('⚠️ Por favor, seleccione un producto y una cantidad válida.');
                return;
            }

            const producto = productosData.find(p => p.idProducto === productoId);
            if (!producto) {
                alert('❌ Producto no encontrado.');
                return;
            }

            if (cantidad > producto.stock) {
                alert(`❌ Stock insuficiente. Disponible: ${producto.stock}`);
                return;
            }

            const precioUnitario = parseFloat(producto.precioActual) || 0;
            const subtotal = precioUnitario * cantidad;

            const existingItem = detalleFactura.find(item => item.idProducto === productoId);
            if (existingItem) {
                alert(`⚠️ El producto "${producto.nombre}" ya ha sido agregado. Edite la cantidad en la lista.`);
                return;
            }

            detalleFactura.push({
                idProducto: productoId,
                nombreProducto: producto.nombre,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                subtotal: subtotal
            });

            renderDetalleFactura();

            document.getElementById('productoSelect').value = '';
            document.getElementById('cantidadProducto').value = '1';
        });

        // Renderizar lista de productos agregados
       function renderDetalleFactura() {
            const container = document.getElementById('detalleFacturaList');
            if (!container) return;

            if (detalleFactura.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">No hay productos agregados.</p>';
                actualizarMontoTotal(); // <-- Agregar esta línea
                return;
            }

            container.innerHTML = '';
            detalleFactura.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'detalle-factura-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.nombreProducto}</strong><br>
                        Cantidad: ${item.cantidad} x $${item.precioUnitario.toFixed(2)} = $${item.subtotal.toFixed(2)}
                    </div>
                    <div class="detalle-factura-controls">
                        <button class="btn-sm edit-btn" onclick="editDetalleItem(${index})">✏️</button>
                        <button class="btn-sm remove-btn" onclick="removeDetalleItem(${index})">🗑️</button>
                    </div>
                `;
                container.appendChild(div);
            });
            actualizarMontoTotal(); // <-- Agregar esta línea
        }

        // Editar un item del detalle
        function editDetalleItem(index) {
            const item = detalleFactura[index];
            const nuevaCantidad = prompt(`Editar cantidad para "${item.nombreProducto}":`, item.cantidad);
            const cantidadNum = parseInt(nuevaCantidad);
            if (!isNaN(cantidadNum) && cantidadNum > 0) {
                const producto = productosData.find(p => p.idProducto === item.idProducto);
                if (producto && cantidadNum <= producto.stock) {
                    item.cantidad = cantidadNum;
                    item.subtotal = item.precioUnitario * cantidadNum;
                    renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
                } else {
                    alert(`❌ Stock insuficiente o cantidad inválida. Disponible: ${producto.stock}`);
                }
            }
        }

        // Remover un item del detalle
        function removeDetalleItem(index) {
            if (confirm('¿Está seguro de remover este producto del detalle?')) {
                detalleFactura.splice(index, 1);
                renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
            }
        }

        // Abrir modal para agregar factura
        function openAddInvoiceModal() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceModalTitle').textContent = 'Agregar Nueva Factura';
            document.getElementById('submitBtn').textContent = 'Guardar Factura';
            document.getElementById('invoiceIdInput').value = '';
            document.getElementById('productosSection').style.display = 'block'; // ✅ Mostrar siempre
            document.getElementById('cotizacionField').style.display = 'none';
            document.getElementById('clienteSelect').disabled = false;
            document.getElementById('montoTotalField').style.display = 'block';
            document.querySelector('input[name="monto_total"]').disabled = false;
            detalleFactura = [];
            renderDetalleFactura();
            currentEditId = null;
            document.getElementById('addInvoiceModal').classList.add('show');
        }

 // Abrir modal para editar factura
async function editInvoice(id) {
    const fact = allFacturas.find(f => f.idFactura === id);
    if (!fact) {
        alert("Factura no encontrada.");
        return;
    }

    openAddInvoiceModal();
    document.getElementById('invoiceModalTitle').textContent = 'Editar Factura';
    document.getElementById('submitBtn').textContent = 'Guardar Cambios';
    document.getElementById('invoiceIdInput').value = id;

    const tipoFactura = fact.tipoFactura === 'ConCotizacion' ? 'ConCotizacion' : 'Simple';
    document.getElementById('tipoFacturaSelect').value = tipoFactura;

    // Disparar el evento de cambio para actualizar campos visibles (esto habilita/deshabilita campos)
    document.getElementById('tipoFacturaSelect').dispatchEvent(new Event('change'));

    const dniCliente = fact.cliente?.dni || fact.dniCliente;
    document.getElementById('clienteSelect').value = dniCliente;

    const fechaEmision = fact.fechaEmision ? fact.fechaEmision.split('T')[0] : '';
    document.querySelector('input[name="fecha_emision"]').value = fechaEmision;

    document.querySelector('select[name="estado"]').value = fact.estado || '';

    document.querySelector('textarea[name="observaciones"]').value = fact.observaciones || '';

    // ✅ CARGAR VALOR SERVICIO desde la factura existente
    const valorServicioInput = document.getElementById('valorServicio');
    if (valorServicioInput) {
        valorServicioInput.value = (fact.valorServicio || 0).toFixed(2);
        // El estado de deshabilitado se manejará en el change de tipoFactura o cotizacionSelect
        // Si la factura tiene cotización, el change de tipoFactura ya deshabilitó valorServicio
        // Si no tiene cotización, quedará habilitado.
    }

    // ✅ CARGAR MONTO TOTAL desde la factura existente
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    if (montoTotalInput) {
        montoTotalInput.value = (fact.montoTotal || 0).toFixed(2);
        // El estado de deshabilitado se manejará en el change de tipoFactura o cotizacionSelect
        // Si la factura tiene cotización, el change de tipoFactura ya deshabilitó montoTotal
        // Si no tiene cotización, quedará habilitado (aunque se recalculará al cargar productos).
    }

    if (tipoFactura === 'ConCotizacion') {
        const idCotizacion = fact.cotizacion?.idCotizacion || '';
        document.getElementById('cotizacionSelect').value = idCotizacion;
        // Disparar el evento change de cotizacionSelect para cargar y deshabilitar campos
        document.getElementById('cotizacionSelect').dispatchEvent(new Event('change'));
        // Esto sobrescribirá los valores cargados arriba con los de la cotización, lo cual es correcto.
    } else {
        // Para facturas simples, solo cargamos los valores guardados.
        // El montoTotal se recalculará si se llama a renderDetalleFactura o actualizarMontoTotal
        // a menos que se deshabilite el campo aquí o se modifique la lógica de cálculo.
        // Si el campo montoTotalInput se dejó habilitado en el change de tipoFactura,
        // el usuario podrá ver y posiblemente editar el valor guardado.
    }

    // ✅ CARGAR DETALLES DE LA FACTURA
    if (fact.detalleFactura && Array.isArray(fact.detalleFactura)) {
        detalleFactura = fact.detalleFactura.map(df => {
            const producto = productosData.find(p => p.idProducto === df.idProducto);
            const nombreProducto = producto?.nombre || df.nombreProducto || 'Producto desconocido';

            return {
                idProducto: df.idProducto,
                nombreProducto: nombreProducto,
                cantidad: df.cantidad,
                precioUnitario: df.precioUnitario,
                subtotal: df.subtotal
            };
        });
        renderDetalleFactura(); // Mostrar productos en la UI y recalcular monto total si es simple
        // Si es con cotización, renderDetalleFactura no debería recalcular montoTotal porque está deshabilitado
        // y actualizarMontoTotal debería retornar al inicio si hay cotización seleccionada.
    } else {
        detalleFactura = [];
        renderDetalleFactura(); // Esto llamará a actualizarMontoTotal si no hay cotización
    }

    currentEditId = id;
}

// Manejar envío del formulario
async function handleInvoiceFormSubmit(event) {
    event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;
    try {
        const formData = new FormData(event.target);
        const tipoFactura = document.getElementById('tipoFacturaSelect').value;
        const dniCliente = document.getElementById('clienteSelect').value;
        const fechaEmision = formData.get('fecha_emision');
        const estado = formData.get('estado');
        const observaciones = formData.get('observaciones');
        let idCotizacion = null;
        if (tipoFactura === 'ConCotizacion') {
            idCotizacion = document.getElementById('cotizacionSelect').value;
        }

        // ✅ OBTENER EL VALOR DEL MONTO TOTAL MANUALMENTE
        const montoTotalInput = document.querySelector('input[name="monto_total"]');
        let montoTotal = parseFloat(montoTotalInput.value) || 0;

        // ✅ CORRECCIÓN CLAVE: Agregar el valor manualmente al formData
        // Eliminar el campo anterior si existe
        formData.delete('monto_total');
        // Agregar el valor correcto
        formData.set('monto_total', montoTotal);

        // ✅ CORRECCIÓN CLAVE: Obtener valorServicio desde el input antes de usarlo
        const valorServicioInput = document.getElementById('valorServicio');
        const valorServicio = valorServicioInput ? parseFloat(valorServicioInput.value) || 0 : 0;

        const facturaData = {
            dniCliente,
            fechaEmision,
            montoTotal,
            estado,
            observaciones,
            tipoFactura,
            idCotizacion,
            valorServicio,
            detalleFactura: detalleFactura.map(item => ({
                idProducto: item.idProducto,
                cantidad: item.cantidad
            }))
        };

        console.log("🚀 Enviando datos de factura:", facturaData);

        const url = currentEditId ? `${API_FACTURAS_URL}/${currentEditId}` : API_FACTURAS_URL;
        const method = currentEditId ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(facturaData)
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `Error ${response.status}`);
        }
        alert(currentEditId ? "✅ Factura actualizada exitosamente." : "✅ Factura creada exitosamente.");
        closeModal('addInvoiceModal');
        await getAllFacturas();
    } catch (error) {
        console.error("Error:", error);
        alert(`❌ Error: ${error.message}`);
    } finally {
        isSubmitting = false;
    }
}

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('addInvoiceModal');
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        }

        // Renderizar tabla de facturas
        function renderTable(data) {
            const tbody = document.getElementById('invoicesTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">No hay facturas.</td></tr>';
                return;
            }

            data.forEach(fact => {
                const clienteNombre = fact.cliente?.nombre || clientesData.find(c => c.dni === fact.dniCliente)?.nombre || fact.dniCliente || 'N/A';
                const servicioDescripcion = fact.tipoFactura === 'ConCotizacion' && fact.cotizacion ? `Cotización #${fact.cotizacion.idCotizacion}` : (fact.observaciones || 'Servicio general');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fact.idFactura || 'N/A'}</td>
                    <td>${clienteNombre}</td>
                    <td>${servicioDescripcion}</td>
                    <td>${formatDate(fact.fechaEmision)}</td>
                    <td>${formatCurrency(fact.montoTotal)}</td>
                    <td><span class="status-badge ${(fact.estado || 'Pendiente').toLowerCase()}">${fact.estado || 'Pendiente'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-sm btn-details" onclick="viewInvoice('${fact.idFactura}')">🔍 Detalles</button>
                            <button class="btn-sm btn-edit" onclick="editInvoice('${fact.idFactura}')">✏️ Editar</button>
                            <button class="btn-sm btn-send" onclick="sendInvoice('${fact.idFactura}')">📧 Enviar</button>
                            <button class="btn-sm btn-delete" onclick="deleteInvoice('${fact.idFactura}')">🗑️ Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Obtener todas las facturas
        async function getAllFacturas() {
            try {
                const response = await fetch(API_FACTURAS_URL);
                if (!response.ok) throw new Error('Error al obtener facturas');
                allFacturas = await response.json();
                console.log("Facturas cargadas:", allFacturas.length);
                renderTable(allFacturas);
                updateStats();
            } catch (error) {
                console.error("Error al obtener facturas:", error);
                alert("Error al cargar la lista de facturas. Revisa la consola.");
            }
        }

        // Actualizar estadísticas
        function updateStats() {
            const total = allFacturas.length;
            const pendientes = allFacturas.filter(f => f.estado === 'Pendiente').length;
            const pagadas = allFacturas.filter(f => f.estado === 'Pagada').length;
            const ingresos = allFacturas.filter(f => f.estado === 'Pagada').reduce((sum, f) => sum + (f.montoTotal || 0), 0);

            document.getElementById('statFacturasTotal').textContent = total;
            document.getElementById('statFacturasPendientes').textContent = pendientes;
            document.getElementById('statFacturasPagadas').textContent = pagadas;
            document.getElementById('statIngresosTotal').textContent = formatCurrency(ingresos);
        }

        // Filtrar facturas
        function filterInvoices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            let filtered = allFacturas;

            if (searchTerm) {
                filtered = filtered.filter(f => f.idFactura.toLowerCase().includes(searchTerm) || f.dniCliente.toLowerCase().includes(searchTerm));
            }
            if (estadoFilter) {
                filtered = filtered.filter(f => f.estado === estadoFilter);
            }
            if (dateFrom) {
                filtered = filtered.filter(f => new Date(f.fechaEmision) >= new Date(dateFrom));
            }
            if (dateTo) {
                filtered = filtered.filter(f => new Date(f.fechaEmision) <= new Date(dateTo));
            }

            renderTable(filtered);
        }

        // Funciones de acciones (simuladas)
async function viewInvoice(id) {
    const fact = allFacturas.find(f => f.idFactura === id);
    if (!fact) {
        alert("Factura no encontrada.");
        return;
    }

    // Buscar cliente
    const cliente = clientesData.find(c => c.dni === fact.dniCliente) || fact.cliente || {};

    // Crear PDF
    const jsPDF = window.jspdf.jsPDF;
    const doc = new jsPDF('p', 'mm', 'a4');

    // Título
    doc.setFontSize(20);
    doc.setTextColor(44, 95, 65); // Verde oscuro
    doc.text('FACTURA', 105, 20, null, null, 'center');

    // Línea divisoria
    doc.setDrawColor(44, 95, 65);
    doc.line(20, 25, 190, 25);

    // Datos de la factura
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`ID: ${fact.idFactura || 'N/A'}`, 20, 35);
    doc.text(`Fecha Emisión: ${formatDate(fact.fechaEmision)}`, 20, 42);
    doc.text(`Estado: ${fact.estado || 'N/A'}`, 20, 49);
    doc.text(`Tipo: ${fact.tipoFactura || 'Simple'}`, 20, 56);

    // Datos del cliente
    doc.text(`Cliente: ${cliente.nombre || fact.nombreCliente || 'N/A'}`, 20, 68);
    doc.text(`DNI: ${cliente.dni || fact.dniCliente || 'N/A'}`, 20, 75);
    doc.text(`Teléfono: ${cliente.telefono || fact.telefonoCliente || 'N/A'}`, 20, 82);
    doc.text(`Correo: ${cliente.correo || fact.correoCliente || 'N/A'}`, 20, 89);

    // Línea divisoria
    doc.line(20, 95, 190, 95);

    // Títulos de columnas
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Producto', 20, 105);
    doc.text('Cant.', 120, 105);
    doc.text('Precio', 140, 105);
    doc.text('Subtotal', 160, 105);
    doc.setFont(undefined, 'normal');

    // Línea divisoria
    doc.line(20, 108, 190, 108);

    // Detalles de la factura
    let yPos = 118;
    let subtotalProductos = 0; // <-- Definir la variable

    if (fact.detalleFactura && fact.detalleFactura.length > 0) {
        for (const item of fact.detalleFactura) {
            // Buscar el nombre del producto en productosData
            const producto = productosData.find(p => p.idProducto === item.idProducto);
            const nombreProducto = producto?.nombre || item.nombreProducto || 'Producto desconocido';

            doc.text(nombreProducto, 20, yPos);
            doc.text(item.cantidad?.toString() || '0', 120, yPos);
            doc.text(formatCurrency(item.precioUnitario).replace('$', ''), 140, yPos);
            doc.text(formatCurrency(item.subtotal).replace('$', ''), 160, yPos);
            subtotalProductos += item.subtotal || 0;
            yPos += 8;
        }
    } else {
        doc.text('No hay productos en esta factura.', 20, yPos);
        yPos += 8;
    }


    // Valor Servicio
    let valorServicio = 0;
    // Verificar si el valor existe y es numérico o convertible a número
    if (fact.valorServicio != null && fact.valorServicio !== '') {
        valorServicio = parseFloat(fact.valorServicio) || 0;
    }
    yPos += 10;
    doc.setFont(undefined, 'bold');
    doc.text(`Valor Servicio: ${formatCurrency(valorServicio).replace('$', '')}`, 140, yPos);
    yPos += 8;

    // Línea divisoria antes del total
    doc.line(20, yPos, 190, yPos);
    yPos += 10;

    // Total final (productos + servicio)
    const totalFinal = subtotalProductos + valorServicio;
    doc.setFont(undefined, 'bold');
    doc.text(`TOTAL: ${formatCurrency(totalFinal).replace('$', '')}`, 140, yPos);

    // Observaciones
    if (fact.observaciones) {
        yPos += 15;
        doc.setFont(undefined, 'normal');
        doc.text('Observaciones:', 20, yPos);
        doc.text(fact.observaciones, 20, yPos + 7);
    }

    // Pie de página
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text('Documento generado por Gemini Ambiental', 20, 285);

    // Abrir en nueva pestaña o descargar
    const confirmacion = confirm('¿Desea descargar la factura como PDF?');
    if (confirmacion) {
        doc.save(`Factura_${fact.idFactura || 'N/A'}.pdf`);
    } else {
        // Abrir en nueva pestaña para vista previa
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');
    }
}
        async function sendInvoice(id) {
            if (!confirm('¿Está seguro de enviar esta factura por correo electrónico?')) return;
            alert('✅ Factura enviada por correo electrónico.');
        }

        async function deleteInvoice(id) {
            if (!confirm('¿Está seguro de eliminar esta factura?')) return;
            try {
                const response = await fetch(`${API_FACTURAS_URL}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error al eliminar');
                await getAllFacturas();
                alert('✅ Factura eliminada exitosamente.');
            } catch (error) {
                console.error("Error al eliminar factura:", error);
                alert(`❌ Error al eliminar factura: ${error.message}`);
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();

            // Asignar el evento submit al formulario
            const invoiceForm = document.getElementById('invoiceForm');
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', handleInvoiceFormSubmit);
            } else {
                console.error("❌ No se encontró el formulario con ID 'invoiceForm'");
            }

            // Event Listeners adicionales
            document.getElementById('filterInvoicesButton').addEventListener('click', filterInvoices);
            document.getElementById('filterForm').addEventListener('submit', (e) => { e.preventDefault(); filterInvoices(); });
        });
    </script>
</body>
</html>