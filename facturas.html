<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - Gemini Ambiental Admin</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #2d3748;
}
/* A√±adir a elementos de texto para prevenir superposici√≥n */
.header-title h1,
.header-title p,
.modal-title,
.invoices-title,
.stat-number,
.stat-label,
.nav-tab,
.btn,
.btn-sm,
.status-badge,
.detalle-factura-container h4 {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Para elementos que deben mantener una l√≠nea */
.nav-tab,
.btn,
.btn-sm,
.status-badge {
    white-space: nowrap;
}

/* Para tablas */
.invoices-table th,
.invoices-table td {
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}
 .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: 
                        url('docs/assets/img/BackgroundMenu.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

.sidebar-header {
    padding: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logo-icon {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.logo-text h2 {
    font-size: 1.2em;
    margin-bottom: 0.2rem;
}

.logo-text p {
    font-size: 0.8em;
    opacity: 0.8;
}

.nav-menu {
    padding: 1rem 0;
}

.nav-item {
    margin: 0.5rem 1rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateX(5px);
}

.nav-icon {
    font-size: 1.2em;
    width: 24px;
    text-align: center;
}

.logout-section {
    position: absolute;
    bottom: 2rem;
    left: 1rem;
    right: 1rem;
}

.logout-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    width: 100%;
}

.logout-btn:hover {
    background: rgba(255, 107, 107, 0.3);
    transform: translateY(-2px);
}

.main-content {
    margin-left: 280px;
    padding: 2rem;
    min-height: 100vh;
}

.top-nav {
    background: white;
    padding: 1rem 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-tabs {
    display: flex;
    gap: 2rem;
}

.nav-tab {
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    color: #718096;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
}

.nav-tab:hover,
.nav-tab.active {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
    transform: translateY(-2px);
}

.header {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title h1 {
    color: #2c5f41;
    font-size: 2.5em;
    margin-bottom: 0.5rem;
}

.header-title p {
    color: #718096;
    font-size: 1.1em;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
}

.btn-secondary {
    background: #f7fafc;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
    background: white;
    border-color: #4a8b64;
}

.btn-send {
    background: #48bb78;
    color: white;
}

.btn-send:hover {
    background: #38a169;
}

.btn-delete {
    background: #f56565;
    color: white;
}

.btn-delete:hover {
    background: #e53e3e;
}

.btn-edit {
    background: #4299e1;
    color: white;
}

.btn-edit:hover {
    background: #3182ce;
}

.btn-details {
    background: #805ad5;
    color: white;
}

.btn-details:hover {
    background: #6b46c1;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.modal-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c5f41;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #718096;
}

.form-grid {
    display: grid;
    gap: 1rem;
}

.form-grid-2 {
    grid-template-columns: 1fr 1fr;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-weight: 600;
}

.form-control {
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    max-width: 100%;
}

.form-control:focus {
    outline: none;
    border-color: #4a8b64;
}

/* Ajuste espec√≠fico para el select de cotizaci√≥n y el input de fecha */
#cotizacionSelect,
input[type="date"] {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.invoices-section {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.invoices-header {
    padding: 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.invoices-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c5f41;
}

.table-container {
    overflow-x: auto;
}

.invoices-table {
    width: 100%;
    border-collapse: collapse;
}

.invoices-table th,
.invoices-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.invoices-table th {
    background: #f7fafc;
    color: #4a5568;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.invoices-table tr:hover {
    background: #f7fafc;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.pagada {
    background: #c6f6d5;
    color: #22543d;
}

.status-badge.pendiente {
    background: #e2e8f0;
    color: #4a5568;
}

.status-badge.cancelada {
    background: #fed7d7;
    color: #c53030;
}

.status-badge.vencida {
    background: #fed7d7;
    color: #c53030;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8em;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    width: auto;
    text-align: center;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.detalle-factura-container {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 12px;
    margin-top: 1rem;
    border: 1px solid #e2e8f0;
}

.detalle-factura-container h4 {
    color: #2c5f41;
    margin-bottom: 1rem;
    font-size: 1.1em;
}

.detalle-factura-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.detalle-factura-item:last-child {
    border-bottom: none;
}

.detalle-factura-controls {
    display: flex;
    gap: 0.5rem;
}

.detalle-factura-controls button {
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8em;
    border: none;
}

.detalle-factura-controls .remove-btn {
    background: #f56565;
    color: white;
}

.detalle-factura-controls .remove-btn:hover {
    background: #e53e3e;
}

.detalle-factura-controls .edit-btn {
    background: #4299e1;
    color: white;
}

.detalle-factura-controls .edit-btn:hover {
    background: #3182ce;
}

.add-product-btn {
    margin-top: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-color);
}

.stat-card.primary {
    --accent-color: #4a8b64;
}

.stat-card.warning {
    --accent-color: #f6ad55;
}

.stat-card.danger {
    --accent-color: #f56565;
}

.stat-card.info {
    --accent-color: #4299e1;
}

.stat-card.success {
    --accent-color: #48bb78;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    color: white;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
}

.stat-icon.warning {
    background: linear-gradient(135deg, #f6ad55, #ed8936);
}

.stat-icon.danger {
    background: linear-gradient(135deg, #f56565, #e53e3e);
}

.stat-icon.info {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.stat-icon.success {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #718096;
    font-size: 0.9em;
}

.filters-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }

    .main-content {
        margin-left: 0;
        padding: 1rem;
    }

    .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .filters-grid {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .top-nav {
        flex-direction: column;
        gap: 1rem;
    }

    .nav-tabs {
        justify-content: center;
        flex-wrap: wrap;
    }

    .form-grid-2 {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    .btn-sm {
        width: 100%;
        margin-bottom: 0.25rem;
    }
}
</style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">
                <img src="LogoMenu.png" alt="Gemini Ambiental" style="height: 60px; object-fit: contain;">
            </div>
        </div>
        <nav class="nav-menu">
    <div class="nav-item">
        <a href="dashboard.html" class="nav-link">
            <!-- Icono Dashboard: gr√°fico de barras -->
            <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
            <span>Dashboard</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="inventario.html" class="nav-link">
            <!-- Icono Inventario: caja -->
            <span class="nav-icon"><i class="fas fa-boxes"></i></span>
            <span>Inventario</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="agenda.html" class="nav-link active">
            <!-- Icono Agenda: calendario -->
            <span class="nav-icon"><i class="fas fa-calendar-alt"></i></span>
            <span>Agenda</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="personal.html" class="nav-link">
            <!-- Icono Personas: usuarios -->
            <span class="nav-icon"><i class="fas fa-users"></i></span>
            <span>Personas</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="cotizaciones.html" class="nav-link">
            <!-- Icono Cotizaciones: moneda/d√≥lar -->
            <span class="nav-icon"><i class="fas fa-money-bill-wave"></i></span>
            <span>Cotizaciones</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="facturas.html" class="nav-link">
            <!-- Icono Facturas: documento -->
            <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
            <span>Facturas</span>
        </a>
    </div>
    <div class="nav-item">
        <a href="servicios.html" class="nav-link">
            <!-- Icono Servicios: herramienta -->
            <span class="nav-icon"><i class="fas fa-wrench"></i></span>
            <span>Servicios</span>
        </a>
    </div>
</nav>
<div class="logout-section">
    <a href="index.html" class="logout-btn">
        <!-- Icono Cerrar Sesi√≥n: puerta saliendo -->
        <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
        <span>Cerrar Sesi√≥n</span>
    </a>
</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Facturas</h1>
                <p>Administraci√≥n de facturas emitidas</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddInvoiceModal()">‚ûï Agregar Factura</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <div class="stat-icon primary">üìÑ</div>
                </div>
                <div class="stat-number" id="statFacturasTotal">0</div>
                <div class="stat-label">Total Facturas</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">‚è≥</div>
                </div>
                <div class="stat-number" id="statFacturasPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">‚úÖ</div>
                </div>
                <div class="stat-number" id="statFacturasPagadas">0</div>
                <div class="stat-label">Pagadas</div>
            </div>
            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">üí∞</div>
                </div>
                <div class="stat-number" id="statIngresosTotal">0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <form id="filterForm">
                <div class="filters-grid">
                    <div class="form-group">
                        <label>Buscar factura</label>
                        <input type="text" class="form-control" placeholder="ID, cliente o monto" id="searchInput">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagada">Pagada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" class="form-control" id="dateFromFilter">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" class="form-control" id="dateToFilter">
                    </div>
                    <button class="btn btn-primary" type="button" id="filterInvoicesButton">üîç Filtrar</button>
                </div>
            </form>
        </div>

        <!-- Invoices Table -->
        <div class="invoices-section">
            <div class="invoices-header">
                <span class="invoices-title">Listado de Facturas</span>
            </div>
            <div class="table-container">
                <table class="invoices-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha Emisi√≥n</th>
                            <th>Monto Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Filas se llenan din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Factura -->
    <div class="modal" id="addInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Agregar Factura</h2>
                <button class="close-btn" onclick="closeModal('addInvoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <input type="hidden" id="invoiceIdInput">
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Factura *</label>
                        <select class="form-control" id="tipoFacturaSelect" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Simple">Factura Simple</option>
                            <option value="ConCotizacion">Factura con Cotizaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group" id="cotizacionField" style="display: none;">
                        <label>Cotizaci√≥n</label>
                        <select name="id_cotizacion" id="cotizacionSelect" class="form-control">
                            <option value="">Cargando cotizaciones...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select name="dni_cliente" id="clienteSelect" class="form-control" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Emisi√≥n *</label>
                        <input type="date" name="fecha_emision" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select name="estado" class="form-control" required>
                            <option value="">Seleccione estado</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="PAGADA">Pagada</option>
                            <option value="CANCELADA">Cancelada</option>
                        </select>
                    </div>
                                    <!-- Campo Valor Servicio -->   
<div class="form-grid form-grid-2">
    <div class="form-group">
        <label>Valor Servicio *</label>
        <input type="number" 
               name="valor_servicio"
               id="valorServicio" 
               class="form-control" 
               step="0.01"
               min="0" 
               max="9999999999.99"
               placeholder="Ej: 500000"
               required
               value="0">
    </div>
    <div class="form-group" id="montoTotalField">
        <label>Monto Total *</label>
        <input type="number" 
               name="monto_total" 
               class="form-control" 
               step="0.01"
               min="0"
               max="9999999999.99"
               required
               readonly
               style="background-color: #f8f9fa; font-weight: bold;">
    </div>
</div>
                </div>  
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea name="observaciones" class="form-control" rows="2"></textarea>
                </div>


                <!-- Secci√≥n de Productos (Solo para Factura Simple) -->
                <div id="productosSection" style="display: none;">
                    <h3 style="color: #2c5f41; margin-top: 1.5rem;">Productos del Inventario</h3>
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label>Producto</label>
                            <select id="productoSelect" class="form-control">
                                <option value="">Cargando productos...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="cantidadProducto" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    <button type="button" class="btn btn-info" onclick="verStockEnTiempoReal()" style="margin-top: 0.5rem; font-size: 0.8em;">üìä Verificar Stock</button>
                    <button type="button" class="btn btn-primary add-product-btn" id="addProductBtn">Agregar Producto</button>

                    <div class="detalle-factura-container">
                        <h4>Productos Agregados</h4>
                        <div id="detalleFacturaList">
                            <!-- Aqu√≠ se mostrar√°n los productos agregados -->
                        </div>
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addInvoiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Guardar Factura</button>
                </div>
            </form>
        </div>
    </div>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
        const API_BASE_URL = 'https://backendgeminiambienta-v4-0-428l.onrender.com/api';
        const API_FACTURAS_URL = `${API_BASE_URL}/facturas`;
        const API_CLIENTES_URL = `${API_BASE_URL}/personas/clientes`;
        const API_COTIZACIONES_URL = `${API_BASE_URL}/cotizaciones`;
        const API_PRODUCTOS_URL = `${API_BASE_URL}/productos`;

        
        let allFacturas = [];
        let clientesData = [];
        let cotizacionesData = [];
        let productosData = [];
        let currentEditId = null;
        let detalleFactura = []; // Array para almacenar los productos agregados
        let isSubmitting = false;

 // ‚úÖ MEJORAR LA CARGA INICIAL PARA INCLUIR DIAGN√ìSTICO
async function loadInitialData() {
    try {
        console.log("üîÑ Cargando datos iniciales con diagn√≥stico...");
        
        await Promise.all([
            loadClientes(),
            loadCotizaciones(),
            loadProductos()
        ]);
        
        // Ejecutar diagn√≥stico autom√°tico al cargar
        await diagnosticarYRepararStock();
        await getAllFacturas();
        
    } catch (error) {
        console.error("‚ùå Error al cargar datos iniciales:", error);
        alert("Error al cargar datos iniciales. Revisa la consola.");
    }
}

async function loadClientes() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(`${API_BASE_URL}/personas?rol=cliente`, { headers });
        if (!response.ok) {
            throw new Error(`Error al cargar clientes: ${response.status} ${response.statusText}`);
        }
        const personas = await response.json();
        clientesData = personas.filter(p => p.rol && p.rol.toLowerCase() === 'cliente');
        const select = document.getElementById('clienteSelect');
        if (!select) {
            console.error("‚ùå No se encontr√≥ el elemento #clienteSelect");
            return;
        }
        select.innerHTML = '<option value="">Seleccione un cliente</option>';
        clientesData.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.dni;
            option.textContent = `${cliente.nombre} - ${cliente.dni}`;
            select.appendChild(option);
        });
        console.log(`‚úÖ Clientes cargados: ${clientesData.length}`);
    } catch (error) {
        console.error("‚ùå Error al cargar clientes:", error);
        const select = document.getElementById('clienteSelect');
        if (select) {
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        }
    }
}

async function loadCotizaciones() {
    const token = localStorage.getItem('jwtToken');
    if (!token) return;
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_COTIZACIONES_URL, { headers });
        if (!response.ok) throw new Error('Error al cargar cotizaciones');
        cotizacionesData = await response.json();
        const select = document.getElementById('cotizacionSelect');
        if (!select) {
            console.error("‚ùå No se encontr√≥ el elemento #cotizacionSelect");
            return;
        }
        select.innerHTML = '<option value="">Seleccione una cotizaci√≥n</option>';
        cotizacionesData.forEach(cot => {
            const estado = cot.estado ? cot.estado.toLowerCase() : '';
            if (estado === 'aprobada' || estado === 'finalizada') {
                const option = document.createElement('option');
                option.value = cot.idCotizacion;
                const clienteNombre = cot.cliente?.nombre || cot.dniCliente || 'Cliente desconocido';
                const costoFormateado = formatCurrency(cot.costoTotalCotizacion || 0);
                option.textContent = `#${cot.idCotizacion} - ${clienteNombre} - $ ${costoFormateado} [${cot.estado}]`;
                select.appendChild(option);
            }
        });
        console.log(`‚úÖ Cotizaciones cargadas: ${cotizacionesData.length} (filtradas para facturar)`);
    } catch (error) {
        console.error("Error al cargar cotizaciones:", error);
        const select = document.getElementById('cotizacionSelect');
        if (select) {
            select.innerHTML = '<option value="">Error al cargar cotizaciones</option>';
        }
    }
}

async function loadProductos() {
    const token = localStorage.getItem('jwtToken');
    if (!token) return;
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_PRODUCTOS_URL, { headers });
        if (!response.ok) throw new Error('Error al cargar productos');
        productosData = await response.json();
        const select = document.getElementById('productoSelect');
        select.innerHTML = '<option value="">Seleccione un producto</option>';
        productosData.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.idProducto;
            option.textContent = `${prod.nombre} (${prod.idProducto}) - Stock: ${prod.stock}`;
            option.dataset.precio = prod.precioActual || 0;
            select.appendChild(option);
        });
    } catch (error) {
        console.error("Error al cargar productos:", error);
        document.getElementById('productoSelect').innerHTML = '<option value="">Error al cargar</option>';
    }
}

// ‚úÖ FUNCI√ìN AUXILIAR PARA FORMATEAR N√öMEROS SIN DECIMALES
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return '$ 0';
    
    // Redondear a miles antes de formatear
    const valorRedondeado = Math.round(value / 1000) * 1000;
    
    return '$ ' + new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(valorRedondeado);
}

function formatLargeNumber(value) {
    if (value >= 1000000000) {
        return (value / 1000000000).toFixed(2) + 'B';
    } else if (value >= 1000000) {
        return (value / 1000000).toFixed(2) + 'M';
    } else if (value >= 1000) {
        return (value / 1000).toFixed(2) + 'K';
    }
    return value.toString();
}
// ‚úÖ FUNCI√ìN CORREGIDA - Manejo simple del valor del servicio
function actualizarMontoTotal() {
    const valorServicioInput = document.getElementById('valorServicio');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    
    if (!montoTotalInput || !valorServicioInput) {
        console.error("‚ùå Campos no encontrados");
        return;
    }

    // ‚úÖ Obtener el valor exacto del servicio SIN conversiones adicionales
    let valorServicio = parseFloat(valorServicioInput.value) || 0;
    
    // Si el valor tiene formato (puntos para miles), limpiarlo
    if (typeof valorServicioInput.value === 'string' && valorServicioInput.value.includes('.')) {
        valorServicio = parseFloat(valorServicioInput.value.replace(/\./g, '')) || 0;
    }
    
    const subtotalProductos = detalleFactura.reduce((sum, item) => {
        return sum + (parseFloat(item.subtotal) || 0);
    }, 0);
    
    // ‚úÖ CALCULAR MONTO TOTAL EXACTO
    let montoTotal = subtotalProductos + valorServicio;
    
    // ‚úÖ NO aplicar redondeo autom√°tico, mantener el c√°lculo exacto
    montoTotalInput.value = montoTotal.toFixed(0);
    
    console.log("üí∞ C√°lculo monto total ACTUALIZADO:", {
        valorServicioInput: valorServicioInput.value,
        valorServicioCalculado: valorServicio,
        subtotalProductos: subtotalProductos,
        montoTotal: montoTotal
    });
}

// ‚úÖ EVENT LISTENER SIMPLIFICADO - Solo actualiza cuando hay cambios reales
function setupValorServicioEventListener() {
    const valorServicioInput = document.getElementById('valorServicio');
    
    if (valorServicioInput) {
        // Remover todos los event listeners anteriores
        valorServicioInput.removeEventListener('input', actualizarMontoTotal);
        valorServicioInput.removeEventListener('change', actualizarMontoTotal);
        
        // ‚úÖ NUEVO EVENT LISTENER SIMPLE
        valorServicioInput.addEventListener('input', function(e) {
            // Peque√±o delay para asegurar que el valor est√© actualizado
            setTimeout(actualizarMontoTotal, 100);
        });
        
        console.log("‚úÖ Event listener de valorServicio configurado correctamente");
    }
}

// ‚úÖ FUNCI√ìN AUXILIAR PARA LIMPIAR FORMATO DE N√öMEROS
function limpiarFormatoNumero(valor) {
    if (typeof valor === 'string') {
        // Remover todo excepto n√∫meros y punto decimal
        return valor.replace(/[^\d.,]/g, '')
                   .replace(/\./g, '')  // Remover puntos de miles
                   .replace(',', '.');  // Convertir coma decimal a punto
    }
    return valor;
}
// ‚úÖ EVENT LISTENER CORREGIDO - Maneja correctamente el formato de n√∫meros
function setupValorServicioEventListener() {
    const valorServicioInput = document.getElementById('valorServicio');
    
    if (valorServicioInput) {
        // Remover event listener anterior si existe
        valorServicioInput.removeEventListener('input', actualizarMontoTotal);
        
        // ‚úÖ NUEVO EVENT LISTENER - Maneja formato correcto
        valorServicioInput.addEventListener('input', function(e) {
            // Permitir solo n√∫meros, punto y coma
            let value = e.target.value.replace(/[^\d,]/g, '');
            
            // Reemplazar coma por punto para c√°lculos internos
            let valueForCalculation = value.replace(',', '.');
            
            // Validar que no exceda el m√°ximo
            const numericValue = parseFloat(valueForCalculation) || 0;
            if (numericValue > 9999999999.99) {
                value = '9999999999.99';
            }
            
            e.target.value = value;
            
            // Actualizar monto total
            actualizarMontoTotal();
        });
        
        console.log("‚úÖ Event listener de valorServicio configurado correctamente");
    }
}
// ‚úÖ FUNCI√ìN AUXILIAR PARA FORMATEAR N√öMEROS SIN DECIMALES
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return '$ 0';
    
    // Redondear a miles antes de formatear
    const valorRedondeado = Math.round(value / 1000) * 1000;
    
    return '$ ' + new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(valorRedondeado);
}

// Funci√≥n de prueba con producto alternativo
async function probarConProductoAlternativo() {
    // Limpiar detalle actual
    detalleFactura = [];
    
    // Buscar un producto que no sea PRD005 y tenga stock
    const productoAlternativo = productosData.find(p => 
        p.idProducto !== 'PRD005' && 
        p.stock > 0 &&
        p.idProducto !== "PRODUCTO_ELIMINADO"
    );
    
    if (productoAlternativo) {
        detalleFactura.push({
            idProducto: productoAlternativo.idProducto,
            nombreProducto: productoAlternativo.nombre,
            cantidad: 1,
            precioUnitario: productoAlternativo.precioActual,
            subtotal: productoAlternativo.precioActual
        });
        
        renderDetalleFactura();
        
        alert(`‚úÖ Usando producto alternativo: ${productoAlternativo.nombre} (Stock: ${productoAlternativo.stock})`);
    } else {
        alert('‚ùå No se encontraron productos alternativos con stock disponible');
    }
}

// ‚úÖ DIAGN√ìSTICO Y SOLUCI√ìN COMPLETA PARA STOCK
async function diagnosticarYRepararStock() {
    const token = localStorage.getItem('jwtToken');
    const headers = { 'Authorization': 'Bearer ' + token };
    
    console.log("üîç INICIANDO DIAGN√ìSTICO COMPLETO DE STOCK...");
    
    try {
        // 1. Obtener todos los productos
        const response = await fetch(API_PRODUCTOS_URL, { headers });
        if (!response.ok) throw new Error('Error al cargar productos');
        
        const productos = await response.json();
        
        // 2. Analizar cada producto
        console.log("üì¶ AN√ÅLISIS DE INVENTARIO:");
        let productosConProblemas = [];
        let productosConStock = [];
        
        productos.forEach(prod => {
            const estado = prod.stock > 0 ? '‚úÖ' : '‚ùå';
            console.log(`   ${estado} ${prod.idProducto}: ${prod.nombre} - Stock: ${prod.stock} - Precio: $${prod.precioActual}`);
            
            if (prod.stock <= 0) {
                productosConProblemas.push(prod);
            } else {
                productosConStock.push(prod);
            }
        });
        
        // 3. Mostrar resumen
        console.log(`üìä RESUMEN: ${productosConStock.length} con stock, ${productosConProblemas.length} sin stock`);
        
        // 4. Reparar autom√°ticamente productos sin stock
        if (productosConProblemas.length > 0) {
            console.log("üîÑ REPARANDO PRODUCTOS SIN STOCK...");
            
            for (const producto of productosConProblemas) {
                const updateData = {
                    stock: 10  // Stock m√≠nimo por defecto
                };
                
                try {
                    await fetch(`${API_PRODUCTOS_URL}/${producto.idProducto}`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(updateData)
                    });
                    console.log(`‚úÖ Stock reparado: ${producto.idProducto} -> 10 unidades`);
                } catch (error) {
                    console.error(`‚ùå Error reparando ${producto.idProducto}:`, error);
                }
            }
            
            alert(`‚úÖ Se repar√≥ el stock de ${productosConProblemas.length} productos. Ahora pueden usarse en facturas.`);
        } else {
            console.log("‚úÖ Todos los productos tienen stock suficiente.");
        }
        
        // 5. Actualizar datos locales
        await loadProductos();
        usarSoloProductosConStock();
        
        return true;
        
    } catch (error) {
        console.error("‚ùå Error en diagn√≥stico completo:", error);
        alert("‚ùå Error al diagnosticar stock: " + error.message);
        return false;
    }
}

// ‚úÖ FUNCI√ìN MEJORADA PARA USAR SOLO PRODUCTOS CON STOCK
function usarSoloProductosConStock() {
    const productosConStock = productosData.filter(p => p.stock > 0);
    
    console.log(`üîÑ Filtrando productos: ${productosData.length} total, ${productosConStock.length} con stock`);
    
    if (productosConStock.length === 0) {
        alert("‚ùå CR√çTICO: No hay productos con stock disponible. Contacte al administrador.");
        return false;
    }
    
    // Limpiar detalle actual de productos sin stock
    const detalleOriginal = detalleFactura.length;
    detalleFactura = detalleFactura.filter(item => {
        const producto = productosData.find(p => p.idProducto === item.idProducto);
        const tieneStock = producto && producto.stock > 0;
        
        if (!tieneStock) {
            console.warn(`‚ö†Ô∏è Removiendo producto sin stock: ${item.idProducto} - ${item.nombreProducto}`);
        }
        
        return tieneStock;
    });
    
    if (detalleOriginal !== detalleFactura.length) {
        console.warn(`‚ö†Ô∏è Se removieron ${detalleOriginal - detalleFactura.length} productos sin stock`);
    }
    
    // Actualizar select de productos
    const productoSelect = document.getElementById('productoSelect');
    productoSelect.innerHTML = '<option value="">Seleccione un producto con stock</option>';
    
    productosConStock.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod.idProducto;
        option.textContent = `${prod.nombre} (${prod.idProducto}) - Stock: ${prod.stock} - $${prod.precioActual}`;
        option.dataset.precio = prod.precioActual || 0;
        option.dataset.stock = prod.stock || 0;
        productoSelect.appendChild(option);
    });
    
    renderDetalleFactura();
    
    console.log("‚úÖ Filtrado completado. Productos disponibles:", productosConStock.map(p => p.idProducto));
    return true;
}

// AGREGAR event listener para valor servicio
document.getElementById('valorServicio').addEventListener('input', function() {
    actualizarMontoTotal();
});



        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        document.getElementById('valorServicio').addEventListener('input', actualizarMontoTotal);

// REEMPLAZAR completamente el event listener del tipo de factura:
document.getElementById('tipoFacturaSelect').addEventListener('change', function() {
    const tipoFactura = this.value;
    const cotizacionField = document.getElementById('cotizacionField');
    const productosSection = document.getElementById('productosSection');
    const montoTotalField = document.getElementById('montoTotalField');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const valorServicioInput = document.getElementById('valorServicio');
    const submitBtn = document.getElementById('submitBtn');

    if (tipoFactura === 'ConCotizacion') {
        cotizacionField.style.display = 'block';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = true;
        
        // Para facturas con cotizaci√≥n, el valor servicio viene de la cotizaci√≥n
        valorServicioInput.disabled = true;
        valorServicioInput.style.backgroundColor = '#f8f9fa';
        montoTotalInput.readOnly = true;
        montoTotalInput.style.backgroundColor = '#f8f9fa';
        
        submitBtn.textContent = currentEditId ? 'üíæ Guardar Cambios' : '‚úÖ Guardar Factura';

        const cotizacionSelect = document.getElementById('cotizacionSelect');
        if (cotizacionSelect.value) {
            cotizacionSelect.dispatchEvent(new Event('change'));
        }
    } else { 
        // Factura Simple
        cotizacionField.style.display = 'none';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = false;
        
        // Para facturas simples, permitir editar valor servicio
        valorServicioInput.disabled = false;
        valorServicioInput.style.backgroundColor = 'white';
        valorServicioInput.value = '0'; // Resetear a 0
        montoTotalInput.readOnly = true; // Se calcula autom√°ticamente
        montoTotalInput.style.backgroundColor = '#f8f9fa';
        
        submitBtn.textContent = currentEditId ? 'üíæ Guardar Cambios' : '‚úÖ Guardar Factura';
    }
    
    // Resetear campos dependientes
    document.getElementById('cotizacionSelect').value = '';
    detalleFactura = [];
    renderDetalleFactura();
});


// REEMPLAZAR el event listener de cambio de cotizaci√≥n:
document.getElementById('cotizacionSelect').addEventListener('change', function() {
    const cotizacionId = this.value;
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const valorServicioInput = document.getElementById('valorServicio');
    const tipoFactura = document.getElementById('tipoFacturaSelect').value;

    if (!montoTotalInput || !valorServicioInput) {
        console.error("‚ùå Campos no encontrados");
        return;
    }

    if (cotizacionId && tipoFactura === 'ConCotizacion') {
        const cotizacion = cotizacionesData.find(c => c.idCotizacion === cotizacionId);

        if (cotizacion) {
            let costoTotal = parseFloat(cotizacion.costoTotalCotizacion) || 0;
            let valorServicioCotizacion = parseFloat(cotizacion.valorServicio) || 0;

            if (isNaN(costoTotal) || costoTotal <= 0) {
                alert(`‚ö†Ô∏è La cotizaci√≥n seleccionada no tiene un costo total v√°lido.`);
                resetearCamposCotizacion();
                return;
            }

            // ‚úÖ CARGAR PRODUCTOS DE LA COTIZACI√ìN
            detalleFactura = [];
            if (cotizacion.detalleCotizacion && Array.isArray(cotizacion.detalleCotizacion)) {
                cotizacion.detalleCotizacion.forEach(item => {
                    if (!item.idProducto || item.idProducto === "PRODUCTO_ELIMINADO") {
                        console.warn("‚ö†Ô∏è Producto eliminado encontrado, omitiendo:", item);
                        return;
                    }

                    const producto = productosData.find(p => p.idProducto === item.idProducto);
                    if (!producto) {
                        console.warn("‚ö†Ô∏è Producto no encontrado:", item.idProducto);
                        return;
                    }

                    const precioUnitario = parseFloat(producto.precioActual) || 0;
                    const subtotal = precioUnitario * item.cantidad;
                    
                    detalleFactura.push({
                        idProducto: item.idProducto,
                        nombreProducto: item.nombreProducto || producto.nombre || 'Producto desconocido',
                        cantidad: item.cantidad,
                        precioUnitario: precioUnitario,
                        subtotal: subtotal
                    });
                });
            }

            renderDetalleFactura();

            // ‚úÖ CARGAR VALOR DEL SERVICIO DESDE COTIZACI√ìN
            valorServicioInput.value = valorServicioCotizacion.toFixed(2);
            
            // ‚úÖ CALCULAR Y ASIGNAR MONTO TOTAL
            const subtotalProductos = detalleFactura.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0);
            const montoTotalCalculado = subtotalProductos + valorServicioCotizacion;
            
            montoTotalInput.value = montoTotalCalculado.toFixed(2);

            // ‚úÖ ASIGNAR CLIENTE
            if (cotizacion.cliente?.dni) {
                clienteSelect.value = cotizacion.cliente.dni;
            } else if (cotizacion.dniCliente) {
                clienteSelect.value = cotizacion.dniCliente;
            }

            console.log("‚úÖ Cotizaci√≥n cargada:", {
                valorServicio: valorServicioCotizacion,
                subtotalProductos: subtotalProductos,
                montoTotal: montoTotalCalculado
            });

        } else {
            alert(`‚ö†Ô∏è Cotizaci√≥n no encontrada.`);
            resetearCamposCotizacion();
        }
    } else {
        resetearCamposCotizacion();
    }
});

// FUNCI√ìN AUXILIAR para resetear campos
function resetearCamposCotizacion() {
    const valorServicioInput = document.getElementById('valorServicio');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    
    if (valorServicioInput) valorServicioInput.value = '0';
    if (montoTotalInput) montoTotalInput.value = '0';
    if (clienteSelect) clienteSelect.disabled = false;
    
    detalleFactura = [];
    renderDetalleFactura();
}

// Agregar producto al detalle - VERSI√ìN MEJORADA
document.getElementById('addProductBtn').addEventListener('click', function() {
    const productoId = document.getElementById('productoSelect').value;
    const cantidad = parseInt(document.getElementById('cantidadProducto').value) || 0;

    if (!productoId) {
        alert('‚ö†Ô∏è Por favor, seleccione un producto.');
        return;
    }

    if (cantidad <= 0) {
        alert('‚ö†Ô∏è La cantidad debe ser mayor a 0.');
        return;
    }

    const producto = productosData.find(p => p.idProducto === productoId);
    if (!producto) {
        alert('‚ùå Producto no encontrado.');
        return;
    }

    // ‚úÖ CORRECCI√ìN: Validar que el producto no sea "PRODUCTO_ELIMINADO"
    if (productoId === "PRODUCTO_ELIMINADO") {
        alert('‚ùå No se puede agregar un producto eliminado.');
        return;
    }

    // ‚úÖ CORRECCI√ìN: Validar stock correctamente
    if (producto.stock < cantidad) {
        alert(`‚ùå Stock insuficiente. Disponible: ${producto.stock}`);
        return;
    }

    const precioUnitario = parseFloat(producto.precioActual) || 0;
    const subtotal = precioUnitario * cantidad;

    // ‚úÖ CORRECCI√ìN: Verificar si el producto ya existe
    const existingIndex = detalleFactura.findIndex(item => item.idProducto === productoId);
    
    if (existingIndex !== -1) {
        // Si ya existe, preguntar si quiere actualizar la cantidad
        if (confirm(`El producto "${producto.nombre}" ya est√° agregado. ¬øDesea actualizar la cantidad?`)) {
            const nuevaCantidadTotal = detalleFactura[existingIndex].cantidad + cantidad;
            
            if (producto.stock < nuevaCantidadTotal) {
                alert(`‚ùå Stock insuficiente. Disponible: ${producto.stock}, Ya agregado: ${detalleFactura[existingIndex].cantidad}`);
                return;
            }
            
            detalleFactura[existingIndex].cantidad = nuevaCantidadTotal;
            detalleFactura[existingIndex].subtotal = precioUnitario * nuevaCantidadTotal;
        } else {
            return;
        }
    } else {
        // Agregar nuevo producto
        detalleFactura.push({
            idProducto: productoId,
            nombreProducto: producto.nombre,
            cantidad: cantidad,
            precioUnitario: precioUnitario,
            subtotal: subtotal // ‚úÖ Asegurar que subtotal se calcule
        });
    }

    renderDetalleFactura();

    // Limpiar selecci√≥n
    document.getElementById('productoSelect').value = '';
    document.getElementById('cantidadProducto').value = '1';
    
    console.log("‚úÖ Producto agregado. Total productos:", detalleFactura.length);
});
// ‚úÖ FUNCI√ìN CORREGIDA - Captura el valor exacto del servicio
function prepararDatosFactura() {
    const valorServicioInput = document.getElementById('valorServicio');
    
    // ‚úÖ CORRECCI√ìN: Obtener el valor exacto y convertirlo correctamente
    let valorServicio = 0;
    if (valorServicioInput) {
        const valorServicioStr = valorServicioInput.value;
        // Convertir formato colombiano (puntos para miles, coma para decimales)
        valorServicio = parseFloat(valorServicioStr.replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    console.log("üìä Valor servicio capturado en prepararDatosFactura:", {
        valorInput: valorServicioInput?.value,
        valorConvertido: valorServicio
    });

    // ‚úÖ CORRECCI√ìN: Asegurar que todos los subtotales est√©n calculados
    detalleFactura.forEach(item => {
        if (!item.subtotal || isNaN(item.subtotal)) {
            item.subtotal = (item.precioUnitario || 0) * (item.cantidad || 0);
        }
    });

    // Filtrar productos v√°lidos
    const detalleFacturaFiltrado = detalleFactura.filter(item => 
        item.idProducto && 
        item.idProducto !== "PRODUCTO_ELIMINADO" && 
        item.idProducto !== "null" &&
        item.cantidad > 0 &&
        !isNaN(item.subtotal)
    );

    // Preparar detalle para enviar
    const detalleFacturaData = detalleFacturaFiltrado.map(item => ({
        idProducto: item.idProducto,
        cantidad: item.cantidad,
        precioUnitario: item.precioUnitario,
        subtotal: item.subtotal
    }));

    return {
        detalleFactura: detalleFacturaData,
        valorServicio: valorServicio
    };
}
// ‚úÖ FUNCI√ìN ACTUALIZADA - Muestra el valor del servicio en el resumen
function renderDetalleFactura() {
    const container = document.getElementById('detalleFacturaList');
    if (!container) {
        console.error("‚ùå No se encontr√≥ el contenedor detalleFacturaList");
        return;
    }

    if (detalleFactura.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #718096; padding: 1rem;">No hay productos agregados.</p>';
        actualizarMontoTotal();
        return;
    }

    container.innerHTML = '';
    
    let totalProductos = 0;
    
    detalleFactura.forEach((item, index) => {
        // ‚úÖ Asegurar que los c√°lculos sean correctos
        const subtotal = (item.precioUnitario || 0) * (item.cantidad || 0);
        item.subtotal = subtotal; // Actualizar en el array
        totalProductos += subtotal;

        const div = document.createElement('div');
        div.className = 'detalle-factura-item';
        div.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        `;
        
        div.innerHTML = `
            <div style="flex: 1;">
                <strong style="color: #2c5f41;">${item.nombreProducto}</strong><br>
                <small style="color: #718096;">ID: ${item.idProducto}</small><br>
                <span style="color: #4a5568; font-size: 0.9em;">
                    ${item.cantidad} x ${formatCurrency(item.precioUnitario || 0)} = 
                    <strong>${formatCurrency(subtotal || 0)}</strong>
                </span>
            </div>
            <div class="detalle-factura-controls" style="display: flex; gap: 0.5rem;">
                <button type="button" class="btn-sm edit-btn" onclick="editDetalleItem(${index})" 
                        style="background: #f6ad55; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;"
                        title="Editar cantidad">
                    ‚úèÔ∏è
                </button>
                <button type="button" class="btn-sm remove-btn" onclick="removeDetalleItem(${index})" 
                        style="background: #f56565; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;"
                        title="Eliminar producto">
                    üóëÔ∏è
                </button>
            </div>
        `;
        container.appendChild(div);
    });
    
    // ‚úÖ MOSTRAR RESUMEN CON VALOR DEL SERVICIO
    const valorServicioInput = document.getElementById('valorServicio');
    const valorServicio = valorServicioInput ? (parseFloat(valorServicioInput.value) || 0) : 0;
    
    const resumenDiv = document.createElement('div');
    resumenDiv.style.cssText = `
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f7fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    `;
    
    resumenDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Subtotal Productos:</span>
            <strong>${formatCurrency(totalProductos)}</strong>
        </div>
        ${valorServicio > 0 ? `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #2c5f41;">
            <span>Valor del Servicio:</span>
            <strong>${formatCurrency(valorServicio)}</strong>
        </div>
        ` : ''}
        <div style="display: flex; justify-content: space-between; border-top: 1px solid #e2e8f0; padding-top: 0.5rem; font-size: 1.1em;">
            <strong>Total:</strong>
            <strong style="color: #2c5f41;">${formatCurrency(totalProductos + valorServicio)}</strong>
        </div>
    `;
    container.appendChild(resumenDiv);
    
    actualizarMontoTotal();
    console.log("‚úÖ Productos renderizados:", detalleFactura.length, "Subtotal:", totalProductos, "Valor servicio:", valorServicio);
}
// Funci√≥n para verificar el token JWT
function verificarToken() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        console.warn("‚ùå No se encontr√≥ token en localStorage");
        return false;
    }

    try {
        // Decodificar el token para verificar expiraci√≥n (sin validar firma)
        const partes = token.split('.');
        if (partes.length !== 3) {
            console.error("‚ùå Token con formato inv√°lido");
            localStorage.removeItem('jwtToken');
            return false;
        }

        const payload = JSON.parse(atob(partes[1]));
        const expiraEn = payload.exp * 1000; // Convertir a milisegundos
        const ahora = Date.now();
        
        console.log("üîê Token info:", {
            expira: new Date(expiraEn).toLocaleString(),
            ahora: new Date(ahora).toLocaleString(),
            minutosRestantes: Math.round((expiraEn - ahora) / 1000 / 60)
        });
        
        if (ahora >= expiraEn) {
            console.warn("‚ö†Ô∏è Token expirado");
            localStorage.removeItem('jwtToken');
            return false;
        }
        
        console.log("‚úÖ Token v√°lido");
        return true;
    } catch (error) {
        console.error("‚ùå Error al verificar token:", error);
        localStorage.removeItem('jwtToken');
        return false;
    }
}
// Funci√≥n para limpiar productos eliminados del detalle
function limpiarProductosEliminados() {
    detalleFactura = detalleFactura.filter(item => 
        item.idProducto && 
        item.idProducto !== "PRODUCTO_ELIMINADO" && 
        item.idProducto !== "null" &&
        item.idProducto.trim() !== ""
    );
    renderDetalleFactura();
}

// Llamar esta funci√≥n antes de enviar el formulario
function validarDetalleFactura() {
    limpiarProductosEliminados();
    return detalleFactura.length > 0;
}
// Funci√≥n mejorada de validaci√≥n
function validarFacturaAntesDeEnviar(tipoFactura) {
    // Validar cliente
    const dniCliente = document.getElementById('clienteSelect').value;
    if (!dniCliente) {
        throw new Error('Debe seleccionar un cliente');
    }

    // Validar fecha
    const fechaEmision = document.querySelector('input[name="fecha_emision"]').value;
    if (!fechaEmision) {
        throw new Error('La fecha de emisi√≥n es obligatoria');
    }

    // Validar estado
    const estado = document.querySelector('select[name="estado"]').value;
    if (!estado) {
        throw new Error('Debe seleccionar un estado');
    }

    // Validar monto total
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const montoTotal = parseFloat(montoTotalInput?.value) || 0;
    if (montoTotal <= 0) {
        throw new Error('El monto total debe ser mayor a 0');
    }

    // Validar productos seg√∫n tipo de factura
    if (tipoFactura === 'ConCotizacion') {
        const idCotizacion = document.getElementById('cotizacionSelect').value;
        if (!idCotizacion) {
            throw new Error('Para facturas con cotizaci√≥n, debe seleccionar una cotizaci√≥n v√°lida');
        }
        
        // Para facturas con cotizaci√≥n, permitir sin productos
        if (detalleFactura.length === 0) {
            console.warn("‚ö†Ô∏è Factura con cotizaci√≥n sin productos - permitido");
        }
    } else {
        // Para facturas simples, permitir sin productos pero con valor de servicio
        const valorServicio = parseFloat(document.getElementById('valorServicio')?.value) || 0;
        if (detalleFactura.length === 0 && valorServicio <= 0) {
            throw new Error('Para facturas simples, debe agregar productos o especificar un valor de servicio');
        }
        
    }

    return true;
}
// Funci√≥n para diagnosticar problemas con facturas - VERSI√ìN MEJORADA
// Funci√≥n para diagnosticar problemas con facturas
async function diagnosticarFacturas() {
    console.log("üîç DIAGNOSTICANDO FACTURAS...");
    
    // Preparar datos de prueba
    const datosPrueba = {
        dniCliente: "444555666", // Usa un DNI que exista
        fechaEmision: new Date().toISOString().split('T')[0],
        montoTotal: 100000,
        estado: "PENDIENTE", // ‚úÖ Usar may√∫sculas como espera el backend
        observaciones: "Factura de prueba - diagn√≥stico",
        tipoFactura: "Simple",
        valorServicio: 50000,
        detalleFactura: [] // ‚úÖ Probar sin productos primero
    };

    console.log("üß™ Probando con datos:", JSON.stringify(datosPrueba, null, 2));
    
    try {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert("‚ùå No hay token de autenticaci√≥n");
            return null;
        }
        
        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };

        const response = await fetch(API_FACTURAS_URL, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(datosPrueba)
        });

        console.log("üì• Respuesta:", response.status, response.statusText);
        
        if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ √âXITO:", result);
            alert("‚úÖ Factura de prueba creada exitosamente");
            await getAllFacturas();
            return result;
        } else {
            const errorText = await response.text();
            console.error("‚ùå Error:", errorText);
            
            // Esto indica que el problema es del backend (generaci√≥n de IDs)
            if (errorText.includes("IdentifierGenerationException")) {
                alert("‚ùå Error del backend: Problema con la generaci√≥n de IDs de factura. Contacte al administrador.");
            } else {
                alert("‚ùå Error en prueba: " + errorText);
            }
            return null;
        }
    } catch (error) {
        console.error("‚ùå Error de red:", error);
        alert("‚ùå Error de red: " + error.message);
        return null;
    }
}


// Ejecutar en consola: diagnosticarFacturas()
        // Editar un item del detalle
        function editDetalleItem(index) {
            const item = detalleFactura[index];
            const nuevaCantidad = prompt(`Editar cantidad para "${item.nombreProducto}":`, item.cantidad);
            const cantidadNum = parseInt(nuevaCantidad);
            if (!isNaN(cantidadNum) && cantidadNum > 0) {
                const producto = productosData.find(p => p.idProducto === item.idProducto);
                if (producto && cantidadNum <= producto.stock) {
                    item.cantidad = cantidadNum;
                    item.subtotal = item.precioUnitario * cantidadNum;
                    renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
                } else {
                    alert(`‚ùå Stock insuficiente o cantidad inv√°lida. Disponible: ${producto.stock}`);
                }
            }
        }

        // Remover un item del detalle
        function removeDetalleItem(index) {
            if (confirm('¬øEst√° seguro de remover este producto del detalle?')) {
                detalleFactura.splice(index, 1);
                renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
            }
        }

// ‚úÖ FUNCI√ìN ACTUALIZADA - Configura correctamente el campo valor servicio
function openAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    const form = document.getElementById('invoiceForm');
    
    console.log("üîÑ Abriendo modal de factura...");
    
    // Resetear formulario COMPLETAMENTE
    form.reset();
    
    // Configurar valores por defecto
    document.getElementById('invoiceModalTitle').textContent = 'Agregar Nueva Factura';
    document.getElementById('submitBtn').textContent = 'Guardar Factura';
    document.getElementById('invoiceIdInput').value = '';
    
    // Mostrar/ocultar secciones seg√∫n tipo de factura
    document.getElementById('productosSection').style.display = 'block';
    document.getElementById('cotizacionField').style.display = 'none';
    
    // ‚úÖ CORRECCI√ìN: Configurar campo valor servicio
    const valorServicioInput = document.getElementById('valorServicio');
    if (valorServicioInput) {
        valorServicioInput.disabled = false;
        valorServicioInput.value = '0'; // ‚úÖ Valor por defecto
        valorServicioInput.style.backgroundColor = 'white';
        valorServicioInput.placeholder = 'Ej: 5000000';
        
        // ‚úÖ CONFIGURAR ATRIBUTOS PARA FORMATO CORRECTO
        valorServicioInput.setAttribute('inputmode', 'numeric');
        valorServicioInput.setAttribute('pattern', '[0-9,]*');
    }
    
    // Resetear tipo de factura
    document.getElementById('tipoFacturaSelect').value = 'Simple';
    
    // Limpiar y resetear detalle
    detalleFactura = [];
    
    // ‚úÖ CONFIGURAR EVENT LISTENER DEL VALOR SERVICIO
    setTimeout(() => {
        setupValorServicioEventListener();
        renderDetalleFactura();
    }, 100);
    
    // Establecer fecha por defecto (hoy)
    const today = new Date().toISOString().split('T')[0];
    const fechaInput = document.querySelector('input[name="fecha_emision"]');
    if (fechaInput) {
        fechaInput.value = today;
    }
    
    // Establecer estado por defecto
    const estadoSelect = document.querySelector('select[name="estado"]');
    if (estadoSelect) {
        estadoSelect.value = 'PENDIENTE';
    }
    
    // Limpiar cotizaci√≥n
    const cotizacionSelect = document.getElementById('cotizacionSelect');
    if (cotizacionSelect) {
        cotizacionSelect.value = '';
    }
    
    currentEditId = null;
    
    // Mostrar modal
    modal.classList.add('show');
    
    console.log("‚úÖ Modal de factura abierto y listo");
}
// ‚úÖ FUNCI√ìN ACTUALIZADA - Muestra el valor del servicio en formato correcto
async function editInvoice(id) {
    try {
        console.log(`‚úèÔ∏è Editando factura: ${id}`);
        
        // Buscar la factura en la lista local
        const factura = allFacturas.find(f => f.idFactura === id);
        if (!factura) {
            alert("‚ùå Factura no encontrada.");
            return;
        }
        
        console.log("üìã Factura encontrada para editar:", factura);

        // Abrir modal de edici√≥n PRIMERO
        openAddInvoiceModal();

        // Configurar modal para edici√≥n
        document.getElementById('invoiceModalTitle').textContent = 'Editar Factura';
        document.getElementById('submitBtn').textContent = 'Guardar Cambios';
        document.getElementById('invoiceIdInput').value = id;

        // ‚úÖ CORRECCI√ìN: Esperar para que el modal se renderice completamente
        setTimeout(async () => {
            // Establecer tipo de factura
            const tipoFactura = factura.tipoFactura === 'ConCotizacion' ? 'ConCotizacion' : 'Simple';
            document.getElementById('tipoFacturaSelect').value = tipoFactura;
            
            // Disparar evento change para actualizar campos visibles
            document.getElementById('tipoFacturaSelect').dispatchEvent(new Event('change'));

            // Rellenar datos del formulario
            const dniCliente = factura.cliente?.dni || factura.dniCliente;
            if (dniCliente) {
                const clienteSelect = document.getElementById('clienteSelect');
                if (clienteSelect) {
                    clienteSelect.value = dniCliente;
                    console.log("‚úÖ Cliente asignado:", dniCliente);
                }
            }

            // Fecha de emisi√≥n
            const fechaEmision = factura.fechaEmision ? 
                factura.fechaEmision.split('T')[0] : 
                new Date().toISOString().split('T')[0];
            const fechaInput = document.querySelector('input[name="fecha_emision"]');
            if (fechaInput) {
                fechaInput.value = fechaEmision;
                console.log("‚úÖ Fecha asignada:", fechaEmision);
            }

            // Estado - manejar diferentes formatos
            let estado = factura.estado || 'PENDIENTE';
            if (estado === 'Pendiente') estado = 'PENDIENTE';
            if (estado === 'Pagada') estado = 'PAGADA';
            if (estado === 'Cancelada') estado = 'CANCELADA';
            const estadoSelect = document.querySelector('select[name="estado"]');
            if (estadoSelect) {
                estadoSelect.value = estado;
                console.log("‚úÖ Estado asignado:", estado);
            }

            // Observaciones
            const observacionesTextarea = document.querySelector('textarea[name="observaciones"]');
            if (observacionesTextarea) {
                observacionesTextarea.value = factura.observaciones || '';
                console.log("‚úÖ Observaciones asignadas");
            }

            // ‚úÖ CORRECCI√ìN CR√çTICA: Cargar el valor del servicio en formato correcto
            const valorServicioInput = document.getElementById('valorServicio');
            if (valorServicioInput) {
                // Obtener el valor del servicio directamente de la factura
                let valorServicio = 0;
                
                if (factura.valorServicio !== null && factura.valorServicio !== undefined && factura.valorServicio !== 0) {
                    valorServicio = parseFloat(factura.valorServicio);
                    console.log("üí∞ Valor servicio encontrado en factura:", valorServicio);
                } else {
                    // Si no existe, calcularlo basado en el monto total y productos
                    const subtotalProductos = (factura.detalleFactura || []).reduce((sum, item) => {
                        const subtotal = parseFloat(item.subtotal) || (parseFloat(item.precioUnitario) || 0) * (parseInt(item.cantidad) || 0);
                        return sum + subtotal;
                    }, 0);
                    
                    const montoTotal = parseFloat(factura.montoTotal) || 0;
                    valorServicio = montoTotal - subtotalProductos;
                    
                    console.log("üí∞ Valor servicio calculado:", {
                        montoTotal: montoTotal,
                        subtotalProductos: subtotalProductos,
                        valorServicioCalculado: valorServicio
                    });
                    
                    if (valorServicio < 0) {
                        console.warn("‚ö†Ô∏è Valor servicio calculado negativo, estableciendo en 0");
                        valorServicio = 0;
                    }
                }
                
                // ‚úÖ CORRECCI√ìN: Mostrar el valor en formato colombiano (sin formato autom√°tico)
                valorServicioInput.value = valorServicio.toFixed(0); // Sin decimales
                console.log("‚úÖ Valor servicio asignado en formulario:", valorServicioInput.value);
                
                // Habilitar el campo para edici√≥n
                valorServicioInput.disabled = false;
                valorServicioInput.style.backgroundColor = 'white';
            }

            // Monto Total
            const montoTotalInput = document.querySelector('input[name="monto_total"]');
            if (montoTotalInput) {
                const montoTotalConvertido = convertirValorK(factura.montoTotal) || 0;
                montoTotalInput.value = montoTotalConvertido.toFixed(0); // Sin decimales
                console.log("‚úÖ Monto total asignado:", montoTotalConvertido);
            }

            // Manejar facturas con cotizaci√≥n
            if (tipoFactura === 'ConCotizacion') {
                const idCotizacion = factura.cotizacion?.idCotizacion || factura.idCotizacion || '';
                if (idCotizacion) {
                    setTimeout(() => {
                        const cotizacionSelect = document.getElementById('cotizacionSelect');
                        if (cotizacionSelect) {
                            cotizacionSelect.value = idCotizacion;
                            console.log("‚úÖ Cotizaci√≥n asignada:", idCotizacion);
                            cotizacionSelect.dispatchEvent(new Event('change'));
                        }
                    }, 500);
                }
            }

            // ‚úÖ CARGAR DETALLES DE LA FACTURA
            detalleFactura = [];
            console.log("üì¶ Procesando productos de la factura:", factura.detalleFactura);
            
            if (factura.detalleFactura && Array.isArray(factura.detalleFactura)) {
                factura.detalleFactura.forEach((df, index) => {
                    if (!df.idProducto || df.idProducto === "PRODUCTO_ELIMINADO") {
                        console.warn(`‚ö†Ô∏è Producto ${index + 1} inv√°lido, omitiendo:`, df);
                        return;
                    }
                    
                    const producto = productosData.find(p => p.idProducto === df.idProducto);
                    const nombreProducto = producto?.nombre || df.nombreProducto || 'Producto desconocido';
                    const precioUnitario = parseFloat(df.precioUnitario) || 0;
                    const cantidad = parseInt(df.cantidad) || 0;
                    const subtotal = parseFloat(df.subtotal) || (precioUnitario * cantidad);
                    
                    detalleFactura.push({
                        idProducto: df.idProducto,
                        nombreProducto: nombreProducto,
                        cantidad: cantidad,
                        precioUnitario: precioUnitario,
                        subtotal: subtotal
                    });
                    
                    console.log(`‚úÖ Producto ${index + 1} agregado:`, nombreProducto, cantidad, precioUnitario, "Subtotal:", subtotal);
                });
                console.log(`‚úÖ ${detalleFactura.length} productos cargados para edici√≥n`);
            } else {
                console.log("üì≠ No hay productos en esta factura");
            }

            // ‚úÖ FORZAR ACTUALIZACI√ìN DEL MONTO TOTAL
            setTimeout(() => {
                actualizarMontoTotal();
                renderDetalleFactura();
            }, 500);

            currentEditId = id;
            
            console.log("‚úÖ Modal de edici√≥n completamente configurado para:", id, 
                      "Valor servicio cargado:", valorServicioInput?.value);
            
        }, 500);

    } catch (error) {
        console.error("‚ùå Error inesperado al editar:", error);
        alert("‚ùå Error al cargar la factura para editar: " + error.message);
    }
}
          

// Funci√≥n de emergencia para diagnosticar el problema de stock
async function diagnosticarStockProducto() {
    const token = localStorage.getItem('jwtToken');
    const headers = { 'Authorization': 'Bearer ' + token };
    
    try {
        // Verificar el producto problem√°tico
        const response = await fetch(`${API_PRODUCTOS_URL}/PRD005`, { headers });
        console.log("üîç Estado del producto PRD005:", response.status);
        
        if (response.ok) {
            const producto = await response.json();
            console.log("üì¶ Producto PRD005:", producto);
            
            if (producto.stock === 0 || producto.stock < 0) {
                alert(`‚ö†Ô∏è Producto PRD005 tiene stock insuficiente: ${producto.stock}`);
                return false;
            }
        } else {
            console.error("‚ùå No se pudo obtener informaci√≥n del producto PRD005");
        }
        
        return true;
    } catch (error) {
        console.error("‚ùå Error al diagnosticar stock:", error);
        return false;
    }
}

// ‚úÖ FUNCI√ìN CORREGIDA - Mejor manejo de errores 500
async function handleInvoiceFormSubmit(event) {
    event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '‚è≥ Validando...';
    submitBtn.disabled = true;

    try {
        console.log("üîç INICIANDO VALIDACI√ìN COMPLETA...");

        // ‚úÖ 1. VALIDACI√ìN DEL VALOR DEL SERVICIO
        const valorServicioInput = document.getElementById('valorServicio');
        const valorServicio = valorServicioInput ? (parseFloat(valorServicioInput.value) || 0) : 0;
        
        console.log("üí∞ Valor servicio validado:", valorServicio);

        if (valorServicio < 0) {
            throw new Error('‚ùå El valor del servicio no puede ser negativo');
        }

        if (valorServicio > 9999999999.99) {
            throw new Error('‚ùå El valor del servicio excede el l√≠mite permitido');
        }

        // ‚úÖ 2. CONFIRMAR SI EL VALOR DEL SERVICIO ES CERO
        if (valorServicio === 0) {
            const confirmarCero = confirm(
                '‚ö†Ô∏è El Valor Servicio est√° en $0. ¬øEst√° seguro de que no hay valor de servicio para esta factura?\n\n' +
                'Cancelar = Editar el valor\nAceptar = Continuar con $0'
            );
            
            if (!confirmarCero) {
                valorServicioInput.focus();
                return;
            }
        }

        // ‚úÖ 3. ACTUALIZAR DATOS DE PRODUCTOS EN TIEMPO REAL
        console.log("üîÑ Actualizando datos de productos...");
        await loadProductos();
        
        // ‚úÖ 4. VALIDACI√ìN DETALLADA DE STOCK
        console.log("üì¶ Validando stock para cada producto...");
        
        let stockValido = true;
        let productosProblema = [];
        let stockDisponible = {};

        for (const item of detalleFactura) {
            const producto = productosData.find(p => p.idProducto === item.idProducto);
            
            if (!producto) {
                console.error(`‚ùå Producto no encontrado: ${item.idProducto}`);
                productosProblema.push(`${item.nombreProducto} (no encontrado en sistema)`);
                stockValido = false;
                continue;
            }

            stockDisponible[item.idProducto] = producto.stock;

            if (producto.stock <= 0) {
                console.error(`‚ùå Producto sin stock: ${item.idProducto} - Stock: ${producto.stock}`);
                productosProblema.push(`${item.nombreProducto} (sin stock disponible)`);
                stockValido = false;
            } else if (producto.stock < item.cantidad) {
                console.error(`‚ùå Stock insuficiente: ${item.idProducto} - Disponible: ${producto.stock}, Solicitado: ${item.cantidad}`);
                productosProblema.push(`${item.nombreProducto} (disponible: ${producto.stock}, solicitado: ${item.cantidad})`);
                stockValido = false;
            } else {
                console.log(`‚úÖ Stock v√°lido: ${item.idProducto} - Disponible: ${producto.stock}, Solicitado: ${item.cantidad}`);
            }
        }

        // ‚úÖ 5. MANEJO DE ERRORES DE STOCK
        if (!stockValido) {
            const mensajeError = `‚ùå PROBLEMAS DE STOCK DETECTADOS:\n\n${productosProblema.join('\n')}\n\nStock actual disponible:\n${Object.entries(stockDisponible).map(([id, stock]) => `‚Ä¢ ${id}: ${stock} unidades`).join('\n')}\n\n¬øDesea ajustar autom√°ticamente las cantidades al stock disponible?`;
            
            if (confirm(mensajeError)) {
                // Ajustar autom√°ticamente las cantidades al stock disponible
                for (const item of detalleFactura) {
                    const producto = productosData.find(p => p.idProducto === item.idProducto);
                    if (producto && item.cantidad > producto.stock) {
                        console.log(`üîÑ Ajustando ${item.idProducto}: ${item.cantidad} -> ${producto.stock}`);
                        item.cantidad = producto.stock;
                        item.subtotal = item.precioUnitario * producto.stock;
                    }
                }
                
                renderDetalleFactura();
                alert("‚úÖ Cantidades ajustadas al stock disponible. Revise los cambios antes de guardar.");
                
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                isSubmitting = false;
                return;
            } else {
                throw new Error(`Ajuste las cantidades manualmente:\n${productosProblema.join('\n')}`);
            }
        }

        console.log("‚úÖ Validaci√≥n de stock completada - Todo correcto");
        submitBtn.textContent = '‚è≥ Preparando datos...';

        // ‚úÖ 6. VALIDACI√ìN DE MONTO TOTAL
        const montoTotalInput = document.querySelector('input[name="monto_total"]');
        let montoTotal = parseFloat(montoTotalInput?.value) || 0;
        
        if (montoTotal <= 0) {
            throw new Error('El monto total debe ser mayor a 0. Verifique los productos y el valor del servicio.');
        }

        if (montoTotal > 9999999.99) {
            throw new Error('El monto total excede el l√≠mite permitido.');
        }

        // ‚úÖ 7. OBTENER DATOS DEL FORMULARIO CON VALIDACIONES
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            throw new Error('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        }

        const tipoFactura = document.getElementById('tipoFacturaSelect').value;
        const dniCliente = document.getElementById('clienteSelect').value;
        const fechaEmision = document.querySelector('input[name="fecha_emision"]').value;
        const estado = document.querySelector('select[name="estado"]').value;
        const observaciones = document.querySelector('textarea[name="observaciones"]').value || '';

        // Validaciones b√°sicas
        if (!dniCliente) throw new Error('Debe seleccionar un cliente');
        if (!fechaEmision) throw new Error('La fecha de emisi√≥n es obligatoria');
        if (!estado) throw new Error('Debe seleccionar un estado para la factura');

        let idCotizacion = null;
        if (tipoFactura === 'ConCotizacion') {
            idCotizacion = document.getElementById('cotizacionSelect').value;
            if (!idCotizacion) {
                throw new Error('Para facturas con cotizaci√≥n, debe seleccionar una cotizaci√≥n v√°lida');
            }
        }

        // ‚úÖ 8. PREPARAR DETALLE CON VALIDACI√ìN EXTRA
        const { detalleFactura: detalleFacturaData, valorServicio: valorServicioValidado } = prepararDatosFactura();
        
        // Validar que haya al menos productos o valor de servicio
        if (detalleFacturaData.length === 0 && valorServicioValidado <= 0) {
            throw new Error('Debe agregar al menos un producto o especificar un valor de servicio');
        }

        // ‚úÖ 9. ESTRUCTURA DE DATOS FINAL - INCLUYENDO VALOR_SERVICIO
        const facturaData = {
            dniCliente: dniCliente,
            fechaEmision: fechaEmision,
            montoTotal: montoTotal,
            estado: estado,
            observaciones: observaciones,
            tipoFactura: tipoFactura,
            valorServicio: valorServicioValidado, // ‚úÖ ESTE ES EL CAMPO CLAVE QUE SE ENV√çA
            detalleFactura: detalleFacturaData
        };

        if (idCotizacion) facturaData.idCotizacion = idCotizacion;

        console.log("üöÄ ENVIANDO FACTURA CON DATOS VALIDADOS:", facturaData);

        // ‚úÖ 10. ENV√çO AL SERVIDOR CON MEJOR MANEJO DE ERRORES
        const url = currentEditId ? `${API_FACTURAS_URL}/${currentEditId}` : API_FACTURAS_URL;
        const method = currentEditId ? 'PUT' : 'POST';

        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        submitBtn.textContent = '‚è≥ Enviando al servidor...';

        const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(facturaData)
        });

        console.log("üì• RESPUESTA DEL SERVIDOR:", {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });

        if (!response.ok) {
            let errorDetails = '';
            try {
                const errorText = await response.text();
                console.error("‚ùå TEXTO DE ERROR:", errorText);
                
                // ‚úÖ CORRECCI√ìN: Manejar espec√≠ficamente errores 500
                if (response.status === 500) {
                    // Intentar parsear el error como JSON
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorDetails = errorJson.message || errorJson.error || 'Error interno del servidor';
                        
                        // ‚úÖ DETECTAR PROBLEMAS ESPEC√çFICOS
                        if (errorDetails.includes('valorServicio') || errorDetails.includes('valor_servicio')) {
                            errorDetails = "‚ùå PROBLEMA CON EL VALOR DEL SERVICIO:\n\n" + 
                                         "El servidor rechaz√≥ el valor del servicio enviado.\n" +
                                         "Posibles causas:\n" +
                                         "‚Ä¢ Formato incorrecto del n√∫mero\n" +
                                         "‚Ä¢ Valor fuera de rango\n" +
                                         "‚Ä¢ Campo no reconocido por el backend\n\n" +
                                         "Detalle t√©cnico: " + errorDetails;
                        } else if (errorDetails.includes('stock') || errorDetails.includes('Stock')) {
                            errorDetails = "‚ùå PROBLEMA DE STOCK EN EL SERVIDOR:\n\n" + errorDetails;
                        } else if (errorDetails.includes('constraint') || errorDetails.includes('Constraint')) {
                            errorDetails = "‚ùå ERROR DE BASE DE DATOS:\n\n" + errorDetails;
                        }
                    } catch (jsonError) {
                        errorDetails = 'Error interno del servidor (no se pudo parsear la respuesta)';
                    }
                } else {
                    errorDetails = errorText;
                }
            } catch (e) {
                errorDetails = 'No se pudo leer la respuesta del servidor';
            }

            let errorMessage = '';
            switch (response.status) {
                case 500:
                    errorMessage = "‚ùå ERROR INTERNO DEL SERVIDOR (500)\n\n" + 
                                 "El servidor encontr√≥ un error inesperado al procesar la factura.\n\n" +
                                 "Posibles causas:\n" +
                                 "‚Ä¢ Problema con el formato de los datos enviados\n" +
                                 "‚Ä¢ Error en la base de datos\n" +
                                 "‚Ä¢ Campo 'valorServicio' no reconocido\n" +
                                 "‚Ä¢ Problema de validaci√≥n en el backend\n\n" +
                                 "Detalles t√©cnicos:\n" + errorDetails;
                    break;
                case 400:
                    errorMessage = "‚ùå DATOS INV√ÅLIDOS (400)\n\n" + errorDetails;
                    break;
                case 404:
                    errorMessage = "‚ùå RECURSO NO ENCONTRADO (404)\n\n" + errorDetails;
                    break;
                default:
                    errorMessage = `‚ùå ERROR ${response.status}\n\n${errorDetails}`;
            }
            
            throw new Error(errorMessage);
        }

        // ‚úÖ 11. PROCESAR RESPUESTA EXITOSA
        const result = await response.json();
        console.log("‚úÖ FACTURA GUARDADA EXITOSAMENTE:", result);

        // Mostrar resumen de lo que se guard√≥
        const resumenProductos = detalleFacturaData.map(item => 
            `‚Ä¢ ${item.cantidad} x ${productosData.find(p => p.idProducto === item.idProducto)?.nombre || item.idProducto}`
        ).join('\n');
        
        alert(`‚úÖ ${currentEditId ? 'FACTURA ACTUALIZADA' : 'FACTURA CREADA'} EXITOSAMENTE\n\n` +
              `ID: ${result.idFactura || 'Nuevo'}\n` +
              `Cliente: ${dniCliente}\n` +
              `Monto Total: ${formatCurrency(montoTotal)}\n` +
              `Valor Servicio: ${formatCurrency(valorServicioValidado)}\n` +
              `Productos:\n${resumenProductos}`);

        closeModal('addInvoiceModal');
        await getAllFacturas();

    } catch (error) {
        console.error("‚ùå ERROR CR√çTICO AL GUARDAR FACTURA:", error);
        
        let mensajeUsuario = error.message;
        
        if (error.message.includes('valorServicio') || error.message.includes('valor del servicio')) {
            mensajeUsuario = "‚ùå PROBLEMA CON EL VALOR DEL SERVICIO\n\n" + 
                            "No se pudo guardar el valor del servicio.\n\n" +
                            "Sugerencias:\n" +
                            "1. Intente con un valor redondo (sin decimales)\n" +
                            "2. Verifique que el valor no sea demasiado grande\n" +
                            "3. Intente guardar sin valor de servicio primero\n\n" +
                            "Detalle: " + error.message;
        } else if (error.message.includes('stock') || error.message.includes('Stock')) {
            mensajeUsuario = "‚ùå PROBLEMA DE STOCK\n\n" + 
                            "No hay suficiente inventario para completar la operaci√≥n.\n\n" +
                            "Por favor:\n" +
                            "1. Revise las cantidades de productos\n" +
                            "2. Verifique el stock disponible\n" +
                            "3. Ajuste las cantidades o quite productos\n\n" +
                            "Detalle: " + error.message;
        }
        
        alert(mensajeUsuario);
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        isSubmitting = false;
    }
}

// ‚úÖ VER STOCK EN TIEMPO REAL
function verStockEnTiempoReal() {
    console.log("üìä STOCK EN TIEMPO REAL:");
    
    detalleFactura.forEach(item => {
        const producto = productosData.find(p => p.idProducto === item.idProducto);
        const stockDisponible = producto ? producto.stock : 0;
        const estado = item.cantidad <= stockDisponible ? '‚úÖ' : '‚ùå';
        
        console.log(`${estado} ${item.idProducto}: ${item.nombreProducto}`);
        console.log(`   Solicitado: ${item.cantidad}, Disponible: ${stockDisponible}, Diferencia: ${stockDisponible - item.cantidad}`);
    });
    
    // Mostrar en alerta tambi√©n
    const resumen = detalleFactura.map(item => {
        const producto = productosData.find(p => p.idProducto === item.idProducto);
        const stockDisponible = producto ? producto.stock : 0;
        const estado = item.cantidad <= stockDisponible ? '‚úÖ' : '‚ùå';
        return `${estado} ${item.nombreProducto}: ${item.cantidad}/${stockDisponible}`;
    }).join('\n');
    
    alert(`üìä VERIFICACI√ìN DE STOCK:\n\n${resumen}`);
}
        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('addInvoiceModal');
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        }

 function renderTable(data) {
    const tbody = document.getElementById('invoicesTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">No hay facturas.</td></tr>';
        return;
    }

    data.forEach(fact => {
        const clienteNombre = fact.cliente?.nombre || clientesData.find(c => c.dni === fact.dniCliente)?.nombre || fact.dniCliente || 'N/A';
        const servicioDescripcion = fact.tipoFactura === 'ConCotizacion' && fact.cotizacion ? `Cotizaci√≥n #${fact.cotizacion.idCotizacion}` : (fact.observaciones || 'Servicio general');
        
        // ‚úÖ CORRECCI√ìN: Aplicar redondeo al monto antes de mostrar
        const montoConvertido = convertirValorK(fact.montoTotal);
        const montoRedondeado = Math.round(montoConvertido / 1000) * 1000;
        
        const estadoDisplay = {
            'PENDIENTE': 'Pendiente',
            'PAGADA': 'Pagada', 
            'CANCELADA': 'Cancelada'
        }[fact.estado] || fact.estado;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${fact.idFactura || 'N/A'}</td>
            <td>${clienteNombre}</td>
            <td>${servicioDescripcion}</td>
            <td>${formatDate(fact.fechaEmision)}</td>
            <td>${formatCurrency(montoRedondeado)}</td>
            <td><span class="status-badge ${(fact.estado || 'PENDIENTE').toLowerCase()}">${estadoDisplay}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-sm btn-details" onclick="viewInvoice('${fact.idFactura}')">üîç Detalles</button>
                    <button class="btn-sm btn-edit" onclick="editInvoice('${fact.idFactura}')">‚úèÔ∏è Editar</button>
                    <button class="btn-sm btn-send" onclick="sendInvoice('${fact.idFactura}')">üìß Enviar</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}


// Obtener todas las facturas - VERSI√ìN CON CONVERSI√ìN FORZADA
async function getAllFacturas() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_FACTURAS_URL, { headers });
        if (!response.ok) throw new Error('Error al obtener facturas');
        
        allFacturas = await response.json();
        console.log("üìã Facturas cargadas:", allFacturas.length);
        
        // ‚úÖ CORRECCI√ìN CR√çTICA: Forzar conversi√≥n y limpiar formato
        allFacturas.forEach(factura => {
            console.log(`üîÑ Procesando factura ${factura.idFactura}:`, {
                montoOriginal: factura.montoTotal,
                tipoOriginal: typeof factura.montoTotal
            });
            
            // Convertir si es string con K
            if (typeof factura.montoTotal === 'string') {
                factura.montoTotal = convertirValorK(factura.montoTotal);
            }
            
            // Asegurar que sea n√∫mero
            factura.montoTotal = parseFloat(factura.montoTotal) || 0;
            
            console.log(`‚úÖ Factura ${factura.idFactura} convertida:`, factura.montoTotal);
        });
        
        renderTable(allFacturas);
        updateStats();
        
    } catch (error) {
        console.error("‚ùå Error al obtener facturas:", error);
        alert("Error al cargar la lista de facturas. Revisa la consola.");
    }
}

// FUNCI√ìN DE EMERGENCIA - Resetear completamente el formato
function resetearFormatoMoneda() {
    console.log("üîÑ RESETEANDO FORMATO DE MONEDA...");
    
    // 1. Redefinir formatCurrency
    window.formatCurrency = function(value) {
        if (value === null || value === undefined || isNaN(value)) return '$ 0';
        return '$ ' + new Intl.NumberFormat('es-CO').format(value);
    };
    
    // 2. Redefinir formatCurrencyForPDF  
    window.formatCurrencyForPDF = function(amount) {
        if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
        return '$ ' + new Intl.NumberFormat('es-CO').format(amount);
    };
    
    // 3. Forzar reconversi√≥n de todas las facturas
    allFacturas.forEach(factura => {
        factura.montoTotal = convertirValorK(factura.montoTotal);
    });
    
    // 4. Rerenderizar todo
    renderTable(allFacturas);
    updateStats();
    
    console.log("‚úÖ Formato de moneda reseteado completamente");
}

// Ejecutar en consola: resetearFormatoMoneda()
// Funci√≥n para diagnosticar la conversi√≥n de valores
function diagnosticarConversiones() {
    console.log("üîç DIAGN√ìSTICO DE CONVERSI√ìN:");
    
    allFacturas.forEach((factura, index) => {
        const original = factura.montoTotal;
        const convertido = convertirValorK(original);
        const formateado = formatCurrency(convertido);
        
        console.log(`Factura ${index + 1}:`, {
            original: original,
            convertido: convertido,
            formateado: formateado,
            tipo: typeof original
        });
    });
}

// Ejecutar en consola: diagnosticarConversiones()
// Funci√≥n para diagnosticar el problema del backend
async function diagnosticarBackend() {
    try {
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Authorization': 'Bearer ' + token };
        
        console.log("üîç Diagnosticando backend...");
        
        // Probar endpoint de facturas
        const response = await fetch(API_FACTURAS_URL, { headers });
        console.log("‚úÖ GET /facturas:", response.status);
        
        if (response.ok) {
            const facturas = await response.json();
            console.log(`‚úÖ ${facturas.length} facturas obtenidas`);
            
            // Probar cada factura individualmente
            for (let factura of facturas.slice(0, 3)) { // Probar solo las primeras 3
                console.log(`üîç Probando factura ${factura.idFactura}...`);
                const individualResponse = await fetch(`${API_FACTURAS_URL}/${factura.idFactura}`, { headers });
                console.log(`   ${factura.idFactura}:`, individualResponse.status);
                
                if (!individualResponse.ok) {
                    const errorText = await individualResponse.text();
                    console.error(`   ‚ùå Error:`, errorText);
                }
            }
        }
        
    } catch (error) {
        console.error("‚ùå Error en diagn√≥stico:", error);
    }
}

// Ejecutar en consola: diagnosticarBackend()
function updateStats() {
    try {
        const total = allFacturas.length;
        
        const pendientes = allFacturas.filter(f => 
            f.estado === 'PENDIENTE' || f.estado === 'Pendiente'
        ).length;
        
        const pagadas = allFacturas.filter(f => 
            f.estado === 'PAGADA' || f.estado === 'Pagada'
        ).length;
        
        // ‚úÖ CORRECCI√ìN: Convertir valores con "K" antes de sumar
        const ingresos = allFacturas
            .filter(f => f.estado === 'PAGADA' || f.estado === 'Pagada')
            .reduce((sum, f) => {
                const monto = convertirValorK(f.montoTotal) || 0;
                return sum + monto;
            }, 0);

        console.log("üìä Estad√≠sticas calculadas:", {
            total,
            pendientes,
            pagadas,
            ingresos
        });

        // Actualizar DOM
        document.getElementById('statFacturasTotal').textContent = total;
        document.getElementById('statFacturasPendientes').textContent = pendientes;
        document.getElementById('statFacturasPagadas').textContent = pagadas;
        document.getElementById('statIngresosTotal').textContent = formatCurrency(ingresos);

    } catch (error) {
        console.error("‚ùå Error al actualizar estad√≠sticas:", error);
    }
}
// ‚úÖ FUNCI√ìN CORREGIDA - Muestra claramente el valor del servicio en el PDF
async function viewInvoice(id) {
    try {
        console.log("üìÑ Generando PDF para factura:", id);
        
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Authorization': 'Bearer ' + token };
        
        // 1. Cargar datos de la factura
        const response = await fetch(`${API_FACTURAS_URL}/${id}`, { headers });
        if (!response.ok) throw new Error('Error al cargar factura');
        
        const factura = await response.json();
        console.log("üìã Factura cargada:", factura);

        // 2. Preparar datos - VERIFICAR QUE SE OBTIENE EL VALOR DEL SERVICIO
        const valorServicio = parseFloat(factura.valorServicio) || 0;
        const montoTotal = convertirValorK(factura.montoTotal) || 0;

        console.log("üîç VALORES PARA PDF:", {
            valorServicio: valorServicio,
            montoTotal: montoTotal,
            detalleFactura: factura.detalleFactura
        });

        // 3. Obtener informaci√≥n del cliente
        let clienteInfo = {};
        if (factura.cliente) {
            clienteInfo = factura.cliente;
        } else {
            clienteInfo = clientesData.find(c => c.dni === factura.dniCliente) || {
                nombre: 'Cliente no encontrado',
                dni: factura.dniCliente || 'N/A',
                telefono: 'N/A',
                correo: 'N/A'
            };
        }

        // 4. Crear PDF PROFESIONAL
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configuraci√≥n de m√°rgenes y colores
        const primaryColor = [44, 95, 65]; // Verde corporativo
        const margin = 20;
        let yPos = margin;

        // ‚úÖ ENCABEZADO PROFESIONAL
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('FACTURA DE VENTA', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text('Gemini Ambiental SAS', 105, 28, { align: 'center' });
        doc.text('NIT: 901.234.567-8', 105, 33, { align: 'center' });

        yPos = 50;

        // ‚úÖ INFORMACI√ìN DE LA FACTURA (2 columnas)
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DE LA FACTURA', margin, yPos);
        yPos += 10;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        doc.text(`N√∫mero: ${factura.idFactura}`, margin, yPos);
        doc.text(`Fecha: ${formatDateForPDF(factura.fechaEmision)}`, 105, yPos);
        yPos += 6;
        
        doc.text(`Estado: ${factura.estado}`, margin, yPos);
        doc.text(`Tipo: ${factura.tipoFactura || 'Simple'}`, 105, yPos);
        yPos += 15;

        // ‚úÖ INFORMACI√ìN DEL CLIENTE
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DEL CLIENTE', margin, yPos);
        yPos += 10;
        
        doc.setFont(undefined, 'normal');
        doc.text(`Nombre: ${clienteInfo.nombre}`, margin, yPos);
        yPos += 6;
        
        doc.text(`Documento: ${clienteInfo.dni}`, margin, yPos);
        yPos += 6;
        
        doc.text(`Tel√©fono: ${clienteInfo.telefono || 'N/A'}`, margin, yPos);
        yPos += 6;
        
        if (clienteInfo.correo) {
            doc.text(`Email: ${clienteInfo.correo}`, margin, yPos);
            yPos += 6;
        }
        
        yPos += 10;

        // ‚úÖ DETALLES DE LA FACTURA - TABLA PROFESIONAL
        doc.setFont(undefined, 'bold');
        doc.text('DETALLES DE LA FACTURA', margin, yPos);
        yPos += 8;

        // Encabezado de la tabla
        doc.setFillColor(240, 240, 240);
        doc.rect(margin, yPos, 170, 8, 'F');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        
        doc.text('Descripci√≥n', margin + 2, yPos + 6);
        doc.text('Cant.', margin + 100, yPos + 6);
        doc.text('Precio Unit.', margin + 120, yPos + 6);
        doc.text('Subtotal', margin + 170, yPos + 6, { align: 'right' });
        
        yPos += 12;

        // ‚úÖ PRODUCTOS/SERVICIOS
        const detalles = factura.detalleFactura || [];
        let subtotalProductos = 0;

        if (detalles.length > 0) {
            detalles.forEach((item, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = margin;
                }
                
                const nombre = item.nombreProducto || 'Producto/Servicio';
                const cantidad = item.cantidad || 1;
                const precio = parseFloat(item.precioUnitario) || 0;
                const subtotal = parseFloat(item.subtotal) || (precio * cantidad);
                subtotalProductos += subtotal;

                // Alternar colores de fila
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, yPos - 4, 170, 8, 'F');
                }

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                
                // Descripci√≥n (con wrap si es muy largo)
                const descLines = doc.splitTextToSize(nombre, 70);
                doc.text(descLines, margin + 2, yPos);
                
                doc.text(cantidad.toString(), margin + 100, yPos);
                doc.text(formatCurrencyForPDF(precio), margin + 120, yPos);
                doc.text(formatCurrencyForPDF(subtotal), margin + 170, yPos, { align: 'right' });
                
                yPos += Math.max(descLines.length * 4, 8);
            });
        }

        // ‚úÖ VALOR DEL SERVICIO - MOSTRAR COMO UN ITEM M√ÅS EN LA TABLA
        if (valorServicio > 0) {
            if (yPos > 250) {
                doc.addPage();
                yPos = margin;
            }
            
            // Espacio antes del valor del servicio
            yPos += 5;
            
            // Fila para valor del servicio con estilo diferente
            doc.setFillColor(230, 245, 230); // Verde claro
            doc.rect(margin, yPos - 4, 170, 10, 'F');
            
            doc.setTextColor(44, 95, 65); // Verde corporativo
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            
            doc.text('VALOR DEL SERVICIO', margin + 2, yPos + 2);
            doc.text('1', margin + 100, yPos + 2); // Cantidad 1
            doc.text(formatCurrencyForPDF(valorServicio), margin + 120, yPos + 2); // Precio unitario
            doc.text(formatCurrencyForPDF(valorServicio), margin + 170, yPos + 2, { align: 'right' }); // Subtotal
            
            yPos += 12;
        }

        // ‚úÖ RESUMEN DE TOTALES
        yPos += 10;
        
        // L√≠nea separadora
        doc.setDrawColor(200, 200, 200);
        doc.line(margin + 100, yPos, margin + 170, yPos);
        yPos += 8;

        // Subtotal productos (solo si hay productos)
        if (detalles.length > 0) {
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text('Subtotal Productos:', margin + 100, yPos);
            doc.text(formatCurrencyForPDF(subtotalProductos), margin + 170, yPos, { align: 'right' });
            yPos += 6;
        }

        // Valor servicio (solo si hay valor de servicio)
        if (valorServicio > 0) {
            doc.text('Valor del Servicio:', margin + 100, yPos);
            doc.text(formatCurrencyForPDF(valorServicio), margin + 170, yPos, { align: 'right' });
            yPos += 6;
        }

        // L√≠nea antes del total
        doc.setDrawColor(150, 150, 150);
        doc.line(margin + 100, yPos, margin + 170, yPos);
        yPos += 8;

        // ‚úÖ TOTAL FINAL
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...primaryColor);
        doc.text('TOTAL:', margin + 100, yPos);
        doc.text(formatCurrencyForPDF(montoTotal), margin + 170, yPos, { align: 'right' });

        // ‚úÖ VERIFICACI√ìN MATEM√ÅTICA (solo para debug)
        console.log("üîç VERIFICACI√ìN MATEM√ÅTICA EN PDF:", {
            subtotalProductos: subtotalProductos,
            valorServicio: valorServicio,
            sumaCalculada: subtotalProductos + valorServicio,
            montoTotalFactura: montoTotal
        });

        // ‚úÖ OBSERVACIONES
        yPos += 20;
        if (factura.observaciones) {
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('OBSERVACIONES:', margin, yPos);
            yPos += 6;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const obsLines = doc.splitTextToSize(factura.observaciones, 170);
            doc.text(obsLines, margin, yPos);
            yPos += obsLines.length * 5;
        }

        // ‚úÖ PIE DE P√ÅGINA PROFESIONAL
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            
            // L√≠nea separadora del footer
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, 275, 210 - margin, 275);
            
            // Informaci√≥n de la empresa
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Gemini Ambiental SAS - NIT: 901.234.567-8', margin, 282);
            doc.text('Tel: +57 1 234 5678 - Email: info@geminiambiental.com', margin, 287);
            
            // N√∫mero de p√°gina
            doc.text(`P√°gina ${i} de ${totalPages} - Generado el: ${new Date().toLocaleDateString('es-CO')}`, 
                    210 - margin, 287, { align: 'right' });
        }

        // ‚úÖ MOSTRAR/DESCARGAR
        const nombreArchivo = `Factura_${factura.idFactura}.pdf`;
        
        if (confirm('¬øDesea descargar el PDF?\n\nCancelar = Vista previa\nAceptar = Descargar')) {
            doc.save(nombreArchivo);
        } else {
            const pdfUrl = doc.output('bloburl');
            window.open(pdfUrl, '_blank');
        }
        
    } catch (error) {
        console.error("‚ùå Error al generar PDF:", error);
        alert("‚ùå Error: " + error.message);
    }
}

// ‚úÖ FUNCI√ìN DE PRUEBA PARA VERIFICAR EL PDF
function probarPDF() {
    console.log("üß™ Probando generaci√≥n de PDF...");
    
    // Crear datos de prueba
    const datosPrueba = {
        idFactura: "FAC_TEST",
        fechaEmision: new Date().toISOString(),
        estado: "PAGADA",
        tipoFactura: "Simple",
        dniCliente: "123456789",
        nombreCliente: "Cliente de Prueba",
        telefonoCliente: "3001234567",
        correoCliente: "cliente@test.com",
        detalleFactura: [
            {
                idProducto: "PROD001",
                nombreProducto: "Producto de Prueba Largo Nombre Para Ver Como Se Comporta",
                cantidad: 2,
                precioUnitario: 50000,
                subtotal: 100000
            },
            {
                idProducto: "PROD002", 
                nombreProducto: "Otro Producto",
                cantidad: 1,
                precioUnitario: 75000,
                subtotal: 75000
            }
        ],
        valorServicio: 50000,
        observaciones: "Esta es una factura de prueba para verificar el formato del PDF y asegurar que todas las columnas se alineen correctamente sin solapamientos."
    };
    
    console.log("üìã Datos de prueba:", datosPrueba);
    alert("Se han cargado datos de prueba. Ahora genera el PDF para ver el resultado.");
    
    // Simular que existe en allFacturas para la funci√≥n viewInvoice
    allFacturas.push(datosPrueba);
    
    return datosPrueba;
}
// ‚úÖ AGREGAR ESTA FUNCI√ìN FALTANTE - Col√≥cala despu√©s de formatLargeNumber
function convertirValorK(valor) {
    if (typeof valor === 'string') {
        // Caso 1: Valor con "K" (ej: "200,0 K", "219.999,98")
        if (valor.includes('K')) {
            const numero = parseFloat(valor.replace('K', '').replace(',', '.').replace(/\./g, '').trim());
            return !isNaN(numero) ? numero * 1000 : 0;
        }
        // Caso 2: Valor con formato de moneda (ej: "$ 200,0 K")
        if (valor.includes('$') && valor.includes('K')) {
            const numero = parseFloat(valor.replace('$', '').replace('K', '').replace(',', '.').replace(/\./g, '').trim());
            return !isNaN(numero) ? numero * 1000 : 0;
        }
        // Caso 3: Valor num√©rico como string con formato (ej: "219.999,98")
        const numeroLimpio = valor.replace(/\./g, '').replace(',', '.');
        return parseFloat(numeroLimpio) || 0;
    }
    return parseFloat(valor) || 0;
}
// ‚úÖ FUNCI√ìN MEJORADA - Formato profesional para PDF
function formatCurrencyForPDF(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
    
    // Redondear a miles
    let valorRedondeado = Math.round(amount / 1000) * 1000;
    
    return '$ ' + new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(valorRedondeado);
}

// ‚úÖ FUNCI√ìN MEJORADA - Formato de fecha profesional
function formatDateForPDF(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return 'Fecha inv√°lida';
    }
}
// Ejecutar en consola: probarPDF()
        async function sendInvoice(id) {
            if (!confirm('¬øEst√° seguro de enviar esta factura por correo electr√≥nico?')) return;
            alert('‚úÖ Factura enviada por correo electr√≥nico.');
        }

        // Funci√≥n helper para hacer requests autenticados
async function fetchAutenticado(url, options = {}) {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        throw new Error('No hay token de autenticaci√≥n');
    }

    const config = {
        ...options,
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            ...options.headers
        }
    };

    const response = await fetch(url, config);
    
    if (response.status === 401) {
        localStorage.removeItem('jwtToken');
        throw new Error('Sesi√≥n expirada');
    }
    
    return response;
}

// Funci√≥n de diagn√≥stico para tokens (ejecutar en consola)
function diagnosticarToken() {
    const token = localStorage.getItem('jwtToken');
    console.log("üîç Diagn√≥stico de Token:");
    console.log("‚úÖ Token presente:", !!token);
    
    if (token) {
        try {
            const partes = token.split('.');
            console.log("‚úÖ Token tiene 3 partes:", partes.length === 3);
            
            const payload = JSON.parse(atob(partes[1]));
            const expira = new Date(payload.exp * 1000);
            const ahora = new Date();
            const minutosRestantes = Math.round((payload.exp * 1000 - ahora.getTime()) / 1000 / 60);
            
            console.log("üìÖ Token expira:", expira.toLocaleString());
            console.log("‚è∞ Tiempo restante:", minutosRestantes, "minutos");
            console.log("üîë Payload:", payload);
            
            if (minutosRestantes < 5) {
                console.warn("‚ö†Ô∏è Token pronto a expirar!");
            }
            
        } catch (e) {
            console.error("‚ùå Token inv√°lido:", e);
        }
    }
    
    return !!token;
}
// Funci√≥n para filtrar facturas - COLOCAR ANTES DE DOMContentLoaded
function filterInvoices() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const estadoFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;

    let filtered = allFacturas;

    if (searchTerm) {
        filtered = filtered.filter(f => 
            f.idFactura?.toLowerCase().includes(searchTerm) || 
            f.dniCliente?.toLowerCase().includes(searchTerm) ||
            f.cliente?.nombre?.toLowerCase().includes(searchTerm) ||
            f.montoTotal?.toString().includes(searchTerm)
        );
    }
    
    if (estadoFilter) {
        filtered = filtered.filter(f => {
            const estadoFactura = f.estado || '';
            return estadoFactura.toUpperCase() === estadoFilter.toUpperCase();
        });
    }
    
    if (dateFrom) {
        filtered = filtered.filter(f => {
            const fechaFactura = new Date(f.fechaEmision);
            return fechaFactura >= new Date(dateFrom);
        });
    }
    
    if (dateTo) {
        filtered = filtered.filter(f => {
            const fechaFactura = new Date(f.fechaEmision);
            return fechaFactura <= new Date(dateTo);
        });
    }

    console.log(`üîç Filtradas ${filtered.length} de ${allFacturas.length} facturas`);
    renderTable(filtered);
}
// Ejecutar en consola: diagnosticarToken()
// ‚úÖ ACTUALIZAR LA INICIALIZACI√ìN
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Iniciando aplicaci√≥n de Facturas...");
    
    if (!verificarToken()) {
        alert('‚ùå Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }

    loadInitialData();

    // ‚úÖ CONFIGURAR EVENT LISTENERS CORRECTAMENTE
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', handleInvoiceFormSubmit);
        console.log("‚úÖ Evento submit asignado al formulario");
    }

    // ‚úÖ CONFIGURAR EVENT LISTENER DEL VALOR SERVICIO
    setupValorServicioEventListener();

    // Otros event listeners...
    console.log("‚úÖ Aplicaci√≥n de Facturas inicializada correctamente");
});
    </script>
</body>
</html>