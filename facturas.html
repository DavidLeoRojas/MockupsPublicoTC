<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - Gemini Ambiental Admin</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #2d3748;
}
/* A√±adir a elementos de texto para prevenir superposici√≥n */
.header-title h1,
.header-title p,
.modal-title,
.invoices-title,
.stat-number,
.stat-label,
.nav-tab,
.btn,
.btn-sm,
.status-badge,
.detalle-factura-container h4 {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Para elementos que deben mantener una l√≠nea */
.nav-tab,
.btn,
.btn-sm,
.status-badge {
    white-space: nowrap;
}

/* Para tablas */
.invoices-table th,
.invoices-table td {
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}
 .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: 
                        url('docs/assets/img/BackgroundMenu.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

.sidebar-header {
    padding: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logo-icon {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.logo-text h2 {
    font-size: 1.2em;
    margin-bottom: 0.2rem;
}

.logo-text p {
    font-size: 0.8em;
    opacity: 0.8;
}

.nav-menu {
    padding: 1rem 0;
}

.nav-item {
    margin: 0.5rem 1rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateX(5px);
}

.nav-icon {
    font-size: 1.2em;
    width: 24px;
    text-align: center;
}

.logout-section {
    position: absolute;
    bottom: 2rem;
    left: 1rem;
    right: 1rem;
}

.logout-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    width: 100%;
}

.logout-btn:hover {
    background: rgba(255, 107, 107, 0.3);
    transform: translateY(-2px);
}

.main-content {
    margin-left: 280px;
    padding: 2rem;
    min-height: 100vh;
}

.top-nav {
    background: white;
    padding: 1rem 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-tabs {
    display: flex;
    gap: 2rem;
}

.nav-tab {
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    color: #718096;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
}

.nav-tab:hover,
.nav-tab.active {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
    transform: translateY(-2px);
}

.header {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title h1 {
    color: #2c5f41;
    font-size: 2.5em;
    margin-bottom: 0.5rem;
}

.header-title p {
    color: #718096;
    font-size: 1.1em;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(74, 139, 100, 0.3);
}

.btn-secondary {
    background: #f7fafc;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
    background: white;
    border-color: #4a8b64;
}

.btn-send {
    background: #48bb78;
    color: white;
}

.btn-send:hover {
    background: #38a169;
}

.btn-delete {
    background: #f56565;
    color: white;
}

.btn-delete:hover {
    background: #e53e3e;
}

.btn-edit {
    background: #4299e1;
    color: white;
}

.btn-edit:hover {
    background: #3182ce;
}

.btn-details {
    background: #805ad5;
    color: white;
}

.btn-details:hover {
    background: #6b46c1;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.modal-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c5f41;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #718096;
}

.form-grid {
    display: grid;
    gap: 1rem;
}

.form-grid-2 {
    grid-template-columns: 1fr 1fr;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-weight: 600;
}

.form-control {
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    max-width: 100%;
}

.form-control:focus {
    outline: none;
    border-color: #4a8b64;
}

/* Ajuste espec√≠fico para el select de cotizaci√≥n y el input de fecha */
#cotizacionSelect,
input[type="date"] {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.invoices-section {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.invoices-header {
    padding: 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.invoices-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c5f41;
}

.table-container {
    overflow-x: auto;
}

.invoices-table {
    width: 100%;
    border-collapse: collapse;
}

.invoices-table th,
.invoices-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.invoices-table th {
    background: #f7fafc;
    color: #4a5568;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.invoices-table tr:hover {
    background: #f7fafc;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.pagada {
    background: #c6f6d5;
    color: #22543d;
}

.status-badge.pendiente {
    background: #e2e8f0;
    color: #4a5568;
}

.status-badge.cancelada {
    background: #fed7d7;
    color: #c53030;
}

.status-badge.vencida {
    background: #fed7d7;
    color: #c53030;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8em;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    width: auto;
    text-align: center;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.detalle-factura-container {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 12px;
    margin-top: 1rem;
    border: 1px solid #e2e8f0;
}

.detalle-factura-container h4 {
    color: #2c5f41;
    margin-bottom: 1rem;
    font-size: 1.1em;
}

.detalle-factura-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.detalle-factura-item:last-child {
    border-bottom: none;
}

.detalle-factura-controls {
    display: flex;
    gap: 0.5rem;
}

.detalle-factura-controls button {
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8em;
    border: none;
}

.detalle-factura-controls .remove-btn {
    background: #f56565;
    color: white;
}

.detalle-factura-controls .remove-btn:hover {
    background: #e53e3e;
}

.detalle-factura-controls .edit-btn {
    background: #4299e1;
    color: white;
}

.detalle-factura-controls .edit-btn:hover {
    background: #3182ce;
}

.add-product-btn {
    margin-top: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-color);
}

.stat-card.primary {
    --accent-color: #4a8b64;
}

.stat-card.warning {
    --accent-color: #f6ad55;
}

.stat-card.danger {
    --accent-color: #f56565;
}

.stat-card.info {
    --accent-color: #4299e1;
}

.stat-card.success {
    --accent-color: #48bb78;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    color: white;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #4a8b64, #2c5f41);
}

.stat-icon.warning {
    background: linear-gradient(135deg, #f6ad55, #ed8936);
}

.stat-icon.danger {
    background: linear-gradient(135deg, #f56565, #e53e3e);
}

.stat-icon.info {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.stat-icon.success {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #718096;
    font-size: 0.9em;
}

.filters-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }

    .main-content {
        margin-left: 0;
        padding: 1rem;
    }

    .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .filters-grid {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .top-nav {
        flex-direction: column;
        gap: 1rem;
    }

    .nav-tabs {
        justify-content: center;
        flex-wrap: wrap;
    }

    .form-grid-2 {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    .btn-sm {
        width: 100%;
        margin-bottom: 0.25rem;
    }
}
</style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">
                <img src="LogoMenu.png" alt="Gemini Ambiental" style="height: 60px; object-fit: contain;">
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="inventario.html" class="nav-link">
                    <span class="nav-icon">üì¶</span>
                    <span>Inventario</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="agenda.html" class="nav-link">
                    <span class="nav-icon">üìÖ</span>
                    <span>Agenda</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="personal.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    <span>Personas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cotizaciones.html" class="nav-link">
                    <span class="nav-icon">üí∞</span>
                    <span>Cotizaciones</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="facturas.html" class="nav-link active">
                    <span class="nav-icon">üìÑ</span>
                    <span>Facturas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="servicios.html" class="nav-link">
                    <span class="nav-icon">üîß</span>
                    <span>Servicios</span>
                </a>
            </div>
        </nav>
        <div class="logout-section">
            <a href="index.html" class="logout-btn">
                <span class="nav-icon">üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Facturas</h1>
                <p>Administraci√≥n de facturas emitidas</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">üì§ Exportar</button>
                <button class="btn btn-primary" onclick="openAddInvoiceModal()">‚ûï Agregar Factura</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <div class="stat-icon primary">üìÑ</div>
                </div>
                <div class="stat-number" id="statFacturasTotal">0</div>
                <div class="stat-label">Total Facturas</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">‚è≥</div>
                </div>
                <div class="stat-number" id="statFacturasPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">‚úÖ</div>
                </div>
                <div class="stat-number" id="statFacturasPagadas">0</div>
                <div class="stat-label">Pagadas</div>
            </div>
            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">üí∞</div>
                </div>
                <div class="stat-number" id="statIngresosTotal">0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <form id="filterForm">
                <div class="filters-grid">
                    <div class="form-group">
                        <label>Buscar factura</label>
                        <input type="text" class="form-control" placeholder="ID, cliente o monto" id="searchInput">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagada">Pagada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" class="form-control" id="dateFromFilter">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" class="form-control" id="dateToFilter">
                    </div>
                    <button class="btn btn-primary" type="button" id="filterInvoicesButton">üîç Filtrar</button>
                </div>
            </form>
        </div>

        <!-- Invoices Table -->
        <div class="invoices-section">
            <div class="invoices-header">
                <span class="invoices-title">Listado de Facturas</span>
                <span>
                    <button class="btn btn-secondary">‚¨áÔ∏è Descargar</button>
                </span>
            </div>
            <div class="table-container">
                <table class="invoices-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha Emisi√≥n</th>
                            <th>Monto Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Filas se llenan din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Factura -->
    <div class="modal" id="addInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Agregar Factura</h2>
                <button class="close-btn" onclick="closeModal('addInvoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <input type="hidden" id="invoiceIdInput">
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label>Tipo de Factura *</label>
                        <select class="form-control" id="tipoFacturaSelect" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Simple">Factura Simple</option>
                            <option value="ConCotizacion">Factura con Cotizaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group" id="cotizacionField" style="display: none;">
                        <label>Cotizaci√≥n</label>
                        <select name="id_cotizacion" id="cotizacionSelect" class="form-control">
                            <option value="">Cargando cotizaciones...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select name="dni_cliente" id="clienteSelect" class="form-control" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Emisi√≥n *</label>
                        <input type="date" name="fecha_emision" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select name="estado" class="form-control" required>
                            <option value="">Seleccione estado</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="PAGADA">Pagada</option>
                            <option value="CANCELADA">Cancelada</option>
                        </select>
                    </div>
                                    <!-- Campo Valor Servicio -->
                <div class="form-group">
                    <label>Valor Servicio</label>
<input type="number" 
       id="valorServicio" 
       class="form-control" 
       step="0.01"
       min="0" 
       max="9999999999.99"
       placeholder="Ej: 500000000">
                </div>
                    <!-- Campo Monto Total - Se oculta si es con cotizaci√≥n -->
                    <div class="form-group" id="montoTotalField">
                        <label>Monto Total *</label>
                       <input type="number" 
       name="monto_total" 
       class="form-control" 
       step="0.01"
       min="0"
       max="9999999999.99"  // ‚úÖ Hasta 10 mil millones
       required>
                    </div>
                </div>  
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea name="observaciones" class="form-control" rows="2"></textarea>
                </div>


                <!-- Secci√≥n de Productos (Solo para Factura Simple) -->
                <div id="productosSection" style="display: none;">
                    <h3 style="color: #2c5f41; margin-top: 1.5rem;">Productos del Inventario</h3>
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label>Producto</label>
                            <select id="productoSelect" class="form-control">
                                <option value="">Cargando productos...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" id="cantidadProducto" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary add-product-btn" id="addProductBtn">Agregar Producto</button>

                    <div class="detalle-factura-container">
                        <h4>Productos Agregados</h4>
                        <div id="detalleFacturaList">
                            <!-- Aqu√≠ se mostrar√°n los productos agregados -->
                        </div>
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addInvoiceModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Guardar Factura</button>
                </div>
            </form>
        </div>
    </div>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
        const API_BASE_URL = 'https://backendgeminiambienta-v4-0-428l.onrender.com/api';
        const API_FACTURAS_URL = `${API_BASE_URL}/facturas`;
        const API_CLIENTES_URL = `${API_BASE_URL}/personas/clientes`;
        const API_COTIZACIONES_URL = `${API_BASE_URL}/cotizaciones`;
        const API_PRODUCTOS_URL = `${API_BASE_URL}/productos`;

        
        let allFacturas = [];
        let clientesData = [];
        let cotizacionesData = [];
        let productosData = [];
        let currentEditId = null;
        let detalleFactura = []; // Array para almacenar los productos agregados
        let isSubmitting = false;

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadClientes(),
                    loadCotizaciones(),
                    loadProductos()
                ]);
                await getAllFacturas();
            } catch (error) {
                console.error("Error al cargar datos iniciales:", error);
                alert("Error al cargar datos iniciales. Revisa la consola.");
            }
        }

async function loadClientes() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(`${API_BASE_URL}/personas?rol=cliente`, { headers });
        if (!response.ok) {
            throw new Error(`Error al cargar clientes: ${response.status} ${response.statusText}`);
        }
        const personas = await response.json();
        clientesData = personas.filter(p => p.rol && p.rol.toLowerCase() === 'cliente');
        const select = document.getElementById('clienteSelect');
        if (!select) {
            console.error("‚ùå No se encontr√≥ el elemento #clienteSelect");
            return;
        }
        select.innerHTML = '<option value="">Seleccione un cliente</option>';
        clientesData.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.dni;
            option.textContent = `${cliente.nombre} - ${cliente.dni}`;
            select.appendChild(option);
        });
        console.log(`‚úÖ Clientes cargados: ${clientesData.length}`);
    } catch (error) {
        console.error("‚ùå Error al cargar clientes:", error);
        const select = document.getElementById('clienteSelect');
        if (select) {
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        }
    }
}

async function loadCotizaciones() {
    const token = localStorage.getItem('jwtToken');
    if (!token) return;
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_COTIZACIONES_URL, { headers });
        if (!response.ok) throw new Error('Error al cargar cotizaciones');
        cotizacionesData = await response.json();
        const select = document.getElementById('cotizacionSelect');
        if (!select) {
            console.error("‚ùå No se encontr√≥ el elemento #cotizacionSelect");
            return;
        }
        select.innerHTML = '<option value="">Seleccione una cotizaci√≥n</option>';
        cotizacionesData.forEach(cot => {
            const estado = cot.estado ? cot.estado.toLowerCase() : '';
            if (estado === 'aprobada' || estado === 'finalizada') {
                const option = document.createElement('option');
                option.value = cot.idCotizacion;
                const clienteNombre = cot.cliente?.nombre || cot.dniCliente || 'Cliente desconocido';
                const costoFormateado = formatCurrency(cot.costoTotalCotizacion || 0);
                option.textContent = `#${cot.idCotizacion} - ${clienteNombre} - $ ${costoFormateado} [${cot.estado}]`;
                select.appendChild(option);
            }
        });
        console.log(`‚úÖ Cotizaciones cargadas: ${cotizacionesData.length} (filtradas para facturar)`);
    } catch (error) {
        console.error("Error al cargar cotizaciones:", error);
        const select = document.getElementById('cotizacionSelect');
        if (select) {
            select.innerHTML = '<option value="">Error al cargar cotizaciones</option>';
        }
    }
}

async function loadProductos() {
    const token = localStorage.getItem('jwtToken');
    if (!token) return;
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_PRODUCTOS_URL, { headers });
        if (!response.ok) throw new Error('Error al cargar productos');
        productosData = await response.json();
        const select = document.getElementById('productoSelect');
        select.innerHTML = '<option value="">Seleccione un producto</option>';
        productosData.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.idProducto;
            option.textContent = `${prod.nombre} (${prod.idProducto}) - Stock: ${prod.stock}`;
            option.dataset.precio = prod.precioActual || 0;
            select.appendChild(option);
        });
    } catch (error) {
        console.error("Error al cargar productos:", error);
        document.getElementById('productoSelect').innerHTML = '<option value="">Error al cargar</option>';
    }
}

function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return '$ 0';
    
    // ‚úÖ CORRECCI√ìN DEFINITIVA: Mostrar valores COMPLETOS sin abreviaturas
    return '$ ' + new Intl.NumberFormat('es-CO').format(value);
}

function formatLargeNumber(value) {
    if (value >= 1000000000) {
        return (value / 1000000000).toFixed(2) + 'B';
    } else if (value >= 1000000) {
        return (value / 1000000).toFixed(2) + 'M';
    } else if (value >= 1000) {
        return (value / 1000).toFixed(2) + 'K';
    }
    return value.toString();
}
function actualizarMontoTotal() {
    const valorServicioInput = document.getElementById('valorServicio');
// En la funci√≥n handleInvoiceFormSubmit, agregar esta validaci√≥n:
const montoTotalInput = document.querySelector('input[name="monto_total"]');


// Si el monto total es 0 pero hay productos o valor de servicio, recalcular
if (montoTotal <= 0) {
    const valorServicio = parseFloat(document.getElementById('valorServicio')?.value) || 0;
    const subtotalProductos = detalleFactura.reduce((sum, item) => sum + (item.subtotal || 0), 0);
    montoTotal = valorServicio + subtotalProductos;
    
    if (montoTotal > 0) {
        montoTotalInput.value = montoTotal.toFixed(2);
    }
}

    // Si hay cotizaci√≥n seleccionada, no calcular autom√°ticamente
    const tieneCotizacion = document.getElementById('cotizacionSelect').value;
    if (tieneCotizacion) {
        return;
    }

    const valorServicio = parseFloat(valorServicioInput?.value) || 0;
    const subtotalProductos = detalleFactura.reduce((sum, item) => {
        const subtotal = parseFloat(item.subtotal) || 0;
        return sum + subtotal;
    }, 0);
    
    const montoTotal = subtotalProductos + valorServicio;

    // Validar que no sea NaN
    if (isNaN(montoTotal)) {
        console.error("‚ùå Error: montoTotal es NaN");
        montoTotalInput.value = '0';
        return;
    }

    montoTotalInput.value = montoTotal.toFixed(2);
    console.log("üí∞ C√°lculo monto total:", {
        valorServicio: valorServicio,
        subtotalProductos: subtotalProductos,
        montoTotal: montoTotal
    });
}

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        document.getElementById('valorServicio').addEventListener('input', actualizarMontoTotal);

// Manejar cambio de tipo de factura
document.getElementById('tipoFacturaSelect').addEventListener('change', function() {
    const tipoFactura = this.value;
    const cotizacionField = document.getElementById('cotizacionField');
    const productosSection = document.getElementById('productosSection');
    const montoTotalField = document.getElementById('montoTotalField');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const submitBtn = document.getElementById('submitBtn');
    const valorServicioInput = document.getElementById('valorServicio'); // ‚úÖ Obtener el campo de Valor del Servicio

    if (tipoFactura === 'ConCotizacion') {
        cotizacionField.style.display = 'block';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = true;
        submitBtn.textContent = currentEditId ? 'üíæ Guardar Cambios' : '‚úÖ Guardar Factura';

        const cotizacionSelect = document.getElementById('cotizacionSelect');
        if (cotizacionSelect.value) {
            cotizacionSelect.dispatchEvent(new Event('change')); // <-- Esto manejar√° valorServicio y montoTotal
        }
        // Si no hay cotizaci√≥n seleccionada a√∫n, los campos se habilitar√°n/deshabilitar√°n en el change de cotizacionSelect
    } else { // 'Simple'
        cotizacionField.style.display = 'none';
        productosSection.style.display = 'block';
        montoTotalField.style.display = 'block';
        clienteSelect.disabled = false;
        submitBtn.textContent = currentEditId ? 'üíæ Guardar Cambios' : '‚úÖ Guardar Factura';
        // ‚úÖ HABILITAR CAMPOS PARA FACTURAS SIMPLES
        if (valorServicioInput) {
            valorServicioInput.disabled = false;
        }
        if (montoTotalInput) {
            montoTotalInput.disabled = false; // Se puede dejar editable o calcularse autom√°ticamente
            // Si se deja calcularse, actualizarMontoTotal se encargar√° de ello
            // Si se deja editable, se debe eliminar o modificar la l√≥gica de renderDetalleFactura/actualizarMontoTotal
            // Para que no sobrescriba un valor ingresado manualmente.
            // Por ahora, asumiremos que se calcula autom√°ticamente.
        }
    }
    // Resetear campos dependientes
    document.getElementById('cotizacionSelect').value = '';
    detalleFactura = [];
    renderDetalleFactura(); // <-- Esto llamar√° a actualizarMontoTotal si no hay cotizaci√≥n
});


document.getElementById('cotizacionSelect').addEventListener('change', function() {
    const cotizacionId = this.value;
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const clienteSelect = document.getElementById('clienteSelect');
    const valorServicioInput = document.getElementById('valorServicio');

    if (!montoTotalInput) {
        console.error("‚ùå No se encontr√≥ el campo 'monto_total'");
        return;
    }

    if (!valorServicioInput) {
         console.error("‚ùå No se encontr√≥ el campo 'valorServicio'");
         return;
    }

    if (cotizacionId) {
        const cotizacion = cotizacionesData.find(c => c.idCotizacion === cotizacionId);

        if (cotizacion) {
            let costoTotal = parseFloat(cotizacion.costoTotalCotizacion) || 0;
            let valorServicioCotizacion = parseFloat(cotizacion.valorServicio) || 0;

            if (isNaN(costoTotal) || costoTotal <= 0) {
                alert(`‚ö†Ô∏è La cotizaci√≥n seleccionada no tiene un costo total v√°lido. Por favor, verifique los datos.`);
                valorServicioInput.value = '0';
                valorServicioInput.disabled = false;
                montoTotalInput.value = '0';
                montoTotalInput.disabled = false;
                clienteSelect.disabled = false;
                detalleFactura = [];
                renderDetalleFactura();
                return;
            }

            // ‚úÖ CORRECCI√ìN: Cargar productos de la cotizaci√≥n FILTRANDO productos eliminados
            detalleFactura = [];
            if (cotizacion.detalleCotizacion && Array.isArray(cotizacion.detalleCotizacion)) {
                cotizacion.detalleCotizacion.forEach(item => {
                    // ‚úÖ FILTRAR: No incluir productos eliminados o inv√°lidos
                    if (!item.idProducto || item.idProducto === "PRODUCTO_ELIMINADO") {
                        console.warn("‚ö†Ô∏è Producto eliminado encontrado en cotizaci√≥n, omitiendo:", item);
                        return;
                    }

                    const producto = productosData.find(p => p.idProducto === item.idProducto);
                    if (!producto) {
                        console.warn("‚ö†Ô∏è Producto no encontrado en inventario:", item.idProducto);
                        return;
                    }

                    const precioUnitario = parseFloat(producto.precioActual) || 0;
                    const subtotal = precioUnitario * item.cantidad;
                    
                    detalleFactura.push({
                        idProducto: item.idProducto,
                        nombreProducto: item.nombreProducto || producto.nombre || 'Producto desconocido',
                        cantidad: item.cantidad,
                        precioUnitario: precioUnitario,
                        subtotal: subtotal
                    });
                });
            }

            renderDetalleFactura();

            // ‚úÖ CARGAR EL VALOR DEL SERVICIO DESDE LA COTIZACI√ìN
            valorServicioInput.value = valorServicioCotizacion.toFixed(2);
            valorServicioInput.disabled = true;

            // ‚úÖ CARGAR EL MONTO TOTAL CON EL VALOR DE LA COTIZACI√ìN
            montoTotalInput.value = costoTotal.toFixed(2);
            montoTotalInput.disabled = true;

            if (cotizacion.cliente?.dni) {
                clienteSelect.value = cotizacion.cliente.dni;
            } else if (cotizacion.dniCliente) {
                clienteSelect.value = cotizacion.dniCliente;
            }

        } else {
            alert(`‚ö†Ô∏è Cotizaci√≥n no encontrada.`);
            valorServicioInput.value = '0';
            valorServicioInput.disabled = false;
            montoTotalInput.value = '0';
            montoTotalInput.disabled = false;
            clienteSelect.disabled = false;
            detalleFactura = [];
            renderDetalleFactura();
        }
    } else {
        // Si no hay cotizaci√≥n seleccionada, limpiar y habilitar campos
        valorServicioInput.value = '';
        valorServicioInput.disabled = false;
        montoTotalInput.value = '';
        montoTotalInput.disabled = false;
        clienteSelect.disabled = false;
        detalleFactura = [];
        renderDetalleFactura();
    }
});

// Agregar producto al detalle - VERSI√ìN MEJORADA
document.getElementById('addProductBtn').addEventListener('click', function() {
    const productoId = document.getElementById('productoSelect').value;
    const cantidad = parseInt(document.getElementById('cantidadProducto').value) || 0;

    if (!productoId) {
        alert('‚ö†Ô∏è Por favor, seleccione un producto.');
        return;
    }

    if (cantidad <= 0) {
        alert('‚ö†Ô∏è La cantidad debe ser mayor a 0.');
        return;
    }

    const producto = productosData.find(p => p.idProducto === productoId);
    if (!producto) {
        alert('‚ùå Producto no encontrado.');
        return;
    }

    // ‚úÖ CORRECCI√ìN: Validar que el producto no sea "PRODUCTO_ELIMINADO"
    if (productoId === "PRODUCTO_ELIMINADO") {
        alert('‚ùå No se puede agregar un producto eliminado.');
        return;
    }

    // ‚úÖ CORRECCI√ìN: Validar stock correctamente
    if (producto.stock < cantidad) {
        alert(`‚ùå Stock insuficiente. Disponible: ${producto.stock}`);
        return;
    }

    const precioUnitario = parseFloat(producto.precioActual) || 0;
    const subtotal = precioUnitario * cantidad;

    // ‚úÖ CORRECCI√ìN: Verificar si el producto ya existe
    const existingIndex = detalleFactura.findIndex(item => item.idProducto === productoId);
    
    if (existingIndex !== -1) {
        // Si ya existe, preguntar si quiere actualizar la cantidad
        if (confirm(`El producto "${producto.nombre}" ya est√° agregado. ¬øDesea actualizar la cantidad?`)) {
            const nuevaCantidadTotal = detalleFactura[existingIndex].cantidad + cantidad;
            
            if (producto.stock < nuevaCantidadTotal) {
                alert(`‚ùå Stock insuficiente. Disponible: ${producto.stock}, Ya agregado: ${detalleFactura[existingIndex].cantidad}`);
                return;
            }
            
            detalleFactura[existingIndex].cantidad = nuevaCantidadTotal;
            detalleFactura[existingIndex].subtotal = precioUnitario * nuevaCantidadTotal;
        } else {
            return;
        }
    } else {
        // Agregar nuevo producto
        detalleFactura.push({
            idProducto: productoId,
            nombreProducto: producto.nombre,
            cantidad: cantidad,
            precioUnitario: precioUnitario,
            subtotal: subtotal // ‚úÖ Asegurar que subtotal se calcule
        });
    }

    renderDetalleFactura();

    // Limpiar selecci√≥n
    document.getElementById('productoSelect').value = '';
    document.getElementById('cantidadProducto').value = '1';
    
    console.log("‚úÖ Producto agregado. Total productos:", detalleFactura.length);
});
// Funci√≥n para validar y preparar datos antes del env√≠o
function prepararDatosFactura() {
    // ‚úÖ CORRECCI√ìN: Asegurar que todos los subtotales est√©n calculados
    detalleFactura.forEach(item => {
        if (!item.subtotal || isNaN(item.subtotal)) {
            item.subtotal = (item.precioUnitario || 0) * (item.cantidad || 0);
        }
    });

    // Filtrar productos v√°lidos
    const detalleFacturaFiltrado = detalleFactura.filter(item => 
        item.idProducto && 
        item.idProducto !== "PRODUCTO_ELIMINADO" && 
        item.idProducto !== "null" &&
        item.cantidad > 0 &&
        !isNaN(item.subtotal)
    );

    // Preparar detalle para enviar
    const detalleFacturaData = detalleFacturaFiltrado.map(item => ({
        idProducto: item.idProducto,
        cantidad: item.cantidad,
        precioUnitario: item.precioUnitario,
        subtotal: item.subtotal
    }));

    return detalleFacturaData;
}
// Renderizar lista de productos agregados - VERSI√ìN MEJORADA
function renderDetalleFactura() {
    const container = document.getElementById('detalleFacturaList');
    if (!container) {
        console.error("‚ùå No se encontr√≥ el contenedor detalleFacturaList");
        return;
    }

    if (detalleFactura.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #718096; padding: 1rem;">No hay productos agregados.</p>';
        actualizarMontoTotal();
        return;
    }

    container.innerHTML = '';
    
    let totalProductos = 0;
    
    detalleFactura.forEach((item, index) => {
        // ‚úÖ Asegurar que los c√°lculos sean correctos
        const subtotal = (item.precioUnitario || 0) * (item.cantidad || 0);
        item.subtotal = subtotal; // Actualizar en el array
        totalProductos += subtotal;

        const div = document.createElement('div');
        div.className = 'detalle-factura-item';
        div.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        `;
        
        div.innerHTML = `
            <div style="flex: 1;">
                <strong style="color: #2c5f41;">${item.nombreProducto}</strong><br>
                <small style="color: #718096;">ID: ${item.idProducto}</small><br>
                <span style="color: #4a5568; font-size: 0.9em;">
                    ${item.cantidad} x $${(item.precioUnitario || 0).toLocaleString()} = 
                    <strong>$${(subtotal || 0).toLocaleString()}</strong>
                </span>
            </div>
            <div class="detalle-factura-controls" style="display: flex; gap: 0.5rem;">
                <button type="button" class="btn-sm edit-btn" onclick="editDetalleItem(${index})" 
                        style="background: #f6ad55; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;"
                        title="Editar cantidad">
                    ‚úèÔ∏è
                </button>
                <button type="button" class="btn-sm remove-btn" onclick="removeDetalleItem(${index})" 
                        style="background: #f56565; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;"
                        title="Eliminar producto">
                    üóëÔ∏è
                </button>
            </div>
        `;
        container.appendChild(div);
    });
    
    // Mostrar resumen
    const resumenDiv = document.createElement('div');
    resumenDiv.style.cssText = `
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f7fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        text-align: right;
    `;
    resumenDiv.innerHTML = `
        <strong>Subtotal Productos:/n $${totalProductos.toLocaleString()}</strong>
    `;
    container.appendChild(resumenDiv);
    
    actualizarMontoTotal();
    console.log("‚úÖ Productos renderizados:", detalleFactura.length, "Subtotal:", totalProductos);
}
// Funci√≥n para verificar el token JWT
function verificarToken() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        console.warn("‚ùå No se encontr√≥ token en localStorage");
        return false;
    }

    try {
        // Decodificar el token para verificar expiraci√≥n (sin validar firma)
        const partes = token.split('.');
        if (partes.length !== 3) {
            console.error("‚ùå Token con formato inv√°lido");
            localStorage.removeItem('jwtToken');
            return false;
        }

        const payload = JSON.parse(atob(partes[1]));
        const expiraEn = payload.exp * 1000; // Convertir a milisegundos
        const ahora = Date.now();
        
        console.log("üîê Token info:", {
            expira: new Date(expiraEn).toLocaleString(),
            ahora: new Date(ahora).toLocaleString(),
            minutosRestantes: Math.round((expiraEn - ahora) / 1000 / 60)
        });
        
        if (ahora >= expiraEn) {
            console.warn("‚ö†Ô∏è Token expirado");
            localStorage.removeItem('jwtToken');
            return false;
        }
        
        console.log("‚úÖ Token v√°lido");
        return true;
    } catch (error) {
        console.error("‚ùå Error al verificar token:", error);
        localStorage.removeItem('jwtToken');
        return false;
    }
}
// Funci√≥n para limpiar productos eliminados del detalle
function limpiarProductosEliminados() {
    detalleFactura = detalleFactura.filter(item => 
        item.idProducto && 
        item.idProducto !== "PRODUCTO_ELIMINADO" && 
        item.idProducto !== "null" &&
        item.idProducto.trim() !== ""
    );
    renderDetalleFactura();
}

// Llamar esta funci√≥n antes de enviar el formulario
function validarDetalleFactura() {
    limpiarProductosEliminados();
    return detalleFactura.length > 0;
}
// Funci√≥n mejorada de validaci√≥n
function validarFacturaAntesDeEnviar(tipoFactura) {
    // Validar cliente
    const dniCliente = document.getElementById('clienteSelect').value;
    if (!dniCliente) {
        throw new Error('Debe seleccionar un cliente');
    }

    // Validar fecha
    const fechaEmision = document.querySelector('input[name="fecha_emision"]').value;
    if (!fechaEmision) {
        throw new Error('La fecha de emisi√≥n es obligatoria');
    }

    // Validar estado
    const estado = document.querySelector('select[name="estado"]').value;
    if (!estado) {
        throw new Error('Debe seleccionar un estado');
    }

    // Validar monto total
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const montoTotal = parseFloat(montoTotalInput?.value) || 0;
    if (montoTotal <= 0) {
        throw new Error('El monto total debe ser mayor a 0');
    }

    // Validar productos seg√∫n tipo de factura
    if (tipoFactura === 'ConCotizacion') {
        const idCotizacion = document.getElementById('cotizacionSelect').value;
        if (!idCotizacion) {
            throw new Error('Para facturas con cotizaci√≥n, debe seleccionar una cotizaci√≥n v√°lida');
        }
        
        // Para facturas con cotizaci√≥n, permitir sin productos
        if (detalleFactura.length === 0) {
            console.warn("‚ö†Ô∏è Factura con cotizaci√≥n sin productos - permitido");
        }
    } else {
        // Para facturas simples, permitir sin productos pero con valor de servicio
        const valorServicio = parseFloat(document.getElementById('valorServicio')?.value) || 0;
        if (detalleFactura.length === 0 && valorServicio <= 0) {
            throw new Error('Para facturas simples, debe agregar productos o especificar un valor de servicio');
        }
    }

    return true;
}
// Funci√≥n para diagnosticar problemas con facturas - VERSI√ìN MEJORADA
// Funci√≥n para diagnosticar problemas con facturas
async function diagnosticarFacturas() {
    console.log("üîç DIAGNOSTICANDO FACTURAS...");
    
    // Preparar datos de prueba
    const datosPrueba = {
        dniCliente: "444555666", // Usa un DNI que exista
        fechaEmision: new Date().toISOString().split('T')[0],
        montoTotal: 100000,
        estado: "PENDIENTE", // ‚úÖ Usar may√∫sculas como espera el backend
        observaciones: "Factura de prueba - diagn√≥stico",
        tipoFactura: "Simple",
        valorServicio: 50000,
        detalleFactura: [] // ‚úÖ Probar sin productos primero
    };

    console.log("üß™ Probando con datos:", JSON.stringify(datosPrueba, null, 2));
    
    try {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert("‚ùå No hay token de autenticaci√≥n");
            return null;
        }
        
        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };

        const response = await fetch(API_FACTURAS_URL, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(datosPrueba)
        });

        console.log("üì• Respuesta:", response.status, response.statusText);
        
        if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ √âXITO:", result);
            alert("‚úÖ Factura de prueba creada exitosamente");
            await getAllFacturas();
            return result;
        } else {
            const errorText = await response.text();
            console.error("‚ùå Error:", errorText);
            
            // Esto indica que el problema es del backend (generaci√≥n de IDs)
            if (errorText.includes("IdentifierGenerationException")) {
                alert("‚ùå Error del backend: Problema con la generaci√≥n de IDs de factura. Contacte al administrador.");
            } else {
                alert("‚ùå Error en prueba: " + errorText);
            }
            return null;
        }
    } catch (error) {
        console.error("‚ùå Error de red:", error);
        alert("‚ùå Error de red: " + error.message);
        return null;
    }
}


// Ejecutar en consola: diagnosticarFacturas()
        // Editar un item del detalle
        function editDetalleItem(index) {
            const item = detalleFactura[index];
            const nuevaCantidad = prompt(`Editar cantidad para "${item.nombreProducto}":`, item.cantidad);
            const cantidadNum = parseInt(nuevaCantidad);
            if (!isNaN(cantidadNum) && cantidadNum > 0) {
                const producto = productosData.find(p => p.idProducto === item.idProducto);
                if (producto && cantidadNum <= producto.stock) {
                    item.cantidad = cantidadNum;
                    item.subtotal = item.precioUnitario * cantidadNum;
                    renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
                } else {
                    alert(`‚ùå Stock insuficiente o cantidad inv√°lida. Disponible: ${producto.stock}`);
                }
            }
        }

        // Remover un item del detalle
        function removeDetalleItem(index) {
            if (confirm('¬øEst√° seguro de remover este producto del detalle?')) {
                detalleFactura.splice(index, 1);
                renderDetalleFactura(); // <-- Esto ya llama a actualizarMontoTotal()
            }
        }

        // Abrir modal para agregar factura
// Abrir modal para agregar/editar factura - VERSI√ìN MEJORADA
function openAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    const form = document.getElementById('invoiceForm');
    
    console.log("üîÑ Abriendo modal de factura...");
    
    // Resetear formulario COMPLETAMENTE
    form.reset();
    
    // Configurar valores por defecto
    document.getElementById('invoiceModalTitle').textContent = 'Agregar Nueva Factura';
    document.getElementById('submitBtn').textContent = 'Guardar Factura';
    document.getElementById('invoiceIdInput').value = '';
    
    // Mostrar/ocultar secciones seg√∫n tipo de factura
    document.getElementById('productosSection').style.display = 'block';
    document.getElementById('cotizacionField').style.display = 'none';
    
    // ‚úÖ CORRECCI√ìN CR√çTICA: Asegurar que los campos est√©n habilitados
    const clienteSelect = document.getElementById('clienteSelect');
    const montoTotalInput = document.querySelector('input[name="monto_total"]');
    const valorServicioInput = document.getElementById('valorServicio');
    
    if (clienteSelect) clienteSelect.disabled = false;
    if (montoTotalInput) montoTotalInput.disabled = false;
    if (valorServicioInput) valorServicioInput.disabled = false;
    
    // Resetear tipo de factura
    document.getElementById('tipoFacturaSelect').value = 'Simple';
    
    // Limpiar y resetear detalle
    detalleFactura = [];
    renderDetalleFactura();
    
    // Establecer fecha por defecto (hoy)
    const today = new Date().toISOString().split('T')[0];
    const fechaInput = document.querySelector('input[name="fecha_emision"]');
    if (fechaInput) {
        fechaInput.value = today;
    }
    
    // Establecer estado por defecto
    const estadoSelect = document.querySelector('select[name="estado"]');
    if (estadoSelect) {
        estadoSelect.value = 'PENDIENTE';
    }
    
    // Limpiar cotizaci√≥n
    const cotizacionSelect = document.getElementById('cotizacionSelect');
    if (cotizacionSelect) {
        cotizacionSelect.value = '';
    }
    
    currentEditId = null;
    
    // Mostrar modal
    modal.classList.add('show');
    
    console.log("‚úÖ Modal de factura abierto y listo");
}
// Funci√≥n editInvoice COMPLETAMENTE CORREGIDA
async function editInvoice(id) {
    try {
        console.log(`‚úèÔ∏è Editando factura: ${id}`);
        
        // Buscar la factura en la lista local
        const factura = allFacturas.find(f => f.idFactura === id);
        if (!factura) {
            alert("‚ùå Factura no encontrada.");
            return;
        }

        console.log("üìã Factura encontrada para editar:", factura);

        // Abrir modal de edici√≥n PRIMERO
        openAddInvoiceModal();
        
        // Configurar modal para edici√≥n
        document.getElementById('invoiceModalTitle').textContent = 'Editar Factura';
        document.getElementById('submitBtn').textContent = 'Guardar Cambios';
        document.getElementById('invoiceIdInput').value = id;

        // ‚úÖ CORRECCI√ìN: Esperar un poco para que el modal se renderice completamente
        setTimeout(() => {
            // Establecer tipo de factura
            const tipoFactura = factura.tipoFactura === 'ConCotizacion' ? 'ConCotizacion' : 'Simple';
            document.getElementById('tipoFacturaSelect').value = tipoFactura;

            // Disparar evento change para actualizar campos visibles
            document.getElementById('tipoFacturaSelect').dispatchEvent(new Event('change'));

            // Rellenar datos del formulario - CON VALIDACIONES
            const dniCliente = factura.cliente?.dni || factura.dniCliente;
            if (dniCliente) {
                const clienteSelect = document.getElementById('clienteSelect');
                if (clienteSelect) {
                    clienteSelect.value = dniCliente;
                    console.log("‚úÖ Cliente asignado:", dniCliente);
                }
            }

            // Fecha de emisi√≥n
            const fechaEmision = factura.fechaEmision ? 
                factura.fechaEmision.split('T')[0] : 
                new Date().toISOString().split('T')[0];
            const fechaInput = document.querySelector('input[name="fecha_emision"]');
            if (fechaInput) {
                fechaInput.value = fechaEmision;
                console.log("‚úÖ Fecha asignada:", fechaEmision);
            }

            // Estado - manejar diferentes formatos
            let estado = factura.estado || 'PENDIENTE';
            if (estado === 'Pendiente') estado = 'PENDIENTE';
            if (estado === 'Pagada') estado = 'PAGADA';
            if (estado === 'Cancelada') estado = 'CANCELADA';
            
            const estadoSelect = document.querySelector('select[name="estado"]');
            if (estadoSelect) {
                estadoSelect.value = estado;
                console.log("‚úÖ Estado asignado:", estado);
            }

            // Observaciones
            const observacionesTextarea = document.querySelector('textarea[name="observaciones"]');
            if (observacionesTextarea) {
                observacionesTextarea.value = factura.observaciones || '';
                console.log("‚úÖ Observaciones asignadas");
            }

            // Valor Servicio
            const valorServicioInput = document.getElementById('valorServicio');
            if (valorServicioInput) {
                valorServicioInput.value = (factura.valorServicio || 0).toFixed(2);
                console.log("‚úÖ Valor servicio asignado:", factura.valorServicio);
            }

            // Monto Total
            const montoTotalInput = document.querySelector('input[name="monto_total"]');
            if (montoTotalInput) {
                montoTotalInput.value = (factura.montoTotal || 0).toFixed(2);
                console.log("‚úÖ Monto total asignado:", factura.montoTotal);
            }

            // Manejar facturas con cotizaci√≥n
            if (tipoFactura === 'ConCotizacion') {
                const idCotizacion = factura.cotizacion?.idCotizacion || factura.idCotizacion || '';
                if (idCotizacion) {
                    setTimeout(() => {
                        const cotizacionSelect = document.getElementById('cotizacionSelect');
                        if (cotizacionSelect) {
                            cotizacionSelect.value = idCotizacion;
                            console.log("‚úÖ Cotizaci√≥n asignada:", idCotizacion);
                            // Disparar change para cargar datos de la cotizaci√≥n
                            cotizacionSelect.dispatchEvent(new Event('change'));
                        }
                    }, 500);
                }
            }

            // ‚úÖ CARGAR DETALLES DE LA FACTURA - VERSI√ìN MEJORADA
            detalleFactura = []; // Limpiar array existente
            
            console.log("üì¶ Procesando productos de la factura:", factura.detalleFactura);
            
            if (factura.detalleFactura && Array.isArray(factura.detalleFactura)) {
                factura.detalleFactura.forEach((df, index) => {
                    // Validar que el producto sea v√°lido
                    if (!df.idProducto || df.idProducto === "PRODUCTO_ELIMINADO") {
                        console.warn(`‚ö†Ô∏è Producto ${index + 1} inv√°lido, omitiendo:`, df);
                        return;
                    }

                    // Buscar el producto en productosData para obtener nombre actualizado
                    const producto = productosData.find(p => p.idProducto === df.idProducto);
                    const nombreProducto = producto?.nombre || df.nombreProducto || 'Producto desconocido';
                    const precioUnitario = parseFloat(df.precioUnitario) || 0;
                    const cantidad = parseInt(df.cantidad) || 0;
                    const subtotal = parseFloat(df.subtotal) || (precioUnitario * cantidad);

                    detalleFactura.push({
                        idProducto: df.idProducto,
                        nombreProducto: nombreProducto,
                        cantidad: cantidad,
                        precioUnitario: precioUnitario,
                        subtotal: subtotal
                    });
                    
                    console.log(`‚úÖ Producto ${index + 1} agregado:`, nombreProducto, cantidad, precioUnitario);
                });
                console.log(`‚úÖ ${detalleFactura.length} productos cargados para edici√≥n`);
            } else {
                console.log("üì≠ No hay productos en esta factura");
            }

            // Renderizar productos
            renderDetalleFactura();

            // Para facturas simples, recalcular monto total si es necesario
            if (tipoFactura === 'Simple') {
                setTimeout(() => {
                    actualizarMontoTotal();
                }, 300);
            }

            currentEditId = id;
            console.log("‚úÖ Modal de edici√≥n completamente configurado para:", id);

        }, 100); // Peque√±o delay para asegurar que el modal est√© listo

    } catch (error) {
        console.error("‚ùå Error inesperado al editar:", error);
        alert("‚ùå Error al cargar la factura para editar: " + error.message);
    }
}

async function handleInvoiceFormSubmit(event) {
    event.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '‚è≥ Guardando...';
    submitBtn.disabled = true;

    try {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
            window.location.href = 'index.html';
            isSubmitting = false;
            return;
        }

        // Obtener valores del formulario
        const tipoFactura = document.getElementById('tipoFacturaSelect').value;
        const dniCliente = document.getElementById('clienteSelect').value;
        const fechaEmision = document.querySelector('input[name="fecha_emision"]').value;
        const estado = document.querySelector('select[name="estado"]').value;
        const observaciones = document.querySelector('textarea[name="observaciones"]').value || '';
        
        const montoTotalInput = document.querySelector('input[name="monto_total"]');
        let montoTotal = parseFloat(montoTotalInput?.value) || 0;
        
        const valorServicioInput = document.getElementById('valorServicio');
        const valorServicio = valorServicioInput ? parseFloat(valorServicioInput.value) || 0 : 0;

        let idCotizacion = null;
        if (tipoFactura === 'ConCotizacion') {
            idCotizacion = document.getElementById('cotizacionSelect').value;
            if (!idCotizacion) {
                alert('‚ö†Ô∏è Para facturas con cotizaci√≥n, debe seleccionar una cotizaci√≥n v√°lida.');
                throw new Error('Cotizaci√≥n no seleccionada');
            }
        }

        // Validaciones b√°sicas
        if (!dniCliente) {
            alert('‚ö†Ô∏è Debe seleccionar un cliente.');
            throw new Error('Cliente no seleccionado');
        }

        if (!fechaEmision) {
            alert('‚ö†Ô∏è La fecha de emisi√≥n es obligatoria.');
            throw new Error('Fecha de emisi√≥n no especificada');
        }

        if (!estado) {
            alert('‚ö†Ô∏è Debe seleccionar un estado para la factura.');
            throw new Error('Estado no seleccionado');
        }

        if (montoTotal <= 0) {
            alert('‚ö†Ô∏è El monto total debe ser mayor a 0.');
            throw new Error('Monto total inv√°lido');
        }

        // ‚úÖ CORRECCI√ìN: Usar funci√≥n mejorada para preparar datos
        const detalleFacturaData = prepararDatosFactura();

        // Validar seg√∫n tipo de factura
        if (tipoFactura === 'Simple' && detalleFacturaData.length === 0 && valorServicio <= 0) {
            alert('‚ö†Ô∏è Para facturas simples, debe agregar al menos un producto o especificar un valor de servicio.');
            throw new Error('No hay productos v√°lidos en el detalle y valor de servicio es 0');
        }

        // ‚úÖ CORRECCI√ìN: Estructura de datos completa y validada
        const facturaData = {
            dniCliente: dniCliente,
            fechaEmision: fechaEmision,
            montoTotal: montoTotal,
            estado: estado,
            observaciones: observaciones,
            tipoFactura: tipoFactura,
            valorServicio: valorServicio,
            detalleFactura: detalleFacturaData
        };

        // ‚úÖ CORRECCI√ìN: Solo agregar idCotizacion si existe
        if (idCotizacion) {
            facturaData.idCotizacion = idCotizacion;
        }

        console.log("üöÄ Enviando datos de factura:", JSON.stringify(facturaData, null, 2));

        const url = currentEditId ? `${API_FACTURAS_URL}/${currentEditId}` : API_FACTURAS_URL;
        const method = currentEditId ? 'PUT' : 'POST';

        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(facturaData)
        });

        console.log("üì• Respuesta del servidor:", response.status, response.statusText);

        if (!response.ok) {
            let errorMessage = `Error ${response.status}: ${response.statusText}`;
            try {
                const errorText = await response.text();
                // Intentar parsear como JSON
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.message || errorJson.error || errorText;
                } catch {
                    // Si no es JSON, usar el texto original
                    errorMessage = errorText || errorMessage;
                }
            } catch {
                // Si hay error al leer la respuesta
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log("‚úÖ Factura guardada exitosamente:", result);

        alert(currentEditId ? "‚úÖ Factura actualizada exitosamente." : "‚úÖ Factura creada exitosamente.");
        closeModal('addInvoiceModal');
        await getAllFacturas();

    } catch (error) {
        console.error("‚ùå Error al guardar factura:", error);
        alert(`‚ùå Error al guardar la factura:\n\n${error.message}`);
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        isSubmitting = false;
    }
}
        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('addInvoiceModal');
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        }

 function renderTable(data) {
    const tbody = document.getElementById('invoicesTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">No hay facturas.</td></tr>';
        return;
    }

    data.forEach(fact => {
        const clienteNombre = fact.cliente?.nombre || clientesData.find(c => c.dni === fact.dniCliente)?.nombre || fact.dniCliente || 'N/A';
        const servicioDescripcion = fact.tipoFactura === 'ConCotizacion' && fact.cotizacion ? `Cotizaci√≥n #${fact.cotizacion.idCotizacion}` : (fact.observaciones || 'Servicio general');
        
        // ‚úÖ CORRECCI√ìN: Convertir valores con "K" antes de formatear
        const montoConvertido = convertirValorK(fact.montoTotal);
        
        const estadoDisplay = {
            'PENDIENTE': 'Pendiente',
            'PAGADA': 'Pagada', 
            'CANCELADA': 'Cancelada'
        }[fact.estado] || fact.estado;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${fact.idFactura || 'N/A'}</td>
            <td>${clienteNombre}</td>
            <td>${servicioDescripcion}</td>
            <td>${formatDate(fact.fechaEmision)}</td>
            <td>${formatCurrency(montoConvertido)}</td>
            <td><span class="status-badge ${(fact.estado || 'PENDIENTE').toLowerCase()}">${estadoDisplay}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-sm btn-details" onclick="viewInvoice('${fact.idFactura}')">üîç Detalles</button>
                    <button class="btn-sm btn-edit" onclick="editInvoice('${fact.idFactura}')">‚úèÔ∏è Editar</button>
                    <button class="btn-sm btn-send" onclick="sendInvoice('${fact.idFactura}')">üìß Enviar</button>
                    <button class="btn-sm btn-delete" onclick="deleteInvoice('${fact.idFactura}')">üóëÔ∏è Eliminar</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}


// Obtener todas las facturas - VERSI√ìN CON CONVERSI√ìN FORZADA
async function getAllFacturas() {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }
    const headers = { 'Authorization': 'Bearer ' + token };

    try {
        const response = await fetch(API_FACTURAS_URL, { headers });
        if (!response.ok) throw new Error('Error al obtener facturas');
        
        allFacturas = await response.json();
        console.log("üìã Facturas cargadas:", allFacturas.length);
        
        // ‚úÖ CORRECCI√ìN CR√çTICA: Forzar conversi√≥n y limpiar formato
        allFacturas.forEach(factura => {
            console.log(`üîÑ Procesando factura ${factura.idFactura}:`, {
                montoOriginal: factura.montoTotal,
                tipoOriginal: typeof factura.montoTotal
            });
            
            // Convertir si es string con K
            if (typeof factura.montoTotal === 'string') {
                factura.montoTotal = convertirValorK(factura.montoTotal);
            }
            
            // Asegurar que sea n√∫mero
            factura.montoTotal = parseFloat(factura.montoTotal) || 0;
            
            console.log(`‚úÖ Factura ${factura.idFactura} convertida:`, factura.montoTotal);
        });
        
        renderTable(allFacturas);
        updateStats();
        
    } catch (error) {
        console.error("‚ùå Error al obtener facturas:", error);
        alert("Error al cargar la lista de facturas. Revisa la consola.");
    }
}

// FUNCI√ìN DE EMERGENCIA - Resetear completamente el formato
function resetearFormatoMoneda() {
    console.log("üîÑ RESETEANDO FORMATO DE MONEDA...");
    
    // 1. Redefinir formatCurrency
    window.formatCurrency = function(value) {
        if (value === null || value === undefined || isNaN(value)) return '$ 0';
        return '$ ' + new Intl.NumberFormat('es-CO').format(value);
    };
    
    // 2. Redefinir formatCurrencyForPDF  
    window.formatCurrencyForPDF = function(amount) {
        if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
        return '$ ' + new Intl.NumberFormat('es-CO').format(amount);
    };
    
    // 3. Forzar reconversi√≥n de todas las facturas
    allFacturas.forEach(factura => {
        factura.montoTotal = convertirValorK(factura.montoTotal);
    });
    
    // 4. Rerenderizar todo
    renderTable(allFacturas);
    updateStats();
    
    console.log("‚úÖ Formato de moneda reseteado completamente");
}

// Ejecutar en consola: resetearFormatoMoneda()
// Funci√≥n para diagnosticar la conversi√≥n de valores
function diagnosticarConversiones() {
    console.log("üîç DIAGN√ìSTICO DE CONVERSI√ìN:");
    
    allFacturas.forEach((factura, index) => {
        const original = factura.montoTotal;
        const convertido = convertirValorK(original);
        const formateado = formatCurrency(convertido);
        
        console.log(`Factura ${index + 1}:`, {
            original: original,
            convertido: convertido,
            formateado: formateado,
            tipo: typeof original
        });
    });
}

// Ejecutar en consola: diagnosticarConversiones()
// Funci√≥n para diagnosticar el problema del backend
async function diagnosticarBackend() {
    try {
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Authorization': 'Bearer ' + token };
        
        console.log("üîç Diagnosticando backend...");
        
        // Probar endpoint de facturas
        const response = await fetch(API_FACTURAS_URL, { headers });
        console.log("‚úÖ GET /facturas:", response.status);
        
        if (response.ok) {
            const facturas = await response.json();
            console.log(`‚úÖ ${facturas.length} facturas obtenidas`);
            
            // Probar cada factura individualmente
            for (let factura of facturas.slice(0, 3)) { // Probar solo las primeras 3
                console.log(`üîç Probando factura ${factura.idFactura}...`);
                const individualResponse = await fetch(`${API_FACTURAS_URL}/${factura.idFactura}`, { headers });
                console.log(`   ${factura.idFactura}:`, individualResponse.status);
                
                if (!individualResponse.ok) {
                    const errorText = await individualResponse.text();
                    console.error(`   ‚ùå Error:`, errorText);
                }
            }
        }
        
    } catch (error) {
        console.error("‚ùå Error en diagn√≥stico:", error);
    }
}

// Ejecutar en consola: diagnosticarBackend()
function updateStats() {
    try {
        const total = allFacturas.length;
        
        const pendientes = allFacturas.filter(f => 
            f.estado === 'PENDIENTE' || f.estado === 'Pendiente'
        ).length;
        
        const pagadas = allFacturas.filter(f => 
            f.estado === 'PAGADA' || f.estado === 'Pagada'
        ).length;
        
        // ‚úÖ CORRECCI√ìN: Convertir valores con "K" antes de sumar
        const ingresos = allFacturas
            .filter(f => f.estado === 'PAGADA' || f.estado === 'Pagada')
            .reduce((sum, f) => {
                const monto = convertirValorK(f.montoTotal) || 0;
                return sum + monto;
            }, 0);

        console.log("üìä Estad√≠sticas calculadas:", {
            total,
            pendientes,
            pagadas,
            ingresos
        });

        // Actualizar DOM
        document.getElementById('statFacturasTotal').textContent = total;
        document.getElementById('statFacturasPendientes').textContent = pendientes;
        document.getElementById('statFacturasPagadas').textContent = pagadas;
        document.getElementById('statIngresosTotal').textContent = formatCurrency(ingresos);

    } catch (error) {
        console.error("‚ùå Error al actualizar estad√≠sticas:", error);
    }
}

// REEMPLAZAR COMPLETAMENTE la funci√≥n viewInvoice con esta versi√≥n corregida
// FUNCI√ìN CORREGIDA PARA EVITAR SUPERPOSICI√ìN
async function viewInvoice(id) {
    try {
        console.log("üìÑ Generando PDF para factura:", id);
        
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Authorization': 'Bearer ' + token };
        
        // Cargar datos
        const response = await fetch(`${API_FACTURAS_URL}/${id}`, { headers });
        if (!response.ok) throw new Error('Error al cargar factura');
        
        const facturaCompleta = await response.json();
        console.log("üìã Factura completa:", facturaCompleta);

        // ‚úÖ CORRECCI√ìN: Convertir valores con "K" antes de procesar
        if (typeof facturaCompleta.montoTotal === 'string' && facturaCompleta.montoTotal.includes('K')) {
            facturaCompleta.montoTotal = convertirValorK(facturaCompleta.montoTotal);
        }

        // ‚úÖ OBTENER CLIENTE DE CUALQUIER FORMA POSIBLE
        let cliente = {};
        if (facturaCompleta.cliente) {
            cliente = facturaCompleta.cliente;
        } else {
            cliente = clientesData.find(c => c.dni === facturaCompleta.dniCliente) || {
                nombre: facturaCompleta.nombreCliente || 'N/A',
                dni: facturaCompleta.dniCliente || 'N/A',
                telefono: facturaCompleta.telefonoCliente || 'N/A',
                correo: facturaCompleta.correoCliente || 'N/A'
            };
        }

        // Crear PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 20;

        // ===== ENCABEZADO =====
        doc.setFontSize(20);
        doc.setTextColor(44, 95, 65);
        doc.text('FACTURA DE VENTA', pageWidth / 2, 25, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('Gemini Ambiental SAS', pageWidth / 2, 32, { align: 'center' });
        doc.text('NIT: 901.234.567-8', pageWidth / 2, 37, { align: 'center' });
        doc.text('Carrera 45 # 12-34, Medell√≠n, Colombia', pageWidth / 2, 42, { align: 'center' });

        doc.setDrawColor(44, 95, 65);
        doc.line(margin, 47, pageWidth - margin, 47);

        // ===== INFORMACI√ìN FACTURA Y CLIENTE =====
        let yPos = 57;
        
        // Datos factura
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DE LA FACTURA', margin, yPos);
        doc.setFont(undefined, 'normal');
        
        yPos += 8;
        doc.text(`N¬∞ Factura: ${facturaCompleta.idFactura || 'N/A'}`, margin, yPos);
        yPos += 6;
        doc.text(`Fecha Emisi√≥n: ${formatDateForPDF(facturaCompleta.fechaEmision)}`, margin, yPos);
        yPos += 6;
        doc.text(`Estado: ${facturaCompleta.estado || 'N/A'}`, margin, yPos);
        yPos += 6;
        doc.text(`Tipo: ${facturaCompleta.tipoFactura || 'Simple'}`, margin, yPos);
        
        if (facturaCompleta.idCotizacion) {
            yPos += 6;
            doc.text(`Cotizaci√≥n: ${facturaCompleta.idCotizacion}`, margin, yPos);
        }

        // Datos cliente
        const clienteX = pageWidth / 2 + 10;
        let yPosCliente = 57;
        
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DEL CLIENTE', clienteX, yPosCliente);
        doc.setFont(undefined, 'normal');
        
        yPosCliente += 8;
        doc.text(`Cliente: ${cliente.nombre || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Documento: ${cliente.dni || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Tel√©fono: ${cliente.telefono || 'N/A'}`, clienteX, yPosCliente);
        yPosCliente += 6;
        doc.text(`Correo: ${cliente.correo || 'N/A'}`, clienteX, yPosCliente);

        const infoBottom = Math.max(yPos, yPosCliente) + 10;
        doc.line(margin, infoBottom, pageWidth - margin, infoBottom);

        // ===== DETALLES =====
        let currentY = infoBottom + 15;

        // Posiciones columnas
        const colDescripcion = margin;
        const colCantidad = margin + 70;
        const colPrecio = margin + 90;
        const colTotal = margin + 130;

        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('DESCRIPCI√ìN', colDescripcion, currentY);
        doc.text('CANT.', colCantidad, currentY);
        doc.text('PRECIO UNIT.', colPrecio, currentY);
        doc.text('VALOR TOTAL', colTotal, currentY);
        
        currentY += 4;
        doc.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 8;

        doc.setFont(undefined, 'normal');
        
        let subtotalProductos = 0;
        let tieneItems = false;

        // ‚úÖ OBTENER DETALLES DE CUALQUIER ESTRUCTURA
        let detalleParaMostrar = [];

        if (facturaCompleta.detalleFactura && facturaCompleta.detalleFactura.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleFactura;
        } else if (facturaCompleta.detalleProductos && facturaCompleta.detalleProductos.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleProductos;
        } else if (facturaCompleta.detalleServicios && facturaCompleta.detalleServicios.length > 0) {
            detalleParaMostrar = facturaCompleta.detalleServicios;
        }

        // MOSTRAR ITEMS
        if (detalleParaMostrar.length > 0) {
            tieneItems = true;
            
            for (const item of detalleParaMostrar) {
                // ‚úÖ CORRECCI√ìN: Verificar si necesitamos nueva p√°gina
                if (currentY > 230) {
                    doc.addPage();
                    currentY = 30;
                    doc.setFont(undefined, 'bold');
                    doc.text('DESCRIPCI√ìN', colDescripcion, currentY);
                    doc.text('CANT.', colCantidad, currentY);
                    doc.text('PRECIO UNIT.', colPrecio, currentY);
                    doc.text('VALOR TOTAL', colTotal, currentY);
                    currentY += 8;
                    doc.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 8;
                    doc.setFont(undefined, 'normal');
                }
                
                const nombre = item.nombreProducto || item.nombreServicio || 'Producto/Servicio';
                const cantidad = item.cantidad || 1;
                const precioUnitario = parseFloat(item.precioUnitario) || 0;
                let subtotal = parseFloat(item.subtotal) || 0;
                
                if (subtotal === 0 && precioUnitario > 0) {
                    subtotal = precioUnitario * cantidad;
                }

                const descripcionLines = doc.splitTextToSize(nombre, 60);
                const lineHeight = 5;
                const descripcionHeight = descripcionLines.length * lineHeight;
                
                doc.text(descripcionLines, colDescripcion, currentY);
                doc.text(cantidad.toString(), colCantidad, currentY);
                doc.text(formatCurrencyForPDF(precioUnitario), colPrecio, currentY);
                doc.text(formatCurrencyForPDF(subtotal), colTotal, currentY);
                
                currentY += Math.max(descripcionHeight, lineHeight) + 2;
                subtotalProductos += subtotal;
            }
        } else {
            doc.text('No hay productos o servicios en esta factura', colDescripcion, currentY);
            currentY += 8;
        }

        currentY += 10;

        // VALOR DEL SERVICIO
        let valorServicio = parseFloat(facturaCompleta.valorServicio) || 0;

        if (valorServicio > 0) {
            // ‚úÖ CORRECCI√ìN: Verificar espacio antes de agregar valor servicio
            if (currentY > 240) {
                doc.addPage();
                currentY = 30;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('VALOR DEL SERVICIO:', colPrecio, currentY);
            doc.text(formatCurrencyForPDF(valorServicio), colTotal, currentY);
            doc.setFont(undefined, 'normal');
            currentY += 8;
        }

        // CALCULAR TOTAL
        let totalFinal = parseFloat(facturaCompleta.montoTotal) || (subtotalProductos + valorServicio);
        
        // ‚úÖ CORRECCI√ìN CR√çTICA: Verificar espacio suficiente para totales
        if (currentY > 240) {
            doc.addPage();
            currentY = 30;
        }
        
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 10;

        // ‚úÖ CORRECCI√ìN: Asegurar suficiente espacio entre elementos
        // MOSTRAR TOTALES CON ESPACIADO ADECUADO
        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        
        if (tieneItems && subtotalProductos > 0) {
            doc.text('SUBTOTAL PRODUCTOS:', colPrecio, currentY);
            doc.text(formatCurrencyForPDF(subtotalProductos), colTotal, currentY);
            currentY += 12; // ‚úÖ Aumentado de 8 a 12 para m√°s espacio
        }
        
        if (valorServicio > 0) {
            doc.text('VALOR SERVICIO:', colPrecio, currentY);
            doc.text(formatCurrencyForPDF(valorServicio), colTotal, currentY);
            currentY += 12; // ‚úÖ Aumentado de 8 a 12 para m√°s espacio
        }
        
        // ‚úÖ CORRECCI√ìN: Asegurar espacio antes del TOTAL
        currentY += 5;
        doc.setDrawColor(44, 95, 65);
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 2;
        doc.line(colPrecio, currentY, pageWidth - margin, currentY);
        currentY += 10; // ‚úÖ Aumentado de 8 a 10 para m√°s espacio
        
        doc.setFontSize(14);
        doc.setTextColor(44, 95, 65);
        doc.text('TOTAL FACTURA:/n', colPrecio, currentY);
        doc.text(formatCurrencyForPDF(totalFinal), colTotal, currentY);

        // PIE DE P√ÅGINA
        const footerY = 280;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, footerY, pageWidth - margin, footerY);
        
        doc.text('Gemini Ambiental SAS - NIT: 901.234.567-8', margin, footerY + 5);
        doc.text('Tel: +57 (4) 444 5555 - www.geminiambiental.com', margin, footerY + 10);
        doc.text(`Documento generado el: ${new Date().toLocaleDateString('es-CO')}`, pageWidth - margin, footerY + 10, { align: 'right' });

        // MOSTRAR/DESCARGAR
        const nombreArchivo = `Factura_${facturaCompleta.idFactura}.pdf`;
        
        const userChoice = confirm(
            '¬øDesea descargar la factura como PDF?\n\nCancelar = Vista previa\nAceptar = Descargar'
        );
        
        if (userChoice) {
            doc.save(nombreArchivo);
            console.log("‚úÖ PDF descargado:", nombreArchivo);
        } else {
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            setTimeout(() => URL.revokeObjectURL(pdfUrl), 60000);
        }

    } catch (error) {
        console.error("‚ùå Error generando PDF:", error);
        alert("‚ùå Error al generar el PDF: " + error.message);
    }
}
// Funci√≥n para forzar rec√°lculo de montos
function forzarActualizacionMontos() {
    const tipoFactura = document.getElementById('tipoFacturaSelect').value;
    
    if (tipoFactura === 'ConCotizacion') {
        const cotizacionSelect = document.getElementById('cotizacionSelect');
        if (cotizacionSelect.value) {
            cotizacionSelect.dispatchEvent(new Event('change'));
        }
    } else {
        actualizarMontoTotal();
    }
}

// Llamar esta funci√≥n cuando sea necesario
document.getElementById('valorServicio').addEventListener('input', forzarActualizacionMontos);
function formatCurrencyForPDF(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '$ 0';
    
    // ‚úÖ CORRECCI√ìN DEFINITIVA: Para PDF, mostrar valores COMPLETOS
    return '$ ' + new Intl.NumberFormat('es-CO').format(amount);
}


// DIAGN√ìSTICO URGENTE - ejecutar inmediatamente
function diagnosticoUrgente() {
    console.log("üö® DIAGN√ìSTICO URGENTE - FORMAT CURRENCY");
    
    // Probar la funci√≥n formatCurrency con diferentes valores
    const valoresPrueba = [150000, 200000, 80000, 680000, 50];
    
    valoresPrueba.forEach(valor => {
        const formateado = formatCurrency(valor);
        console.log(`üí∞ ${valor} ‚Üí ${formateado}`);
    });
    
    // Verificar qu√© funci√≥n se est√° ejecutando realmente
    console.log("üîç Funci√≥n formatCurrency actual:", formatCurrency.toString());
}

// Ejecutar inmediatamente despu√©s de cargar
diagnosticoUrgente();
// Funci√≥n para convertir valores con "K" a pesos colombianos
function convertirValorK(valor) {
    if (typeof valor === 'string') {
        // Caso 1: Valor con "K" (ej: "200,0 K")
        if (valor.includes('K')) {
            const numero = parseFloat(valor.replace('K', '').replace(',', '.').trim());
            return numero * 1000;
        }
        // Caso 2: Valor con formato de moneda (ej: "$ 200,0 K")
        if (valor.includes('$') && valor.includes('K')) {
            const numero = parseFloat(valor.replace('$', '').replace('K', '').replace(',', '.').trim());
            return numero * 1000;
        }
        // Caso 3: Valor num√©rico como string (ej: "200000")
        return parseFloat(valor) || 0;
    }
    return parseFloat(valor) || 0;
}
function formatDateForPDF(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        return 'Fecha inv√°lida';
    }
}

// ‚úÖ FUNCI√ìN DE PRUEBA PARA VERIFICAR EL PDF
function probarPDF() {
    console.log("üß™ Probando generaci√≥n de PDF...");
    
    // Crear datos de prueba
    const datosPrueba = {
        idFactura: "FAC_TEST",
        fechaEmision: new Date().toISOString(),
        estado: "PAGADA",
        tipoFactura: "Simple",
        dniCliente: "123456789",
        nombreCliente: "Cliente de Prueba",
        telefonoCliente: "3001234567",
        correoCliente: "cliente@test.com",
        detalleFactura: [
            {
                idProducto: "PROD001",
                nombreProducto: "Producto de Prueba Largo Nombre Para Ver Como Se Comporta",
                cantidad: 2,
                precioUnitario: 50000,
                subtotal: 100000
            },
            {
                idProducto: "PROD002", 
                nombreProducto: "Otro Producto",
                cantidad: 1,
                precioUnitario: 75000,
                subtotal: 75000
            }
        ],
        valorServicio: 50000,
        observaciones: "Esta es una factura de prueba para verificar el formato del PDF y asegurar que todas las columnas se alineen correctamente sin solapamientos."
    };
    
    console.log("üìã Datos de prueba:", datosPrueba);
    alert("Se han cargado datos de prueba. Ahora genera el PDF para ver el resultado.");
    
    // Simular que existe en allFacturas para la funci√≥n viewInvoice
    allFacturas.push(datosPrueba);
    
    return datosPrueba;
}

// Ejecutar en consola: probarPDF()
        async function sendInvoice(id) {
            if (!confirm('¬øEst√° seguro de enviar esta factura por correo electr√≥nico?')) return;
            alert('‚úÖ Factura enviada por correo electr√≥nico.');
        }

        // Funci√≥n helper para hacer requests autenticados
async function fetchAutenticado(url, options = {}) {
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        throw new Error('No hay token de autenticaci√≥n');
    }

    const config = {
        ...options,
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            ...options.headers
        }
    };

    const response = await fetch(url, config);
    
    if (response.status === 401) {
        localStorage.removeItem('jwtToken');
        throw new Error('Sesi√≥n expirada');
    }
    
    return response;
}
// Funci√≥n corregida para eliminar facturas
async function deleteInvoice(id) {
    if (!confirm('¬øEst√° seguro de eliminar esta factura?')) return;
    
    try {
        console.log(`üóëÔ∏è Intentando eliminar factura: ${id}`);
        
        const response = await fetchAutenticado(`${API_FACTURAS_URL}/${id}`, {
            method: 'DELETE'
        });

        console.log("üì• Respuesta de eliminaci√≥n:", response.status, response.statusText);

        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('No autorizado. Token inv√°lido o expirado.');
            } else if (response.status === 404) {
                throw new Error('Factura no encontrada.');
            } else if (response.status === 403) {
                throw new Error('No tiene permisos para eliminar esta factura.');
            } else {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
        }

        // Si la respuesta es exitosa (204 No Content o 200 OK)
        alert('‚úÖ Factura eliminada exitosamente.');
        await getAllFacturas(); // Recargar la lista
        
    } catch (error) {
        console.error("‚ùå Error al eliminar factura:", error);
        
        // Mostrar mensaje de error espec√≠fico
        if (error.message.includes('401') || error.message.includes('No autorizado') || error.message.includes('Sesi√≥n expirada')) {
            alert('‚ùå Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
            window.location.href = 'index.html';
        } else {
            alert(`‚ùå Error al eliminar factura:\n\n${error.message}`);
        }
    }
}
// Funci√≥n de diagn√≥stico para tokens (ejecutar en consola)
function diagnosticarToken() {
    const token = localStorage.getItem('jwtToken');
    console.log("üîç Diagn√≥stico de Token:");
    console.log("‚úÖ Token presente:", !!token);
    
    if (token) {
        try {
            const partes = token.split('.');
            console.log("‚úÖ Token tiene 3 partes:", partes.length === 3);
            
            const payload = JSON.parse(atob(partes[1]));
            const expira = new Date(payload.exp * 1000);
            const ahora = new Date();
            const minutosRestantes = Math.round((payload.exp * 1000 - ahora.getTime()) / 1000 / 60);
            
            console.log("üìÖ Token expira:", expira.toLocaleString());
            console.log("‚è∞ Tiempo restante:", minutosRestantes, "minutos");
            console.log("üîë Payload:", payload);
            
            if (minutosRestantes < 5) {
                console.warn("‚ö†Ô∏è Token pronto a expirar!");
            }
            
        } catch (e) {
            console.error("‚ùå Token inv√°lido:", e);
        }
    }
    
    return !!token;
}
// Funci√≥n para filtrar facturas - COLOCAR ANTES DE DOMContentLoaded
function filterInvoices() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const estadoFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;

    let filtered = allFacturas;

    if (searchTerm) {
        filtered = filtered.filter(f => 
            f.idFactura?.toLowerCase().includes(searchTerm) || 
            f.dniCliente?.toLowerCase().includes(searchTerm) ||
            f.cliente?.nombre?.toLowerCase().includes(searchTerm) ||
            f.montoTotal?.toString().includes(searchTerm)
        );
    }
    
    if (estadoFilter) {
        filtered = filtered.filter(f => {
            const estadoFactura = f.estado || '';
            return estadoFactura.toUpperCase() === estadoFilter.toUpperCase();
        });
    }
    
    if (dateFrom) {
        filtered = filtered.filter(f => {
            const fechaFactura = new Date(f.fechaEmision);
            return fechaFactura >= new Date(dateFrom);
        });
    }
    
    if (dateTo) {
        filtered = filtered.filter(f => {
            const fechaFactura = new Date(f.fechaEmision);
            return fechaFactura <= new Date(dateTo);
        });
    }

    console.log(`üîç Filtradas ${filtered.length} de ${allFacturas.length} facturas`);
    renderTable(filtered);
}
// Ejecutar en consola: diagnosticarToken()
// Inicializaci√≥n corregida
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Iniciando aplicaci√≥n de Facturas...");
    
    // Verificar token al cargar la p√°gina
    if (!verificarToken()) {
        alert('‚ùå Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        window.location.href = 'index.html';
        return;
    }

    // Cargar datos iniciales
    loadInitialData();

    // Asignar el evento submit al formulario
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', handleInvoiceFormSubmit);
        console.log("‚úÖ Evento submit asignado al formulario");
    } else {
        console.error("‚ùå No se encontr√≥ el formulario con ID 'invoiceForm'");
    }

    // Event Listeners adicionales
    const filterButton = document.getElementById('filterInvoicesButton');
    if (filterButton) {
        filterButton.addEventListener('click', filterInvoices);
        console.log("‚úÖ Evento click asignado al bot√≥n de filtro");
    }

    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            filterInvoices(); 
        });
        console.log("‚úÖ Evento submit asignado al formulario de filtro");
    }

    console.log("‚úÖ Aplicaci√≥n de Facturas inicializada correctamente");
});
    </script>
</body>
</html>